<script>
  // ...keep everything above as-is...

  /***********************
   * ‚úÖ Guided journal now includes:
   * - Choose a collection
   * - Select exactly 3 prompts OR "Surprise me"
   ***********************/
  async function renderGuidedStepper(){
    // Step 0 = prompt picker
    if (state.guidedStep === 0){
      const options = PROMPT_COLLECTIONS.map(c =>
        `<option value="${escapeHtml(c.id)}">${escapeHtml(c.title)}</option>`
      ).join("");

      await setViewHtml(`
        <p class="kicker">Guided journal</p>
        <h2 class="title">Choose your prompts.</h2>
        <p class="subtitle">Pick a collection, then choose <strong>three</strong> prompts for tonight.</p>

        <p class="kicker">Prompt collection</p>
        <select id="collectionSelect">
          ${options}
        </select>

        <div style="height:12px;"></div>

        <div class="fade" id="pickFade">
          <p class="kicker">Pick exactly three</p>

          <div class="pickRow" style="margin-bottom:10px;">
            <label style="width:100%;">
              <input type="checkbox" id="anchorOk" />
              <div>
                <div style="font-weight:600; margin-bottom:3px;">I already have a specific ‚Äúit‚Äù in mind</div>
                <div style="color:var(--muted); line-height:1.55;">
                  This unlocks deeper prompts that refer to ‚Äúit/this/that‚Äù.
                </div>
              </div>
            </label>
          </div>

          <div class="list" id="promptList"></div>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="startGuided" disabled>Start guided journal</button>
            <button class="btn" id="surprise">Surprise me</button>
            <button class="btn ghost" id="backHome">Back</button>
          </div>

          <p class="hint" id="pickHint">Selected: 0 / ${GUIDED_PICK_MAX}</p>
        </div>
      `);

      requestAnimationFrame(() => document.getElementById("pickFade")?.classList.add("show"));

      const sel = document.getElementById("collectionSelect");
      const list = document.getElementById("promptList");
      const hint = document.getElementById("pickHint");
      const startBtn = document.getElementById("startGuided");
      const anchorToggle = document.getElementById("anchorOk");

      let currentCol = null;
      let prompts = [];
      const chosen = new Set();

      function isAnchorAllowed(){
        return !!anchorToggle?.checked;
      }

      function sync(){
        const checks = [...list.querySelectorAll("input[type='checkbox'][data-i]")];
        chosen.clear();
        checks.forEach(ch => { if (ch.checked) chosen.add(Number(ch.dataset.i)); });

        // If anchor is off, remove any selected prompts that require anchor
        if (!isAnchorAllowed()){
          for (const i of [...chosen]){
            if (prompts[i]?.requiresAnchor){
              const box = checks.find(c => Number(c.dataset.i) === i);
              if (box) box.checked = false;
              chosen.delete(i);
              toast("That prompt needs context. Toggle ‚ÄúI already have a specific ‚Äòit‚Äô in mind‚Äù to use it.");
            }
          }
        }

        // Enforce max
        if (chosen.size > GUIDED_PICK_MAX){
          const last = checks.findLast
            ? checks.findLast(c => c.checked)
            : checks.slice().reverse().find(c => c.checked);
          if (last) last.checked = false;

          chosen.clear();
          checks.forEach(ch => { if (ch.checked) chosen.add(Number(ch.dataset.i)); });
        }

        const count = chosen.size;
        hint.textContent = `Selected: ${count} / ${GUIDED_PICK_MAX}`;
        startBtn.disabled = (count !== GUIDED_PICK_MAX);

        // Disable unchecked boxes if at max
        const atMax = (count === GUIDED_PICK_MAX);
        checks.forEach(ch => {
          if (!ch.checked) ch.disabled = atMax;
          else ch.disabled = false;
        });

        // Disable anchor-required prompts if anchor toggle is off (unless already checked)
        checks.forEach(ch => {
          const i = Number(ch.dataset.i);
          const needs = !!prompts[i]?.requiresAnchor;
          if (needs && !isAnchorAllowed() && !ch.checked) ch.disabled = true;
        });
      }

      function renderPromptsForCollection(id){
        currentCol = PROMPT_COLLECTIONS.find(c => c.id === id) || PROMPT_COLLECTIONS[0];
        list.innerHTML = "";
        chosen.clear();

        // Normalize prompts: support string OR {text, requiresAnchor}
        prompts = (currentCol.prompts || []).map(p => {
          if (typeof p === "string") return { text: p, requiresAnchor: false };
          return { text: String(p.text ?? ""), requiresAnchor: !!p.requiresAnchor };
        });

        prompts.forEach((p, idx) => {
          const needs = p.requiresAnchor === true;

          const row = document.createElement("div");
          row.className = "pickRow";
          row.innerHTML = `
            <label>
              <input type="checkbox" data-i="${idx}" />
              <div>
                <div style="font-weight:600; margin-bottom:3px; display:flex; gap:8px; align-items:center;">
                  <span>Prompt ${idx + 1}</span>
                  ${needs ? `<span style="font-size:12px; color:var(--muted2); border:var(--line); padding:2px 8px; border-radius:999px;">needs context</span>` : ``}
                </div>
                <div style="color:var(--muted); line-height:1.55;">${escapeHtml(p.text)}</div>
              </div>
            </label>
          `;
          list.appendChild(row);
        });

        list.querySelectorAll("input[type='checkbox'][data-i]").forEach(ch => {
          ch.addEventListener("change", sync);
        });

        sync();
      }

      // Buttons
      document.getElementById("backHome").onclick = () => go("home");

      document.getElementById("startGuided").onclick = () => {
        if (!currentCol) return;
        const picked = [...chosen].map(i => prompts[i].text);

        state.guidedSetId = currentCol.id;
        state.guidedSetTitle = currentCol.title;
        state.guidedQs = picked.slice(0, 3);

        state.guidedStep = 1;
        state.guidedA1 = "";
        state.guidedA2 = "";
        state.guidedA3 = "";
        state.guidedMood = null;

        go("guided");
      };

      document.getElementById("surprise").onclick = () => {
        if (!currentCol) return;

        const safe = prompts.filter(p => !p.requiresAnchor).map(p => p.text);
        const pool = (safe.length >= 3) ? safe : prompts.map(p => p.text);
        const shuffled = [...pool].sort(() => Math.random() - 0.5);

        state.guidedSetId = currentCol.id;
        state.guidedSetTitle = currentCol.title;
        state.guidedQs = shuffled.slice(0, 3);

        state.guidedStep = 1;
        state.guidedA1 = "";
        state.guidedA2 = "";
        state.guidedA3 = "";
        state.guidedMood = null;

        go("guided");
      };

      anchorToggle?.addEventListener("change", sync);

      // initial
      renderPromptsForCollection(sel.value);
      sel.addEventListener("change", () => renderPromptsForCollection(sel.value));

      return;
    }

    // ---- Steps 1..3 (unchanged logic) ----
    const step = state.guidedStep;

    const intro = `
      <p class="kicker">Guided journal</p>
      <h2 class="title">Welcome to your guided journal.</h2>
      <p class="subtitle">
        This is a space where we can explore what‚Äôs important to you, notice how you‚Äôre feeling, and gently reflect together.
      </p>
    `;

    const setLabel = state.guidedSetTitle
      ? `<p class="small" style="margin:-6px 0 14px;">Collection: ${escapeHtml(state.guidedSetTitle)}</p>`
      : "";

    const stepbar = `
      <div class="stepbar">
        <div class="steps" aria-label="steps">
          <div class="dot ${step>=1?'on':''}"></div>
          <div class="dot ${step>=2?'on':''}"></div>
          <div class="dot ${step>=3?'on':''}"></div>
        </div>
        <div class="steptext">Step ${Math.min(step,3)} of 3</div>
      </div>
    `;

    const [q1, q2, q3] = state.guidedQs.length ? state.guidedQs : pickGuidedSet().questions;

    if (step === 1){
      await setViewHtml(`
        ${intro}
        ${setLabel}
        ${stepbar}

        <div class="fade" id="qfade">
          <p class="subtitle" style="margin-bottom:10px;"><strong>${escapeHtml(q1)}</strong></p>
          <textarea id="a1" rows="10" placeholder="Write what comes...">${escapeHtml(state.guidedA1 || "")}</textarea>
        </div>

        <div class="row" style="margin-top:14px;">
          <button class="btn primary" id="next">Next</button>
          <button class="btn" id="changePrompts">Change prompts</button>
          <button class="btn ghost" id="back">Home</button>
        </div>
      `);
      requestAnimationFrame(() => document.getElementById("qfade")?.classList.add("show"));

      const a1 = document.getElementById("a1");
      a1.addEventListener("input", () => state.guidedA1 = a1.value);

      document.getElementById("next").addEventListener("click", () => { state.guidedStep = 2; go("guided"); });
      document.getElementById("back").addEventListener("click", () => go("home"));
      document.getElementById("changePrompts").addEventListener("click", () => {
        state.guidedStep = 0;
        state.guidedQs = [];
        go("guided");
      });
      return;
    }

    if (step === 2){
      await setViewHtml(`
        ${intro}
        ${setLabel}
        ${stepbar}

        <div class="fade" id="qfade">
          <p class="subtitle" style="margin-bottom:10px;"><strong>${escapeHtml(q2)}</strong></p>
          <textarea id="a2" rows="10" placeholder="Take your time...">${escapeHtml(state.guidedA2 || "")}</textarea>
        </div>

        <div class="row" style="margin-top:14px;">
          <button class="btn primary" id="next">Next</button>
          <button class="btn" id="prev">Previous</button>
          <button class="btn" id="changePrompts">Change prompts</button>
          <button class="btn ghost" id="home">Home</button>
        </div>
      `);
      requestAnimationFrame(() => document.getElementById("qfade")?.classList.add("show"));

      const a2 = document.getElementById("a2");
      a2.addEventListener("input", () => state.guidedA2 = a2.value);

      document.getElementById("next").addEventListener("click", () => { state.guidedStep = 3; go("guided"); });
      document.getElementById("prev").addEventListener("click", () => { state.guidedStep = 1; go("guided"); });
      document.getElementById("home").addEventListener("click", () => go("home"));
      document.getElementById("changePrompts").addEventListener("click", () => {
        state.guidedStep = 0;
        state.guidedQs = [];
        go("guided");
      });
      return;
    }

    if (step === 3){
      await setViewHtml(`
        ${intro}
        ${setLabel}
        ${stepbar}

        <div class="fade" id="qfade">
          <p class="subtitle" style="margin-bottom:10px;"><strong>${escapeHtml(q3)}</strong></p>
          <textarea id="a3" rows="10" placeholder="Anything you notice is enough...">${escapeHtml(state.guidedA3 || "")}</textarea>
        </div>

        <div class="divider"></div>

        <div class="fade" id="mfade">
          <p class="kicker" style="margin-bottom:6px;">How are you feeling right now?</p>
          <div class="row" id="moods"></div>
        </div>

        <div class="row" style="margin-top:14px;">
          <button class="btn primary" id="finish">Finish</button>
          <button class="btn" id="prev">Previous</button>
          <button class="btn" id="changePrompts">Change prompts</button>
          <button class="btn ghost" id="home">Home</button>
        </div>
      `);

      requestAnimationFrame(() => {
        document.getElementById("qfade")?.classList.add("show");
        document.getElementById("mfade")?.classList.add("show");
      });

      const a3 = document.getElementById("a3");
      a3.addEventListener("input", () => state.guidedA3 = a3.value);

      const moods = ["üôÇ Okay","üåø Calm","ü´ß Numb","üåßÔ∏è Heavy","üíõ Tender","üî• Restless","‚ú® Hopeful","üò¥ Tired"];
      const moodsEl = document.getElementById("moods");

      moods.forEach(m => {
        const b = document.createElement("button");
        b.className = "btn" + (state.guidedMood === m ? " primary" : "");
        b.type = "button";
        b.textContent = m;
        b.style.borderRadius = "999px";
        b.style.padding = "10px 12px";
        b.addEventListener("click", () => {
          state.guidedMood = m;
          [...moodsEl.children].forEach(ch => ch.classList.remove("primary"));
          b.classList.add("primary");
        });
        moodsEl.appendChild(b);
      });

      document.getElementById("prev").addEventListener("click", () => { state.guidedStep = 2; go("guided"); });
      document.getElementById("home").addEventListener("click", () => go("home"));
      document.getElementById("changePrompts").addEventListener("click", () => {
        state.guidedStep = 0;
        state.guidedQs = [];
        go("guided");
      });

      document.getElementById("finish").addEventListener("click", async () => {
        const A1 = (state.guidedA1 || "").trim();
        const A2 = (state.guidedA2 || "").trim();
        const A3 = (state.guidedA3 || "").trim();

        const any = A1.length || A2.length || A3.length;
        if (any){
          addEntry({
            id: crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2),
            createdAt: nowIso(),
            type: "Guided journal",
            mood: state.guidedMood,
            content:
`Collection: ${state.guidedSetTitle || "‚Äî"}

1) ${q1}
${A1}

2) ${q2}
${A2}

3) ${q3}
${A3}`.trim()
          });
          toast("Saved.");
        } else {
          toast("Nothing to save ‚Äî that‚Äôs okay.");
        }

        state.guidedStep = 0;
        state.guidedSetId = null;
        state.guidedSetTitle = "";
        state.guidedQs = [];
        state.guidedA1 = "";
        state.guidedA2 = "";
        state.guidedA3 = "";
        state.guidedMood = null;

        await go("completeGuided");
      });

      return;
    }

    state.guidedStep = 0;
    return go("guided");
  }

  
    async function renderCompleteGuided(){
      await setViewHtml(`
        <h2 class="title">You did really meaningful work today.</h2>
        <p class="subtitle">Would you like to wind down with an unwinding meditation or do some free writing?</p>

        <div class="row">
          <button class="btn primary" id="toMed">Unwinding meditation</button>
          <button class="btn" id="toFree">Free writing</button>
          <button class="btn ghost" id="done">I‚Äôm done for now</button>
        </div>
      `);

      document.getElementById("toMed").addEventListener("click", () => go("medList"));
      document.getElementById("toFree").addEventListener("click", () => go("free"));
      document.getElementById("done").addEventListener("click", () => go("done"));
    }

    /***********************
     * ‚úÖ Meditations list + detail now from JSON
     ***********************/
    async function renderMeditationList(){
      const cards = MEDITATIONS_INDEX.map(m => `
        <div class="option" data-med="${escapeHtml(m.id)}">
          <h3>${escapeHtml(m.title)}</h3>
          <p>${escapeHtml(m.intro || "A calm meditation to read at your own pace.")}</p>
        </div>
      `).join("");

      await setViewHtml(`
        <p class="kicker">Unwinding meditation</p>
        <h2 class="title">Welcome.</h2>
        <p class="subtitle">
          You can choose a meditation that feels right for you right now.
          There‚Äôs no wrong choice ‚Äî just follow what you need.
        </p>

        <div class="option-grid">
          ${cards}
        </div>

        <div class="divider"></div>
        <div class="row">
          <button class="btn ghost" id="back">Back</button>
        </div>
      `);

      viewEl.querySelectorAll(".option").forEach(el => {
        el.addEventListener("click", () => go("meditation", { meditationId: el.dataset.med }));
      });
      document.getElementById("back").addEventListener("click", () => go("home"));
    }

    async function renderMeditation(medId){
      try{
        const med = await loadMeditationById(medId);

        const audioBlock = med.audioSrc ? `
          <div class="audio-player">
            <div class="label">${escapeHtml(med.title)}</div>
            <button class="btn" id="toggleMedAudio">Play</button>
          </div>
        ` : "";

        await setViewHtml(`
          <p class="kicker">Meditation</p>
          <h2 class="title">${escapeHtml(med.title)}</h2>
          <p class="subtitle">${escapeHtml(med.intro || "Take your time reading. Move at your own pace.")}</p>

          <div class="fade" id="medfade">
            ${audioBlock}
            <div class="med-box">${escapeHtml(med.body || "")}</div>
          </div>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="finished">I‚Äôm finished</button>
            <button class="btn" id="choose">Choose another</button>
            <button class="btn ghost" id="quit">I‚Äôm done for now</button>
          </div>
        `);

        requestAnimationFrame(() => document.getElementById("medfade").classList.add("show"));

        if (med.audioSrc){
          const btn = document.getElementById("toggleMedAudio");
          btn.addEventListener("click", () => toggleMeditationAudio(med.audioSrc, btn));
          medPlayer.onended = () => { btn.textContent = "Play"; };
        } else {
          medPlayer.onended = null;
        }

        document.getElementById("finished").addEventListener("click", () => go("completeMeditation"));
        document.getElementById("choose").addEventListener("click", () => go("medList"));
        document.getElementById("quit").addEventListener("click", () => go("done"));
      }catch(err){
        await setViewHtml(`
          <p class="kicker">Meditation</p>
          <h2 class="title">Couldn‚Äôt load meditation</h2>
          <p class="subtitle">${escapeHtml(err?.message || "Unknown error")}</p>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="backList">Back to list</button>
            <button class="btn ghost" id="home">Home</button>
          </div>
        `);

        document.getElementById("backList").addEventListener("click", () => go("medList"));
        document.getElementById("home").addEventListener("click", () => go("home"));
      }
    }

    async function renderCompleteMeditation(){
      await setViewHtml(`
        <h2 class="title">Thanks for taking this time for yourself.</h2>
        <p class="subtitle">What would you like to do next?</p>

        <div class="row">
          <button class="btn primary" id="toFree">Free writing</button>
          <button class="btn" id="toGuided">Guided journal</button>
          <button class="btn ghost" id="done">I‚Äôm done for now</button>
        </div>
      `);

      document.getElementById("toFree").addEventListener("click", () => go("free"));
      document.getElementById("toGuided").addEventListener("click", () => {
        state.guidedStep = 0;
        state.guidedQs = [];
        go("guided");
      });
      document.getElementById("done").addEventListener("click", () => go("done"));
    }

    /***********************
     * ‚úÖ Poetry Corner (from JSON)
     ***********************/
    async function renderPoetryHome(){
      await setViewHtml(`
        <p class="kicker">Poetry Corner</p>
        <h2 class="title">A small place to soften.</h2>
        <p class="subtitle">Choose a collection. Read slowly. Take what you need.</p>

        <div class="list" id="poetryCollections">
          <div class="entry">
            <div class="meta"><span>Loading‚Ä¶</span><span></span></div>
            <p class="preview">Fetching poems‚Ä¶</p>
          </div>
        </div>

        <div class="divider"></div>
        <div class="row">
          <button class="btn primary" id="backHome">Home</button>
        </div>
      `);

      document.getElementById("backHome").addEventListener("click", () => go("home"));

      const listEl = document.getElementById("poetryCollections");

      try{
        const { collections } = await loadPoetryIndex();

        if (!collections.length){
          listEl.innerHTML = `
            <div class="entry">
              <div class="meta"><span>No collections found</span><span></span></div>
              <p class="preview">Your poems JSON loaded, but it didn‚Äôt contain any collections.</p>
            </div>
          `;
          return;
        }

        listEl.innerHTML = "";
        collections.forEach(c => {
          const div = document.createElement("div");
          div.className = "entry";
          div.style.cursor = "pointer";
          div.innerHTML = `
            <div class="meta">
              <span>${escapeHtml(c.title)}</span>
              <span>${escapeHtml(String(c.poems?.length || 0))} poems</span>
            </div>
            <p class="preview">${escapeHtml((c.poems?.[0]?.title ? ("Includes: " + c.poems[0].title) : "A gentle collection."))}</p>
          `;
          div.addEventListener("click", () => go("poetryCollection", { collectionId: c.id }));
          listEl.appendChild(div);
        });
      }catch(err){
        listEl.innerHTML = `
          <div class="entry">
            <div class="meta"><span>Couldn‚Äôt load poems</span><span></span></div>
            <p class="preview">${escapeHtml(err?.message || "Unknown error")}</p>
          </div>
        `;
      }
    }

    async function renderPoetryCollection(collectionId){
      await setViewHtml(`
        <p class="kicker">Poetry Corner</p>
        <h2 class="title">Loading‚Ä¶</h2>
        <p class="subtitle">Just a moment.</p>

        <div class="divider"></div>
        <div class="row">
          <button class="btn primary" id="backPoetry">Back</button>
          <button class="btn ghost" id="home">Home</button>
        </div>
      `, { fade: true });

      try{
        const { collections } = await loadPoetryIndex();
        const col = collections.find(c => c.id === collectionId) || collections[0];

        const poemsHtml = (col.poems || []).map(p => `
          <div class="entry">
            <div class="meta">
              <span>${escapeHtml(p.title || "Untitled")}</span>
              <span></span>
            </div>
            <p class="preview">${escapeHtml(p.text || "")}</p>
          </div>
        `).join("");

        await setViewHtml(`
          <p class="kicker">Poetry Corner</p>
          <h2 class="title">${escapeHtml(col.title)}</h2>
          <p class="subtitle">Read slowly. Pause whenever you want.</p>

          <div class="list">
            ${poemsHtml || `
              <div class="entry">
                <div class="meta"><span>No poems</span><span></span></div>
                <p class="preview">This collection doesn‚Äôt contain any poems yet.</p>
              </div>
            `}
          </div>

          <div class="divider"></div>
          <div class="row">
            <button class="btn primary" id="backPoetry">Back to collections</button>
            <button class="btn ghost" id="home">Home</button>
          </div>
        `);

        document.getElementById("backPoetry").addEventListener("click", () => go("poetry"));
        document.getElementById("home").addEventListener("click", () => go("home"));
      }catch(err){
        await setViewHtml(`
          <p class="kicker">Poetry Corner</p>
          <h2 class="title">Couldn‚Äôt load collection</h2>
          <p class="subtitle">${escapeHtml(err?.message || "Unknown error")}</p>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="backPoetry">Back</button>
            <button class="btn ghost" id="home">Home</button>
          </div>
        `);

        document.getElementById("backPoetry").addEventListener("click", () => go("poetry"));
        document.getElementById("home").addEventListener("click", () => go("home"));
      }
    }

    async function renderDone(){
      const entries = loadEntries();
      const email = loadEmail();
      const defaultId = state.lastSavedEntryId || (entries[0]?.id || "");

      const options = entries.slice(0, 30).map(e => {
        const label = `${e.type} ‚Äî ${prettyDate(e.createdAt)}${e.mood ? " ‚Ä¢ " + e.mood : ""}`;
        const selected = e.id === defaultId ? "selected" : "";
        return `<option value="${escapeHtml(e.id)}" ${selected}>${escapeHtml(label)}</option>`;
      }).join("");

      await setViewHtml(`
        <h2 class="title">You can rest now, if you want.</h2>
        <p class="subtitle">If you‚Äôd like, you can email yourself a saved entry.</p>

        <div class="fade" id="donefade">
          <p class="kicker">Your email address</p>
          <input type="email" id="email" placeholder="name@example.com" value="${escapeHtml(email)}" />

          <div style="height:12px;"></div>

          <p class="kicker">Choose an entry</p>
          <select id="entrySelect">
            ${options || `<option value="">No saved entries yet</option>`}
          </select>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="sendEmail">Compose email</button>
            <button class="btn" id="goHome">Home</button>
            <button class="btn ghost" id="goJournal">My Journal</button>
          </div>

          <p class="hint">This opens your email app with the entry filled in. You can review it, then press Send.</p>
        </div>
      `);

      requestAnimationFrame(() => document.getElementById("donefade").classList.add("show"));

      document.getElementById("goHome").addEventListener("click", () => go("home"));
      document.getElementById("goJournal").addEventListener("click", () => go("journal"));

      document.getElementById("sendEmail").addEventListener("click", () => {
        const emailEl = document.getElementById("email");
        const entryId = document.getElementById("entrySelect").value;

        const to = (emailEl.value || "").trim();
        if (!to){
          toast("Add an email address first.");
          emailEl.focus();
          return;
        }
        saveEmail(to);

        if (!entryId){
          toast("No entry selected.");
          return;
        }

        const e = getEntryById(entryId);
        if (!e){
          toast("Couldn‚Äôt find that entry.");
          return;
        }

        const subject = `Journal Boo ‚Äî ${e.type} (${new Date(e.createdAt).toLocaleDateString()})`;
        const body =
`Hi,

Here‚Äôs a saved entry from Journal Boo.

${e.type}${e.mood ? " ‚Ä¢ " + e.mood : ""}
${prettyDate(e.createdAt)}

--------------------

${e.content}

--------------------

¬© James Ritchie 2025`;

        composeEmail(to, subject, body);
      });
    }

    async function renderJournal(){
      const entries = loadEntries();

      await setViewHtml(`
        <p class="kicker">My Journal</p>
        <h2 class="title">Your saved writing</h2>
        <p class="subtitle">Everything here is stored locally in this browser.</p>

        <div class="row">
          <button class="btn primary" id="newFree">New free writing</button>
          <button class="btn" id="newGuided">New guided journal</button>
          <button class="btn" id="toDone">I‚Äôm done for now</button>
          <button class="btn danger" id="clearAll">Clear all (local)</button>
        </div>

        <div class="divider"></div>
        <div class="list" id="entryList"></div>
      `);

      document.getElementById("newFree").addEventListener("click", () => go("free"));
      document.getElementById("newGuided").addEventListener("click", () => {
        state.guidedStep = 0;
        state.guidedQs = [];
        go("guided");
      });
      document.getElementById("toDone").addEventListener("click", () => go("done"));

      document.getElementById("clearAll").addEventListener("click", () => {
        const ok = confirm("Clear all saved entries from this browser?");
        if (!ok) return;
        saveEntries([]);
        toast("Cleared.");
        renderJournal();
      });

      const list = document.getElementById("entryList");
      if (!entries.length){
        list.innerHTML = `
          <div class="entry">
            <div class="meta"><span>Nothing saved yet</span><span></span></div>
            <p class="preview">When you finish a writing session, it will appear here.</p>
          </div>
        `;
        return;
      }

      entries.forEach(e => {
        const div = document.createElement("div");
        div.className = "entry";
        const mood = e.mood ? ` ‚Ä¢ ${e.mood}` : "";
        div.innerHTML = `
          <div class="meta">
            <span>${escapeHtml(e.type)}${mood}</span>
            <span>${prettyDate(e.createdAt)}</span>
          </div>
          <p class="preview">${escapeHtml(preview(e.content, 420))}</p>
          <div class="row" style="margin-top:10px;">
            <button class="btn" data-open="${escapeHtml(e.id)}">Open</button>
            <button class="btn danger" data-del="${escapeHtml(e.id)}">Delete</button>
          </div>
        `;
        list.appendChild(div);
      });

      list.querySelectorAll("button[data-open]").forEach(btn => {
        btn.addEventListener("click", () => openEntry(btn.getAttribute("data-open")));
      });
      list.querySelectorAll("button[data-del]").forEach(btn => {
        btn.addEventListener("click", () => deleteEntry(btn.getAttribute("data-del")));
      });

      function preview(txt, max){
        const s = (txt || "").trim();
        if (s.length <= max) return s;
        return s.slice(0, max).trim() + "‚Ä¶";
      }

      async function openEntry(id){
        const entries = loadEntries();
        const e = entries.find(x => x.id === id);
        if (!e) return;

        await setViewHtml(`
          <p class="kicker">My Journal</p>
          <h2 class="title">${escapeHtml(e.type)}</h2>
          <p class="subtitle">${prettyDate(e.createdAt)}${e.mood ? " ‚Ä¢ " + escapeHtml(e.mood) : ""}</p>

          <div class="med-box">${escapeHtml(e.content)}</div>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="backList">Back</button>
            <button class="btn" id="emailThis">Email this</button>
            <button class="btn danger" id="delThis">Delete</button>
            <button class="btn ghost" id="home">Home</button>
          </div>
        `);

        document.getElementById("backList").addEventListener("click", () => go("journal"));
        document.getElementById("home").addEventListener("click", () => go("home"));

        document.getElementById("delThis").addEventListener("click", () => deleteEntry(id));

        document.getElementById("emailThis").addEventListener("click", () => {
          state.lastSavedEntryId = e.id;
          go("done");
        });
      }

      function deleteEntry(id){
        const ok = confirm("Delete this entry?");
        if (!ok) return;
        const entries = loadEntries().filter(e => e.id !== id);
        saveEntries(entries);
        toast("Deleted.");
        go("journal");
      }
    }

    (function init(){
      loadSettings();

      // ‚úÖ Theme: racing-green default, but saved preference still wins
      loadTheme();
      applyTheme();

      syncMusicUI();

      state.musicOn = false;
      bgm.pause();

      bgm.src = getTrack(state.trackId).src;
      bgm.volume = 0;

      viewEl.classList.remove("show");

      // ‚úÖ Pre-render home (app is hidden until Start)
      go("home").then(() => {});

      // ‚úÖ Run landing fades
      runWelcomeAnimation();
    })();
  </script>
</body>
</html>
