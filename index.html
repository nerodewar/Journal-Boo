<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Journal Boo</title>

  <!-- âœ… Adds a "js" class to <html> so we can animate only when JS is running -->
  <script>
    document.documentElement.classList.add("js");
  </script>

  <style>
    :root{
      /* Default vars (will be overridden by body[data-theme]) */
      --bg: #202020;
      --text: #171615;
      --muted: #4b4a46;
      --muted2:#6a6862;
      --accent:#8a6a2b;

      /* refined surface system */
      --surface: rgba(255,255,255,.62);
      --surface2: rgba(255,255,255,.40);
      --input-bg: rgba(255,255,255,.70);
      --toast-bg: rgba(255,255,255,.76);
      --focus: rgba(138,106,43,.26);

      /* hero overlay (-aware) */
      --hero-overlay-top: rgba(0,0,0,.22);
      --hero-overlay-bot: rgba(0,0,0,.56);

      --radius: 20px;
      --line: 0px solid rgba(0,0,0,.10);
      --shadow: 0 14px 38px rgba(0,0,0,.10);

      /* split typography */
      --font-display: ui-serif, Georgia, "Times New Roman", Times, serif;
      --font-ui: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    /* âœ… Theme palettes */
    body[data-theme="charcoal"]{
      --bg: #202020;
      --text: #f1efe9;
      --muted: #b9b6ad;
      --muted2:#8f8b81;
      --accent:#c9a76a;
      --line: 1px solid rgba(255,255,255,.07);
      --shadow: 0 7px 24px rgba(0,0,0,.35);

      /* slightly darker + more consistent surfaces */
      --surface: rgba(255,255,255,.055);
      --surface2: rgba(255,255,255,.032);
      --input-bg: rgba(255,255,255,.045);
      --toast-bg: rgba(0,0,0,.55);
      --focus: rgba(201,167,106,.22);

      --hero-overlay-top: rgba(0,0,0,.30);
      --hero-overlay-bot: rgba(0,0,0,.62);
    }

    body[data-theme="light"]{
      --bg: #f7f5ef;
      --text: #171615;
      --muted: #4b4a46;
      --muted2:#6a6862;
      --accent:#8a6a2b;
      --line: 1px solid rgba(0,0,0,.10);
      --shadow: 0 14px 38px rgba(0,0,0,.10);

      --surface: rgba(255,255,255,.70);
      --surface2: rgba(255,255,255,.50);
      --input-bg: rgba(255,255,255,.78);
      --toast-bg: rgba(255,255,255,.78);
      --focus: rgba(138,106,43,.22);

      --hero-overlay-top: rgba(255,255,255,.18);
      --hero-overlay-bot: rgba(255,255,255,.55);
    }

    /* âœ… Brighter green */
    body[data-theme="racing-green"]{
      --bg: #07130e;
      --text: #f3f1ea;
      --muted: #c2d2c8;
      --muted2:#9bb3a8;
      --accent:#31c981;
      --line: 1px solid rgba(255,255,255,.09);
      --shadow: 0 14px 38px rgba(0,0,0,.38);

      --surface: rgba(255,255,255,.06);
      --surface2: rgba(255,255,255,.04);
      --input-bg: rgba(255,255,255,.05);
      --toast-bg: rgba(0,0,0,.55);
      --focus: rgba(49,201,129,.22);

      --hero-overlay-top: rgba(0,0,0,.28);
      --hero-overlay-bot: rgba(0,0,0,.62);
    }

    /* âœ… Lighter rose pink */
    body[data-theme="rose-pink"]{
      --bg: #1b0f15;
      --text: #fbf3f6;
      --muted: #e2c5d0;
      --muted2:#caa0af;
      --accent:#ff97ba;
      --line: 1px solid rgba(255,255,255,.10);
      --shadow: 0 14px 38px rgba(0,0,0,.40);

      --surface: rgba(255,255,255,.065);
      --surface2: rgba(255,255,255,.045);
      --input-bg: rgba(255,255,255,.055);
      --toast-bg: rgba(0,0,0,.55);
      --focus: rgba(255,151,186,.20);

      --hero-overlay-top: rgba(0,0,0,.30);
      --hero-overlay-bot: rgba(0,0,0,.64);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body{
      margin: 0;
      font-family: var(--font-ui);
      background:
        radial-gradient(1100px 800px at 18% 0%, rgba(201,167,106,.10), transparent 58%),
        radial-gradient(900px 600px at 88% 12%, rgba(201,167,106,.07), transparent 60%),
        var(--bg);
      color: var(--text);
      letter-spacing: .1px;
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* headings use display font for warmth */
    h1,h2,h3,.title,.home-question,.jbWelcomeTitle{
      font-family: var(--font-display);
    }
    .subtitle,.kicker,.hint,.small,.brand p,.hero-sub,.entry .preview{
      font-family: var(--font-ui);
    }

    /* âœ… Landing / Welcome screen */
    .jbScreen{
      position: fixed;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 24px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 520ms ease;
      background:
        radial-gradient(1100px 800px at 18% 0%, rgba(201,167,106,.10), transparent 58%),
        radial-gradient(900px 600px at 88% 12%, rgba(201,167,106,.07), transparent 60%),
        var(--bg);
      z-index: 9999;
    }
    .jbScreen.active{
      opacity: 1;
      pointer-events: auto;
    }

    .jbCenter{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 12px;
      text-align:center;
      max-width: 820px;
    }

    .jbWelcomeTitle{
      font-size: clamp(22px, 4vw, 34px);
      font-weight: 650;
      letter-spacing:.2px;
      color: var(--text);
      margin: 0;
    }
    .jbWelcomeSub{
      margin: 0;
      color: var(--muted);
      font-size: 16px;
      line-height: 1.55;
    }
    .jbStartBtn{
      border: var(--line);
      background: var(--surface2);
      padding: 16px 20px;
      border-radius: 999px;
      font-size: 14px;
      color: var(--text);
      cursor:pointer;
      user-select:none;
      transition: background .12s ease, transform .12s ease, border-color .12s ease, box-shadow .12s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .jbStartBtn:hover{ background: var(--surface); transform: translateY(-1px); }
    .jbStartBtn:focus-visible{
      outline: none;
      box-shadow: 0 0 0 3px var(--focus), var(--shadow);
      border-color: rgba(255,255,255,.18);
    }

    /* âœ… Only animate when JS is active */
    html.js .jbWelcomeTitle,
    html.js .jbWelcomeSub,
    html.js .jbStartBtn{
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 700ms ease, transform 700ms ease;
    }
    html.js .jbWelcomeTitle.show,
    html.js .jbWelcomeSub.show,
    html.js .jbStartBtn.show{
      opacity: 1;
      transform: translateY(0);
    }

    /* âœ… Hide main app until started */
    #jbApp.hidden{ display:none; }

    .app{
      min-height: 100%;
      display:flex;
      justify-content:center;
      padding: 28px 14px 40px;
      position: relative;
    }

    .shell{
      width: min(820px, 100%);
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 8px 4px;
      gap: 10px;
    }

    .brand{ display:flex; flex-direction:column; gap: 2px; }
    .brand h1{ margin:0; font-size:22px; font-weight:650; letter-spacing:.2px; }
    .brand p{ margin:0; color:var(--muted2); font-size:13px; line-height:1.35; }

    .top-actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .pill{
      border: var(--line);
      background: var(--surface2);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      color: var(--text);
      display:inline-flex;
      align-items:center;
      gap: 8px;
      cursor:pointer;
      user-select:none;
      transition: background .12s ease, transform .12s ease, border-color .12s ease, box-shadow .12s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .pill:hover{ background: var(--surface); transform: translateY(-1px); }
    .pill:focus-visible{
      outline: none;
      box-shadow: 0 0 0 4px var(--focus), var(--shadow);
      border-color: rgba(255,255,255,.18);
    }

    /* âœ… Pill-style dropdown */
    .pill-select{
      border: var(--line);
      background: var(--surface2);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      color: var(--text);
      display:inline-flex;
      align-items:center;
      gap: 8px;
      transition: background .12s ease, transform .12s ease, border-color .12s ease, box-shadow .12s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .pill-select:hover{ background: var(--surface); transform: translateY(-1px); }
    .pill-select:focus-within{
      box-shadow: 0 0 0 3px var(--focus), var(--shadow);
      border-color: rgba(255,255,255,.18);
    }
    .pill-select label{
      color: var(--text);
      font-size: 13px;
      user-select:none;
      white-space: nowrap;
    }
    .pill-select select{
      width: auto;
      padding: 0;
      margin: 0;
      border: 0;
      outline: none;
      background: transparent;
      color: var(--text);
      font-family: var(--font-ui);
      font-size: 13px;
      line-height: 1;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }
    .pill-select .chev{
      width: 0; height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-top: 6px solid currentColor;
      opacity: .55;
      margin-left: 2px;
      transform: translateY(1px);
    }
    .pill-select select option{
      background: var(--bg);
      color: var(--text);
    }

    .card{
      background: linear-gradient(180deg, var(--surface), var(--surface2));
      border: var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .card-inner{ padding: 22px; }

    .title{
      font-size: 24px;
      margin: 0 0 10px;
      font-weight: 650;
      letter-spacing: .15px;
    }
    .subtitle{
      margin: 0 0 18px;
      color: var(--muted);
      line-height: 1.6;
      font-size: 16px;
    }

    .option-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 8px;
    }
    .option{
      border: var(--line);
      background: var(--surface2);
      border-radius: 18px;
      padding: 16px 16px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .option:hover{ background: var(--surface); transform: translateY(-1px); }
    .option:focus-visible{
      outline: none;
      box-shadow: 0 0 0 1px var(--focus), var(--shadow);
      border-color: rgba(255,255,255,.18);
    }
    .option h3{ margin: 0; font-size: 18px; font-weight: 650; font-family: var(--font-display); }
    .option p{ margin: 6px 0 0; color: var(--muted); font-size: 14px; line-height: 1.5; }

    .row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }

    .btn{
      border: var(--line);
      background: var(--surface2);
      padding: 12px 14px;
      border-radius: 14px;
      font-size: 14px;
      cursor:pointer;
      color: var(--text);
      user-select:none;
      transition: background .12s ease, transform .12s ease, border-color .12s ease, box-shadow .12s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      font-family: var(--font-ui);
    }
    .btn:hover{ background: var(--surface); transform: translateY(-1px); }
    .btn:focus-visible{
      outline: none;
      box-shadow: 0 0 0 1px var(--focus), var(--shadow);
      border-color: rgba(255,255,255,.18);
    }
    .btn.primary{
      background: color-mix(in srgb, var(--accent) 18%, transparent);
      border: 1px solid color-mix(in srgb, var(--accent) 38%, transparent);
    }
    .btn.primary:hover{
      background: color-mix(in srgb, var(--accent) 24%, transparent);
    }
    .btn.ghost{ background: transparent; }
    .btn.danger{
      border: 1px solid rgba(214,125,125,.35);
      background: rgba(214,125,125,.10);
    }
    .btn:disabled{
      opacity: .55;
      cursor: not-allowed;
      transform: none !important;
    }

    .divider{
      height: 1px;
      background: color-mix(in srgb, var(--text) 10%, transparent);
      margin: 18px 0;
      opacity: .7;
    }

    textarea, input[type="email"], input[type="text"], select{
      width: 100%;
      border: var(--line);
      background: var(--input-bg);
      border-radius: 16px;
      color: var(--text);
      padding: 12px 14px;
      font-family: var(--font-ui);
      font-size: 16px;
      line-height: 1.6;
      outline: none;
      transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    textarea{ resize: vertical; }
    textarea:focus, input:focus, select:focus{
      border-color: color-mix(in srgb, var(--accent) 55%, transparent);
      box-shadow: 0 0 0 1px var(--focus);
    }
    select { font-size: 15px; }

    .kicker{
      font-size: 14px;
      color: var(--muted);
      margin: 0 0 8px;
      letter-spacing: .1px;
    }
    .hint{
      margin-top: 10px;
      color: var(--muted2);
      font-size: 13px;
      line-height: 1.45;
    }
    .small{ font-size: 12.5px; color: var(--muted2); }

    .fade{
      opacity: 0;
      transform: translateY(6px);
      transition: opacity .28s ease, transform .28s ease;
    }
    .fade.show{
      opacity: 1;
      transform: translateY(0);
    }

    .med-box{
      background: var(--surface2);
      border: var(--line);
      border-radius: 18px;
      padding: 18px;
      white-space: pre-wrap;
      line-height: 1.75;
      font-size: 16px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      font-family: var(--font-ui);
    }

    /* âœ… Meditation audio player */
    .audio-player{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 10px;
      margin-bottom: 18px;
    }
    .audio-player .label{
      font-size: 14px;
      color: var(--muted);
      font-family: var(--font-ui);
    }
    .audio-player .btn{
      min-width: 140px;
      text-align: center;
    }

    .footer-note{
      color: var(--muted2);
      font-size: 12.5px;
      line-height: 1.45;
      padding: 0 4px;
      font-family: var(--font-ui);
    }

    .footer-note a{
      color: inherit;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .list{ display:grid; gap: 10px; margin-top: 8px; }
    .entry{
      border: var(--line);
      background: var(--surface2);
      border-radius: 16px;
      padding: 14px 14px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .entry .meta{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      color: var(--muted2);
      font-size: 12.5px;
      margin-bottom: 8px;
      font-family: var(--font-ui);
    }

    /* ðŸ”¥ Red glow for Munchkin Boo's private journal (perpetual) */
    #blogLink .meta span{
      text-shadow:
        0 0 6px rgba(255,80,80,.6),
        0 0 14px rgba(255,40,40,.45);
    }

    #blogLink .meta,
    #blogLink .preview{
      color: rgba(255,180,180,.95);
    }

    @keyframes redPulse{
      0%   { box-shadow: 0 0 0 1px rgba(255,80,80,.25), 0 0 14px rgba(255,60,60,.35); }
      100% { box-shadow: 0 0 0 1px rgba(255,80,80,.45), 0 0 28px rgba(255,40,40,.55); }
    }

    /* âœ… Make the same existing pulse perpetual */
    #blogLink{
      animation: redPulse 1.4s ease-in-out infinite alternate;
    }

    /* Keep hover rules too (same style as before) */
    #blogLink:hover .meta span{
      text-shadow:
        0 0 6px rgba(255,80,80,.6),
        0 0 14px rgba(255,40,40,.45);
    }

    #blogLink:hover .meta,
    #blogLink:hover .preview{
      color: rgba(255,180,180,.95);
    }

    #blogLink:hover{
      animation: redPulse 1.4s ease-in-out infinite alternate;
    }

    /* âœ… Force true center on the blog tile meta line */
    .entry .meta.meta-center{
      display: block;
      text-align: center;
      margin-bottom: 8px;
    }
    .entry .meta.meta-center span{
      display: block;
      width: 100%;
    }
    .entry .meta.meta-center span:last-child{
      display: none;
    }

    .entry .preview{
      margin: 0;
      color: var(--text);
      font-size: 15px;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: var(--toast-bg);
      border: var(--line);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease, transform .2s ease;
      box-shadow: 0 10px 25px rgba(0,0,0,.22);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      font-family: var(--font-ui);
      z-index: 20000;
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(-4px); }

    @media (max-width: 520px){
      .title{ font-size: 23px; }
      .subtitle{ font-size: 15px; }
      .pill{ padding: 9px 10px; }
      .pill-select{ padding: 9px 10px; }
      .card-inner{ padding: 18px; }
    }

    /***********************
     * âœ… Home hero tiles (consistent charcoal-forward tiles)
     ***********************/
    .home-hero{
      display:grid;
      grid-template-columns: 1.35fr 0.85fr;
      gap: 14px;
      margin-top: 8px;
      align-items:stretch;
    }

    @media (max-width: 860px){
      .home-hero{ grid-template-columns: 1fr; }
    }
    .home-stack{
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    .hero-tile{
      position: relative;
      border: var(--line);
      border-radius: 22px;

      /* consistent tile surface for all tiles */
      background: linear-gradient(
        180deg,
        color-mix(in srgb, var(--surface) 92%, transparent),
        color-mix(in srgb, var(--surface2) 98%, transparent)
      );

      box-shadow: var(--shadow);
      overflow: hidden;
      cursor: pointer;
      user-select:none;
      transform: translateZ(0);
      transition: transform 220ms ease, border-color 220ms ease, box-shadow 220ms ease, filter 220ms ease;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    /* âœ… Big tile keeps your artwork, but still matches the charcoal vibe */
    .hero-big{
      min-height: 250px;
      display:flex;
      align-items:flex-end;

      /* RESTORED artwork */
      background-image: url("assets/art/free-writing.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;

      /* fallback if image fails */
      background-color: color-mix(in srgb, var(--surface) 70%, transparent);
    }

    /* Keep the overlay so it stays readable + charcoal-consistent */
    .hero-big::after{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(900px 520px at 30% 0%, color-mix(in srgb, var(--accent) 10%, transparent), transparent 60%),
        linear-gradient(to bottom, var(--hero-overlay-top), var(--hero-overlay-bot));
      z-index:1;
      pointer-events:none;
    }

    /* subtle top sheen for the big tile (still same palette) */
    .hero-big::after{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(900px 520px at 30% 0%, color-mix(in srgb, var(--accent) 10%, transparent), transparent 60%),
        linear-gradient(to bottom, rgba(0,0,0,.05), rgba(0,0,0,.22));
      z-index:1;
      pointer-events:none;
    }

    .hero-tile:active{
      transform: translateY(-1px) scale(0.995);
    }
    .hero-tile:focus-visible{
      outline:none;
      box-shadow: 0 0 0 3px var(--focus), var(--shadow);
      border-color: color-mix(in srgb, var(--accent) 45%, transparent);
    }

    /* Base stacking context */
    .hero-tile{
      position: relative;
      isolation: isolate; /* important: keeps z-index layers contained */
    }

    /* Edge glow layer */
    .hero-tile::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: inherit;
      pointer-events:none;

      opacity: 0;
      transition: opacity 260ms ease;

      background:
        radial-gradient(900px 240px at 25% 0%,
          color-mix(in srgb, var(--accent) 42%, transparent),
          transparent 62%),
        radial-gradient(900px 240px at 75% 100%,
          color-mix(in srgb, var(--accent) 30%, transparent),
          transparent 66%);

      filter: blur(10px);

      /* KEY: sits above artwork/overlay, below content */
      z-index: 3;
    }

    /* Make sure overlay doesn't hide the glow */
    .hero-big::after{
      z-index: 2; /* was 1 in some versions; ensure it's below ::before */
    }

    /* Glow + content ordering */
    .hero-glow{ z-index: 1; }
    .hero-body{ position: relative; z-index: 4; }

    .hero-body{
      position:relative;
      z-index:2;
      display:flex;
      align-items:center;
      gap: 14px;
      padding: 16px 16px;
    }

    .hero-icon{
      width: 46px;
      height: 46px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      font-size: 22px;
      border: 1px solid color-mix(in srgb, var(--text) 14%, transparent);
      background: color-mix(in srgb, var(--surface2) 70%, transparent);
      box-shadow: 0 10px 22px rgba(0,0,0,.20);
      flex: 0 0 auto;
    }

    .hero-text{ display:flex; flex-direction:column; gap: 6px; }
    .hero-title{
      margin:0;
      font-weight: 700;
      font-size: 18px;
      letter-spacing: .12px;
      font-family: var(--font-display);
    }
    .hero-sub{
      margin:0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.45;
    }

    .hero-big .hero-body{
      padding: 20px 20px;
      align-items:flex-end;
    }
    .hero-big .hero-icon{
      position:absolute;
      top: 16px;
      left: 16px;
      width: 64px;
      height: 64px;
      border-radius: 18px;
      font-size: 30px;
    }
    /* Darken text ONLY on the big Free Writing tile */
    .hero-big .hero-title{
      color: #0f0f12; /* or any dark you want */
    }

    .hero-big .hero-sub{
      color: rgba(15,15,18,.75);
    }
    .hero-big .hero-title{ font-size: 22px; }
    .hero-big .hero-sub{ max-width: 46ch; color: color-mix(in srgb, var((--accent)) 78%, transparent); }

    /* âœ… Fade-in question on Home */
    .home-question{
      margin: 0 0 4px;
      font-size: clamp(22px, 3.3vw, 34px);
      font-weight: 650;
      letter-spacing: .15px;
      line-height: 1.15;
    }
    .home-qfade{
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 700ms ease, transform 700ms ease;
    }
    .home-qfade.show{
      opacity: 1;
      transform: translateY(0);
    }

    @media (prefers-reduced-motion: reduce){
      .hero-tile{ transition: none; }
      .home-qfade{ transition: none; opacity: 1; transform:none; }
    }

    /***********************
     * âœ… Mood check-in modal
     ***********************/
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.46);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 15000;
    }
    .modal-backdrop.active{ display:flex; }

    .modal{
      width: min(560px, 100%);
      border: var(--line);
      border-radius: 22px;
      background: linear-gradient(180deg, var(--surface), var(--surface2));
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
      transform: translateY(8px);
      opacity: 0;
      transition: opacity 1000ms ease, transform 1000ms ease;
    }
    .modal-backdrop.active .modal{
      transform: translateY(0);
      opacity: 1;
    }
    .modal-inner{ padding: 18px 18px 16px; }
    .modal-title{
      margin: 0 0 8px;
      font-size: 20px;
      font-weight: 650;
      letter-spacing: .12px;
      font-family: var(--font-display);
    }
    .modal-sub{
      margin: 0 0 14px;
      color: var(--muted);
      font-size: 14.5px;
      line-height: 1.55;
      font-family: var(--font-ui);
    }

    /* âœ… UPDATED: custom mood field (remove dotted/dashed outline) */
    .mood-custom{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap: 8px;
      padding: 12px 12px;
      border-radius: 16px;

      /* was: 1px dashed ... */
      border: var(--line);

      background: color-mix(in srgb, var(--surface2) 80%, transparent);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .mood-custom .label{
      font-size: 13px;
      color: var(--muted2);
      margin: 0;
    }
    .mood-custom input[type="text"]{
      border-radius: 14px;
      padding: 11px 12px;
      font-size: 15px;
    }
    .mood-custom .tiny{
      font-size: 12.5px;
      color: var(--muted2);
      margin: 0;
      line-height: 1.35;
    }

    .mood-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    @media (min-width: 520px){
      .mood-grid{ grid-template-columns: 1fr 1fr; }
    }
    .mood-btn{
      border: var(--line);
      background: var(--surface2);
      border-radius: 16px;
      padding: 12px 12px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      text-align:left;
      font-family: var(--font-ui);
      color: var(--text);
      font-size: 14px;
      position: relative;
      overflow: hidden;
    }
    .mood-btn:hover{ background: var(--surface); transform: translateY(-1px); }
    .mood-btn:focus-visible{
      outline:none;
      box-shadow: 0 0 0 3px var(--focus), var(--shadow);
      border-color: rgba(255,255,255,.18);
    }
    .mood-btn.selected{
      border-color: color-mix(in srgb, var(--accent) 55%, transparent);
      background: color-mix(in srgb, var(--accent) 14%, var(--surface2));
      box-shadow: 0 0 0 3px var(--focus);
    }
    .mood-btn.selected::after{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(240px 180px at 18% 15%, color-mix(in srgb, var(--accent) 22%, transparent), transparent 68%),
        radial-gradient(260px 190px at 88% 86%, color-mix(in srgb, var(--accent) 16%, transparent), transparent 72%);
      opacity: .6;
      pointer-events:none;
    }

    .modal-footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px 14px 14px;
      border-top: 1px solid color-mix(in srgb, var(--text) 10%, transparent);
      background: color-mix(in srgb, var(--surface2) 65%, transparent);
    }
    .modal-reply{
      color: var(--muted2);
      font-size: 13px;
      line-height: 1.45;
      margin: 0;
      min-height: 1.45em;
      flex: 1 1 auto;
      font-family: var(--font-ui);
    }
    .modal-actions{
      display:flex;
      gap: 8px;
      flex: 0 0 auto;
    }

    /***********************
     * âœ… Clear all site data modal (used by Summon Boo)
     ***********************/
    #clearDataBackdrop{
      z-index: 17000; /* above Boo overlay (16000) */
    }
    .danger-note{
      margin: 10px 0 0;
      color: color-mix(in srgb, var(--text) 84%, transparent);
      font-size: 13px;
      line-height: 1.45;
      font-family: var(--font-ui);
    }
    .danger-note strong{
      color: color-mix(in srgb, var(--text) 96%, transparent);
      font-weight: 650;
    }

    /***********************
     * âœ… Summon Boo (Journal Boo)
     * - Icon in top-right corner of the SCREEN (outside the card)
     * - JSON-driven scenes loaded from assets/boo/summonboo/scenes.json
     ***********************/
    .summonBooBtn{
      position: fixed;
      top: 14px;
      right: 14px;
      z-index: 12000; /* below mood modal (15000), above app UI */
      border: none;
      background: surface;
      padding: 0;
      margin: 0;
      cursor: pointer;
      border-radius: 16px;
      display: none; /* shown only after app starts */
    }
    .summonBooBtn:focus-visible{
      outline: none;
      box-shadow: 0 0 0 4px var(--focus), var(--shadow);
    }
    .summonBooIcon{
      width: 64px;
      height: 64px;
      object-fit: contain;
      display: block;
      opacity: .95;
      transition: transform 120ms ease, opacity 180ms ease;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.20));
    }
    .summonBooBtn:hover .summonBooIcon{
      opacity: 1;
      transform: scale(1.03);
    }
    @media (max-width: 520px){
      .summonBooIcon{ width: 75px; height: 75px; }
      .summonBooBtn{ top: 10px; right: 10px; }
    }

    .booOverlay{
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      background: rgba(0,0,0,.46);
      z-index: 16000; /* above mood modal */
    }
    .booOverlay.active{ display:flex; }

    .booPanel{
      width: min(560px, 100%);
      border: var(--line);
      border-radius: 22px;
      background: linear-gradient(180deg, var(--surface), var(--surface2));
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow: hidden;
      transform: translateY(8px);
      opacity: 0;
      transition: opacity 520ms ease, transform 520ms ease;
    }
    .booOverlay.active .booPanel{
      transform: translateY(0);
      opacity: 1;
    }

    .booInner{ padding: 18px 18px 14px; }

    .booTitle{
      margin: 0 0 10px;
      font-size: 18px;
      font-weight: 650;
      letter-spacing: .12px;
      font-family: var(--font-display);
    }
    .booLines{
      margin: 0 0 12px;
      color: var(--text);
      font-size: 15.5px;
      line-height: 1.65;
      white-space: pre-wrap;
      font-family: var(--font-ui);
    }

    .booInputWrap{
      margin-top: 10px;
      display:none;
      flex-direction: column;
      gap: 8px;
    }
    .booInputWrap.show{ display:flex; }

    .booHint{
      margin: 0;
      color: var(--muted2);
      font-size: 12.5px;
      line-height: 1.35;
    }

    .booActions{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 12px 14px 14px;
      border-top: 1px solid color-mix(in srgb, var(--text) 10%, transparent);
      background: color-mix(in srgb, var(--surface2) 65%, transparent);
      justify-content: flex-end;
    }

    .booChoice{
      border: var(--line);
      background: var(--surface2);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      color: var(--text);
      cursor:pointer;
      user-select:none;
      transition: background .12s ease, transform .12s ease, border-color .12s ease, box-shadow .12s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      font-family: var(--font-ui);
      white-space: nowrap;
    }
    .booChoice:hover{ background: var(--surface); transform: translateY(-1px); }
    .booChoice:focus-visible{
      outline: none;
      box-shadow: 0 0 0 3px var(--focus), var(--shadow);
      border-color: rgba(255,255,255,.18);
    }

    .booCloseX{
      position: absolute;
      top: 12px;
      right: 12px;
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: var(--line);
      background: var(--surface2);
      cursor: pointer;
      display:grid;
      place-items:center;
      color: var(--muted);
      transition: background .12s ease, transform .12s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 2;
    }
    .booCloseX:hover{ background: var(--surface); transform: translateY(-1px); color: var(--text); }

    @media (prefers-reduced-motion: reduce){
      .booPanel{ transition:none; transform:none; opacity: 1; }
      .summonBooIcon{ transition:none; }
    }
  </style>
</head>

<script data-goatcounter="https://munchkin-boo.goatcounter.com/count"
  async src="//gc.zgo.at/count.js"></script>

<!-- âœ… Charcoal is the default theme on load -->
<body data-theme="charcoal">

  <!-- âœ… LANDING PAGE -->
  <section id="jbWelcome" class="jbScreen active" aria-label="Welcome">
    <div class="jbCenter">
      <div id="jbWelcomeTitle" class="jbWelcomeTitle">Hello and welcome to Journal Boo...</div>
      <p id="jbWelcomeSub" class="jbWelcomeSub">...Iâ€™m your personal journal companion!</p>
      <button id="jbStartBtn" class="jbStartBtn" type="button">Letâ€™s get started</button>
    </div>
  </section>

  <!-- âœ… Summon Boo button (top-right of screen, outside card) -->
  <button id="summonBooBtn" class="summonBooBtn" type="button" aria-label="Summon Boo" title="Summon Boo">
    <img src="assets/icon/summon-boo.png" alt="" class="summonBooIcon" aria-hidden="true" />
  </button>

  <!-- âœ… Boo Overlay -->
  <div id="booOverlay" class="booOverlay" aria-hidden="true">
    <div class="booPanel" role="dialog" aria-modal="true" aria-labelledby="booTitle">
      <button id="booCloseX" class="booCloseX" type="button" aria-label="Close">âœ•</button>
      <div class="booInner">
        <h3 id="booTitle" class="booTitle">Boo</h3>
        <div id="booLines" class="booLines"></div>

        <div id="booInputWrap" class="booInputWrap">
          <input id="booInput" type="text" placeholder="" autocomplete="off" />
          <p id="booHint" class="booHint"></p>
        </div>
      </div>
      <div id="booActions" class="booActions" aria-label="Boo choices"></div>
    </div>
  </div>

  <!-- âœ… Clear all site data modal (Summon Boo) -->
  <div id="clearDataBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="clearDataTitle">
      <div class="modal-inner">
        <h3 class="modal-title" id="clearDataTitle">Clear all site data</h3>
        <p class="modal-sub">
          This will remove <strong>everything</strong> saved on this device for Journal Boo:
          your name, Booâ€™s memories, saved entries, settings, and any cached data.
        </p>

        <p class="kicker">Type <strong>CLEAR</strong> to confirm</p>
        <input id="clearDataConfirmInput" type="text" placeholder="Type CLEARâ€¦" autocomplete="off" />

        <p class="danger-note">
          <strong>This cannot be undone.</strong>
          If you want to keep anything, email yourself an entry first.
        </p>
      </div>

      <div class="modal-footer">
        <p class="modal-reply" id="clearDataReply" aria-live="polite"></p>
        <div class="modal-actions">
          <button class="btn ghost" id="clearDataCancel" type="button">Cancel</button>
          <button class="btn danger" id="clearDataDoIt" type="button" disabled>Clear all</button>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… MAIN APP (hidden until start) -->
  <div id="jbApp" class="app hidden">
    <div class="shell">
      <header>
        <div class="brand">
          <h1>Journal Boo</h1>
          <p>a quiet companion for writing, reflection, and unwinding</p>
        </div>

        <div class="top-actions">
          <button class="pill" id="btnHome" title="Home">Home</button>
          <button class="pill" id="btnJournal" title="My Journal">My Journal</button>

          <button class="pill" id="btnMusicToggle" title="Toggle music">
            Music: <span id="musicState">Off</span>
          </button>
          <button class="pill" id="btnMusicNext" title="Change music">
            Track: <span id="musicTrackLabel">Deviâ€™s Song</span>
          </button>
        </div>
      </header>

      <main class="card">
        <div class="card-inner fade" id="view"></div>
      </main>

      <div class="footer-note">
        Your writing is saved locally in this browser. (V1)<br />
        <a href="#" id="privacyLink">Privacy &amp; data use</a><br />
        Â© 2025 James Ritchie and www.boo-industries.com. All rights reserved. Contact: jamesalexritchie@outlook.com for more information.
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <audio id="bgm" preload="auto" loop></audio>
  <audio id="medPlayer" preload="none"></audio>

  <!-- âœ… Mood check-in modal (hidden by default) -->
  <div id="moodModalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="moodModalTitle">
      <div class="modal-inner">
        <h3 class="modal-title" id="moodModalTitle">Just checking in with you.</h3>
        <p class="modal-sub" id="moodModalSub">How are you feeling right now?</p>

        <!-- âœ… NEW: custom mood input -->
        <div class="mood-custom">
          <p class="label">Tell us what mood you're in or select a mood from the list below...</p>
          <input id="moodCustomInput" type="text" placeholder="e.g. hopeful, worn out, proud, fragileâ€¦" autocomplete="off" />
          <p class="tiny"></p>
        </div>

        <div class="mood-grid" id="moodGrid"></div>
      </div>

      <div class="modal-footer">
        <p class="modal-reply" id="moodReply" aria-live="polite"></p>
        <div class="modal-actions">
          <button class="btn ghost" id="moodCancel" type="button">Skip</button>
          <button class="btn primary" id="moodContinue" type="button" disabled>Continue</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * Journal Boo (V1)
     ***********************/

    // âœ… Added 2 more tracks
    const TRACKS = [
      { id: "devi-song",       label: "Deviâ€™s Song",      src: "assets/music/devi-song.mp3" },
      { id: "labour-of-love",  label: "Labour Of Love",   src: "assets/music/labour-of-love.mp3" },
      { id: "crying-out",      label: "Crying Out",       src: "assets/music/crying-out.mp3" },
      { id: "warmer",          label: "Warmer",           src: "assets/music/warmer.mp3" },
      { id: "concerto",        label: "Concerto",         src: "assets/music/concerto.mp3" },
    ];

    /***********************
     * âœ… Meditations (loaded from JSON files)
     * Paths: assets/meditations/[short title].json
     * Each JSON can optionally include: { id, title, intro, body, audioSrc }
     ***********************/
    const MEDITATIONS_INDEX = [
      { id: "giving-and-receiving-love", title: "Giving and Receiving Love", intro: "A gentle practice of offering and receiving warmth, even through difficulty.", path: "assets/meditations/giving-and-receiving-love.json" },
      { id: "gentle-gratitude",          title: "A Gentle Practice of Gratitude", intro: "A small, unforced gratitude practice â€” calm and simple.", path: "assets/meditations/gentle-gratitude.json" },
      { id: "making-space",             title: "Making Space for One Another", intro: "A reflection on warmth, space, and the healing nature of giving.", path: "assets/meditations/making-space.json" },
    ];

    // âœ… Poetry Corner (loaded from one combined JSON)
    const POETRY_INDEX_PATH = "assets/poetry/poems.json";

    const LS_KEY = "journal_boo_entries_v1";
    const LS_SETTINGS = "journal_boo_settings_v1";
    const LS_EMAIL = "journal_boo_email_v1";
    const LS_THEME = "journal_boo_theme_v1";

    // âœ… Summon Boo storage keys (local-only)
    const LS_BOO_MUTED = "journal_boo_booMuted_v1";
    const LS_BOO_NAME  = "journal_boo_name_v1";
    const LS_BOO_NOTES = "journal_boo_booNotes_v1";
    const LS_BOO_SEEN_INTRO = "journal_boo_booSeenIntro_v1";

    // âœ… Boo assets
    const BOO_ICON_PATH = "assets/icon/summon-boo.png";
    // Robust: try both .json and .jason (in case the file is named that way)
    const BOO_SCENES_CANDIDATES = [
      "assets/boo/summonboo/scenes.json",
      "assets/boo/summonboo/scenes.jason"
    ];

    // âœ… Mood options (6 moods)
    const MOODS = [
      { id: "quite-happy", label: "Quite happy", tone: "up" },
      { id: "content",     label: "Content",     tone: "up" },
      { id: "okay",        label: "Okay",        tone: "mid" },
      { id: "a-bit-low",   label: "A little low",tone: "down" },
      { id: "anxious",     label: "Anxious",     tone: "down" },
      { id: "heavy",       label: "Heavy",       tone: "down" },
    ];

    const state = {
      route: "home",
      musicOn: false,
      trackId: "devi-song",

      // âœ… DEFAULT THEME: charcoal (darker by default)
      theme: "charcoal",

      freeText: "",
      freeMoodBefore: null,
      freeMoodAfter: null,

      meditationId: null,
      lastSavedEntryId: null,

      medCache: {},
      poetryCache: null,

      poetryCollectionId: null,
    };

    const viewEl = document.getElementById("view");
    const toastEl = document.getElementById("toast");
    const bgm = document.getElementById("bgm");
    const medPlayer = document.getElementById("medPlayer");
    const musicStateEl = document.getElementById("musicState");
    const musicTrackLabelEl = document.getElementById("musicTrackLabel");
    const themeSelectEl = document.getElementById("themeSelect");

    // âœ… Mood modal nodes
    const moodBackdrop = document.getElementById("moodModalBackdrop");
    const moodTitleEl = document.getElementById("moodModalTitle");
    const moodSubEl = document.getElementById("moodModalSub");
    const moodGridEl = document.getElementById("moodGrid");
    const moodReplyEl = document.getElementById("moodReply");
    const moodCancelBtn = document.getElementById("moodCancel");
    const moodContinueBtn = document.getElementById("moodContinue");
    const moodCustomInput = document.getElementById("moodCustomInput");

    // âœ… Clear all site data modal nodes
    const clearDataBackdrop = document.getElementById("clearDataBackdrop");
    const clearDataConfirmInput = document.getElementById("clearDataConfirmInput");
    const clearDataCancel = document.getElementById("clearDataCancel");
    const clearDataDoIt = document.getElementById("clearDataDoIt");
    const clearDataReply = document.getElementById("clearDataReply");

    document.getElementById("btnHome").addEventListener("click", () => go("home"));
    document.getElementById("btnJournal").addEventListener("click", () => go("journal"));

    document.getElementById("privacyLink")?.addEventListener("click", (e) => {
      e.preventDefault();
      go("privacy");
    });

    document.getElementById("btnMusicToggle").addEventListener("click", () => {
      setMusicOn(!state.musicOn);
      toast(state.musicOn ? "Music on." : "Music off.");
    });

    document.getElementById("btnMusicNext").addEventListener("click", () => {
      cycleTrack();
      if (state.musicOn) fadeToTrack(state.trackId);
      toast("Changed music.");
    });

    function loadTheme(){
      try{
        const t = localStorage.getItem(LS_THEME);
        if (t) state.theme = t;
      }catch{}
    }
    function saveTheme(){
      try{ localStorage.setItem(LS_THEME, state.theme); }catch{}
    }
    function applyTheme(){
      // âœ… fallback stays charcoal to match your default
      const t = state.theme || "charcoal";
      document.body.setAttribute("data-theme", t);
      if (themeSelectEl) themeSelectEl.value = t;
    }

    if (themeSelectEl){
      themeSelectEl.addEventListener("change", () => {
        state.theme = themeSelectEl.value;
        saveTheme();
        applyTheme();
        toast("Theme changed.");
      });
    }

    /* âœ… Landing page wiring */
    const jbWelcome = document.getElementById("jbWelcome");
    const jbWelcomeTitle = document.getElementById("jbWelcomeTitle");
    const jbWelcomeSub = document.getElementById("jbWelcomeSub");
    const jbStartBtn = document.getElementById("jbStartBtn");
    const jbApp = document.getElementById("jbApp");

    // âœ… Summon Boo UI nodes
    const summonBooBtn = document.getElementById("summonBooBtn");
    const booOverlay = document.getElementById("booOverlay");
    const booLinesEl = document.getElementById("booLines");
    const booActionsEl = document.getElementById("booActions");
    const booInputWrap = document.getElementById("booInputWrap");
    const booInput = document.getElementById("booInput");
    const booHint = document.getElementById("booHint");
    const booCloseX = document.getElementById("booCloseX");

    function runWelcomeAnimation(){
      if (!jbWelcomeTitle || !jbWelcomeSub || !jbStartBtn) return;
      setTimeout(() => jbWelcomeTitle.classList.add("show"), 160);
      setTimeout(() => jbWelcomeSub.classList.add("show"), 520);
      setTimeout(() => jbStartBtn.classList.add("show"), 900);
    }

    function startApp(){
      if (!jbWelcome || !jbApp) return;
      jbWelcome.classList.remove("active");
      setTimeout(() => {
        jbWelcome.style.display = "none";
        jbApp.classList.remove("hidden");

        // âœ… show Summon Boo icon once app is started
        if (summonBooBtn) summonBooBtn.style.display = "inline-flex";

        go("home").then(() => {});
      }, 520);
    }

    jbStartBtn?.addEventListener("click", startApp);
    document.addEventListener("keydown", (e) => {
      if (jbWelcome && jbWelcome.classList.contains("active") && (e.key === "Enter" || e.key === " ")){
        e.preventDefault();
        startApp();
      }
    });

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function nowIso(){ return new Date().toISOString(); }
    function prettyDate(iso){
      const d = new Date(iso);
      return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 6000);
    }

    function loadSettings(){
      try{
        const raw = localStorage.getItem(LS_SETTINGS);
        if (!raw) return;
        const s = JSON.parse(raw);
        if (typeof s.trackId === "string") state.trackId = s.trackId;
      }catch{}
    }
    function saveSettings(){
      try{
        localStorage.setItem(LS_SETTINGS, JSON.stringify({ trackId: state.trackId }));
      }catch{}
    }

    function loadEntries(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      }catch{
        return [];
      }
    }
    function saveEntries(entries){
      localStorage.setItem(LS_KEY, JSON.stringify(entries));
    }
    function addEntry(entry){
      const entries = loadEntries();
      entries.unshift(entry);
      saveEntries(entries);
      state.lastSavedEntryId = entry.id;
    }

    function loadEmail(){
      try{ return localStorage.getItem(LS_EMAIL) || ""; }catch{ return ""; }
    }
    function saveEmail(email){
      try{ localStorage.setItem(LS_EMAIL, email || ""); }catch{}
    }

    /***********************
     * âœ… Clear all site data (Summon Boo)
     ***********************/
    function isClearDataModalOpen(){
      return !!(clearDataBackdrop && clearDataBackdrop.classList.contains("active"));
    }

    function openClearDataModal(){
      if (!clearDataBackdrop) return;

      // close Boo overlay if open (keeps layering clean)
      if (booOverlay?.classList.contains("active")) {
        closeBooOverlay();
      }

      clearDataReply.textContent = "";
      clearDataConfirmInput.value = "";
      clearDataDoIt.disabled = true;

      clearDataBackdrop.classList.add("active");
      clearDataBackdrop.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";

      setTimeout(() => clearDataConfirmInput?.focus(), 120);
    }

    function closeClearDataModal(){
      if (!clearDataBackdrop) return;
      clearDataBackdrop.classList.remove("active");
      clearDataBackdrop.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      clearDataReply.textContent = "";
      clearDataConfirmInput.value = "";
      clearDataDoIt.disabled = true;
    }

    <script>
  async function clearAllSiteData(){
    try{
      // Stop any audio first
      try { stopMeditationAudio(); } catch {}
      try { stopBackgroundMusic(); } catch {}

      // âœ… Explicitly remove Journal Boo + Summon Boo keys (My Journal included)
      try{
        const KEYS_TO_REMOVE = [
          LS_KEY,           // My Journal entries
          LS_SETTINGS,
          LS_EMAIL,
          LS_THEME,

          LS_BOO_MUTED,
          LS_BOO_NAME,
          LS_BOO_NOTES,
          LS_BOO_SEEN_INTRO,
        ];

        for (const k of KEYS_TO_REMOVE){
          try { localStorage.removeItem(k); } catch {}
        }
      }catch{}

      // local/session storage (best-effort)
      try { localStorage.clear(); } catch {}
      try { sessionStorage.clear(); } catch {}

      // IndexedDB (best-effort)
      try{
        if (indexedDB && typeof indexedDB.databases === "function"){
          const dbs = await indexedDB.databases();
          for (const db of (dbs || [])){
            if (!db || !db.name) continue;
            await new Promise((resolve) => {
              const req = indexedDB.deleteDatabase(db.name);
              req.onsuccess = () => resolve();
              req.onerror = () => resolve();
              req.onblocked = () => resolve();
            });
          }
        }
      }catch{}

      // Cache Storage (best-effort)
      try{
        if (window.caches && typeof caches.keys === "function"){
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
        }
      }catch{}

      // Service workers (best-effort)
      try{
        if (navigator.serviceWorker && navigator.serviceWorker.getRegistrations){
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r => r.unregister()));
        }
      }catch{}

      // Cookies (best-effort, current domain/path)
      try{
        const cookies = document.cookie ? document.cookie.split(";") : [];
        for (const c of cookies){
          const eqPos = c.indexOf("=");
          const name = (eqPos > -1 ? c.substr(0, eqPos) : c).trim();
          if (!name) continue;
          document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`;
        }
      }catch{}
    } finally {
      // hard reset
      window.location.reload();
    }
  }
        }catch{}

        // Cache Storage (best-effort)
        try{
          if (window.caches && typeof caches.keys === "function"){
            const keys = await caches.keys();
            await Promise.all(keys.map(k => caches.delete(k)));
          }
        }catch{}

        // Service workers (best-effort)
        try{
          if (navigator.serviceWorker && navigator.serviceWorker.getRegistrations){
            const regs = await navigator.serviceWorker.getRegistrations();
            await Promise.all(regs.map(r => r.unregister()));
          }
        }catch{}

        // Cookies (best-effort, current domain/path)
        try{
          const cookies = document.cookie ? document.cookie.split(";") : [];
          for (const c of cookies){
            const eqPos = c.indexOf("=");
            const name = (eqPos > -1 ? c.substr(0, eqPos) : c).trim();
            if (!name) continue;
            document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`;
          }
        }catch{}
      } finally {
        // hard reset
        window.location.reload();
      }
    }

    // Clear modal wiring
    clearDataConfirmInput?.addEventListener("input", () => {
      const v = (clearDataConfirmInput.value || "").trim();
      const ok = (v === "CLEAR");
      clearDataDoIt.disabled = !ok;
      clearDataReply.textContent = ok ? "Ready. Press â€œClear allâ€ to wipe everything on this device." : "";
    });

    clearDataCancel?.addEventListener("click", () => closeClearDataModal());
    clearDataDoIt?.addEventListener("click", async () => {
      const v = (clearDataConfirmInput.value || "").trim();
      if (v !== "CLEAR") return;
      clearDataReply.textContent = "Clearingâ€¦";
      clearDataDoIt.disabled = true;
      clearDataCancel.disabled = true;
      await clearAllSiteData();
    });

    clearDataBackdrop?.addEventListener("click", (e) => {
      if (e.target === clearDataBackdrop) closeClearDataModal();
    });

    document.addEventListener("keydown", (e) => {
      if (!isClearDataModalOpen()) return;
      if (e.key === "Escape"){
        e.preventDefault();
        closeClearDataModal();
      }
    });

    // --- Developer blog helpers ---
    async function fetchBlogJson(){
      const candidates = [
        "assets/blog/munchkinboo",
        "assets/blog/munchkinboo.json",
      ];

      let lastErr = null;

      for (const url of candidates){
        try{
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          return { url, data };
        }catch(err){
          lastErr = err;
        }
      }
      throw lastErr || new Error("Unable to load blog JSON.");
    }

    function normalizeBlogPosts(data){
      const posts = Array.isArray(data) ? data
        : (data && Array.isArray(data.posts)) ? data.posts
        : (data && (data.title || data.body || data.content || data.text)) ? [data]
        : [];

      return posts.map((p, idx) => ({
        id: String(p.id ?? idx),
        title: String(p.title ?? "Untitled"),
        date: p.date ? String(p.date) : (p.createdAt ? String(p.createdAt) : ""),
        body: String(p.body ?? p.content ?? p.text ?? ""),
      }));
    }

    /***********************
     * âœ… Mood helpers + modal
     ***********************/
    function moodById(id){
      return MOODS.find(m => m.id === id) || null;
    }

    function moodDisplay(val){
      if (!val) return "";
      const m = moodById(val);
      return m ? m.label : String(val);
    }

    function getMoodReply(phase, moodValue){
      const m = moodById(moodValue);
      const tone = m?.tone || "mid";

      if (phase === "before"){
        if (tone === "up") return "Glad to hear that! When youâ€™re ready, let's start writing!";
        if (tone === "down") return "Iâ€™m sorry youâ€™re feeling that wayâ€¦ When youâ€™re ready, let's make a start!";
        return "Okay. When youâ€™re ready, we can begin.";
      } else {
        if (tone === "up") return "Glad to hear that. Take a gentle breath â€” you did well showing up.";
        if (tone === "down") return "Iâ€™m sorry youâ€™re feeling that way. Thank you for showing up anyway.";
        return "Thank you for checking in.";
      }
    }

    function openMoodModal({ phase }) {
      return new Promise((resolve) => {
        if (phase === "before"){
          moodTitleEl.textContent = "Just checking in with you.";
          moodSubEl.textContent = "How are you feeling right now?";
        } else {
          moodTitleEl.textContent = "Thanks for checking in.";
          moodSubEl.textContent = "How are you feeling after writing?";
        }

        moodGridEl.innerHTML = "";
        moodReplyEl.textContent = "";
        moodContinueBtn.disabled = true;
        moodCustomInput.value = "";
        let selected = null;
        let done = false;

        function setSelected(val){
          selected = val;
          moodContinueBtn.disabled = !selected;

          moodGridEl.querySelectorAll(".mood-btn").forEach(b => {
            b.classList.toggle("selected", b.dataset.mood === val);
          });

          const preset = !!moodById(val);
          if (preset){
            moodCustomInput.value = "";
          }

          moodReplyEl.textContent = selected ? getMoodReply(phase, selected) : "";
        }

        function cleanupAndClose(val){
          if (done) return;
          done = true;

          moodBackdrop.classList.remove("active");
          moodBackdrop.setAttribute("aria-hidden", "true");
          document.body.style.overflow = "";

          document.removeEventListener("keydown", onKeydown);
          moodBackdrop.removeEventListener("click", onBackdropClick);
          moodCancelBtn.removeEventListener("click", onCancel);
          moodContinueBtn.removeEventListener("click", onContinue);
          moodCustomInput.removeEventListener("input", onCustomInput);
          moodCustomInput.removeEventListener("keydown", onCustomKeydown);

          moodGridEl.querySelectorAll("button").forEach(b => b.replaceWith(b.cloneNode(true)));

          resolve(val);
        }

        function onCancel(){ cleanupAndClose(null); }
        function onContinue(){
          if (!selected) return;
          cleanupAndClose(selected);
        }

        function onKeydown(e){
          if (e.key === "Escape"){
            e.preventDefault();
            cleanupAndClose(null);
          }
        }

        function onBackdropClick(e){
          if (e.target === moodBackdrop){
            cleanupAndClose(null);
          }
        }

        function onCustomInput(){
          const v = (moodCustomInput.value || "").trim();
          if (v){
            moodGridEl.querySelectorAll(".mood-btn").forEach(b => b.classList.remove("selected"));
            setSelected(v);
          } else {
            if (selected && !moodById(selected)){
              setSelected(null);
            } else {
              moodContinueBtn.disabled = !selected;
              moodReplyEl.textContent = selected ? getMoodReply(phase, selected) : "";
            }
          }
        }

        function onCustomKeydown(e){
          if (e.key === "Enter"){
            const v = (moodCustomInput.value || "").trim();
            if (v){
              e.preventDefault();
              setSelected(v);
              onContinue();
            }
          }
        }

        MOODS.forEach(m => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "mood-btn";
          btn.textContent = m.label;
          btn.dataset.mood = m.id;
          btn.addEventListener("click", () => setSelected(m.id));
          moodGridEl.appendChild(btn);
        });

        moodBackdrop.classList.add("active");
        moodBackdrop.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";

        moodCancelBtn.addEventListener("click", onCancel);
        moodContinueBtn.addEventListener("click", onContinue);
        moodBackdrop.addEventListener("click", onBackdropClick);
        document.addEventListener("keydown", onKeydown);

        moodCustomInput.addEventListener("input", onCustomInput);
        moodCustomInput.addEventListener("keydown", onCustomKeydown);

        setTimeout(() => { moodCustomInput?.focus(); }, 900);
      });
    }

    function formatMoodPair(entry){
      const before = entry.moodBefore || null;
      const after = entry.moodAfter || null;

      const b = before ? moodDisplay(before) : "";
      const a = after ? moodDisplay(after) : "";

      if (b && a) return `${b} â†’ ${a}`;
      if (a) return a;
      if (b) return b;
      if (entry.mood) return String(entry.mood);
      return "";
    }

    /***********************
     * âœ… JSON helpers (meditations + poetry)
     ***********************/
    async function fetchJsonWithCandidates(baseOrPath){
      const candidates = [];
      if (baseOrPath.endsWith(".json")) {
        candidates.push(baseOrPath);
      } else {
        candidates.push(baseOrPath);
        candidates.push(baseOrPath + ".json");
      }

      let lastErr = null;
      for (const url of candidates){
        try{
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          return { url, data };
        }catch(err){
          lastErr = err;
        }
      }
      throw lastErr || new Error("Unable to load JSON.");
    }

    async function loadMeditationById(id){
      if (state.medCache[id]) return state.medCache[id];

      const meta = MEDITATIONS_INDEX.find(m => m.id === id);
      if (!meta) throw new Error("Meditation not found.");

      const { data } = await fetchJsonWithCandidates(meta.path);
      const med = {
        id,
        title: String(data.title ?? meta.title ?? "Meditation"),
        intro: String(data.intro ?? meta.intro ?? ""),
        body: String(data.body ?? data.text ?? ""),
        audioSrc: data.audioSrc ? String(data.audioSrc) : "",
      };

      state.medCache[id] = med;
      return med;
    }

    function normalizePoetryData(raw){
      let collections = [];

      if (Array.isArray(raw)) {
        collections = raw;
      } else if (raw && Array.isArray(raw.collections)) {
        collections = raw.collections;
      } else if (raw && Array.isArray(raw.poems) && Array.isArray(raw.collections)) {
        collections = raw.collections;
      } else if (raw && Array.isArray(raw.poems)) {
        collections = [{ id: "poems", title: "Poems", poems: raw.poems }];
      } else {
        collections = [];
      }

      collections = collections.map((c, idx) => {
        const poemsArr = Array.isArray(c.poems) ? c.poems : (Array.isArray(c.items) ? c.items : []);
        const poems = poemsArr.map((p, jdx) => ({
          id: String(p.id ?? jdx),
          title: String(p.title ?? p.name ?? "Untitled"),
          text: String(p.text ?? p.body ?? p.content ?? ""),
        }));

        return {
          id: String(c.id ?? idx),
          title: String(c.title ?? c.name ?? "Collection"),
          poems,
        };
      });

      return { collections };
    }

    async function loadPoetryIndex(){
      if (state.poetryCache) return state.poetryCache;
      const { data } = await fetchJsonWithCandidates(POETRY_INDEX_PATH);
      const normalized = normalizePoetryData(data);
      state.poetryCache = normalized;
      return normalized;
    }

    // --- Music engine (gentle fade) ---
    let fadeTimer = null;

    function stopMeditationAudio(){
      medPlayer.pause();
      medPlayer.currentTime = 0;
    }

    function stopBackgroundMusic(){
      clearInterval(fadeTimer);
      bgm.pause();
      bgm.currentTime = 0;
      bgm.volume = 0;
    }

    function toggleMeditationAudio(src, btn){
      if (!src) {
        toast("Audio not available yet.");
        return;
      }

      if (!medPlayer.src || !medPlayer.src.endsWith(src)){
        medPlayer.src = src;
      }

      if (medPlayer.paused){
        stopBackgroundMusic();
        state.musicOn = false;
        syncMusicUI();

        medPlayer.play().catch(() => toast("Tap Play again to start."));
        btn.textContent = "Stop";
      } else {
        stopMeditationAudio();
        btn.textContent = "Play";
      }
    }

    function setMusicOn(on){
      if (!medPlayer.paused){
        stopMeditationAudio();
      }

      state.musicOn = on;
      syncMusicUI();

      if (!on){
        fadeOut(280);
        return;
      }
      ensurePlaying();
      fadeToTrack(state.trackId, 280);
    }

    function ensurePlaying(){
      if (!bgm.src) bgm.src = getTrack(state.trackId).src;
      if (bgm.paused){
        bgm.play().catch(() => toast("Tap Music again to start."));
      }
    }

    function setTrack(trackId){
      state.trackId = trackId;
      saveSettings();
      syncMusicUI();
    }

    function cycleTrack(){
      const idx = TRACKS.findIndex(t => t.id === state.trackId);
      const next = TRACKS[(idx + 1 + TRACKS.length) % TRACKS.length];
      setTrack(next.id);
    }

    function getTrack(trackId){
      return TRACKS.find(t => t.id === trackId) || TRACKS[0];
    }

    function fadeToTrack(trackId, ms=320){
      const t = getTrack(trackId);
      const targetSrc = t.src;

      if (bgm.src && bgm.src.endsWith(targetSrc)){
        ensurePlaying();
        fadeIn(ms);
        return;
      }

      clearInterval(fadeTimer);
      const startVol = bgm.paused ? 0 : bgm.volume;
      const steps = 12;
      const stepMs = Math.max(16, Math.floor(ms / steps));
      let i = 0;

      fadeTimer = setInterval(() => {
        i++;
        bgm.volume = Math.max(0, startVol * (1 - i/steps));
        if (i >= steps){
          clearInterval(fadeTimer);
          bgm.src = targetSrc;
          bgm.volume = 0;
          ensurePlaying();
          fadeIn(ms);
        }
      }, stepMs);
    }

    function fadeIn(ms=320){
      clearInterval(fadeTimer);
      if (state.musicOn) ensurePlaying();

      const steps = 12;
      const stepMs = Math.max(16, Math.floor(ms / steps));
      let i = 0;

      fadeTimer = setInterval(() => {
        i++;
        bgm.volume = Math.min(0.55, (i/steps) * 0.55);
        if (i >= steps) clearInterval(fadeTimer);
      }, stepMs);
    }

    function fadeOut(ms=320){
      clearInterval(fadeTimer);
      const steps = 12;
      const stepMs = Math.max(16, Math.floor(ms / steps));
      const startVol = bgm.paused ? 0 : bgm.volume;
      let i = 0;

      fadeTimer = setInterval(() => {
        i++;
        bgm.volume = Math.max(0, startVol * (1 - i/steps));
        if (i >= steps){
          clearInterval(fadeTimer);
          bgm.pause();
        }
      }, stepMs);
    }

    function syncMusicUI(){
      musicStateEl.textContent = state.musicOn ? "On" : "Off";
      musicTrackLabelEl.textContent = getTrack(state.trackId).label;
    }

    // --- Fade helpers ---
    function fadeInView(){ requestAnimationFrame(() => viewEl.classList.add("show")); }
    function fadeOutView(){ viewEl.classList.remove("show"); }
    function wait(ms){ return new Promise(res => setTimeout(res, ms)); }

    async function setViewHtml(html, {fade=true}={}){
      if (fade){
        fadeOutView();
        await wait(140);
      }
      viewEl.innerHTML = html;
      viewEl.classList.remove("show");
      await wait(10);
      fadeInView();
    }

    function composeEmail(to, subject, body){
      const url =
        "mailto:" + encodeURIComponent(to) +
        "?subject=" + encodeURIComponent(subject) +
        "&body=" + encodeURIComponent(body);
      window.location.href = url;
    }

    function getEntryById(id){
      const entries = loadEntries();
      return entries.find(e => e.id === id) || null;
    }

    async function go(route, payload={}){
      stopMeditationAudio();
      state.route = route;

      if (route === "meditation" && payload.meditationId){
        state.meditationId = payload.meditationId;
      }

      if (route === "poetryCollection" && payload.collectionId){
        state.poetryCollectionId = payload.collectionId;
      }

      await render();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    async function render(){
      switch(state.route){
        case "home": return renderHome();
        case "free": return renderFree();
        case "completeFree": return renderCompleteFree();
        case "medList": return renderMeditationList();
        case "meditation": return renderMeditation(state.meditationId);
        case "completeMeditation": return renderCompleteMeditation();
        case "poetry": return renderPoetryHome();
        case "poetryCollection": return renderPoetryCollection(state.poetryCollectionId);
        case "journal": return renderJournal();
        case "done": return renderDone();
        case "blog": return renderBlog();
        case "privacy": return renderPrivacy();
        default: return renderHome();
      }
    }

    async function renderPrivacy(){
      await setViewHtml(`
        <p class="kicker">Privacy & data use</p>
        <h2 class="title">Your privacy matters here.</h2>

        <div class="med-box">
Journal Boo does not collect, store, or transmit any personal or sensitive information about you.

All journal entries you create are saved only in your own browser, using local storage. This means:

â€¢ Your writing never leaves your device
â€¢ Journal Boo cannot see, read, or access your entries
â€¢ Nothing is uploaded to a server
â€¢ Nothing is shared with third parties

If you clear your browser data, use private browsing, or switch devices, your saved journal entries will no longer be available â€” because they were never stored anywhere else.

The optional background music and written meditations are delivered as static files only.

If you choose to email an entry to yourself, Journal Boo simply opens your email app with the text filled in. The message is sent only by you, through your own email provider.

Journal Boo is designed to be a quiet, private space for reflection â€” not a platform that tracks you.
        </div>

        <div class="row" style="margin-top:16px;">
          <button class="btn primary" id="backHome">Home</button>
          <button class="btn" id="backJournal">My Journal</button>
        </div>
      `);

      document.getElementById("backHome").addEventListener("click", () => go("home"));
      document.getElementById("backJournal").addEventListener("click", () => go("journal"));
    }

    /***********************
     * âœ… UPDATED HOME
     ***********************/
    async function renderHome(){
      await setViewHtml(`
        <div class="home-qfade" id="homeQuestion">
          <h2 class="home-question">What would you like to do today?</h2>
        </div>

        <div class="home-hero" role="navigation" aria-label="Home actions">
          <!-- Left: Big tile -->
          <div class="hero-tile hero-big" data-route="free" tabindex="0" role="button" aria-label="Free writing">
            <div class="hero-glow" aria-hidden="true"></div>
            <div class="hero-body">
              <div class="hero-icon" aria-hidden="true"></div>
              <div class="hero-text">
                <h3 class="hero-title"></h3>
                <p class="hero-sub">Open your journal and let it flow â€” no prompts, no pressure.</p>
              </div>
            </div>
          </div>

          <!-- Right: stacked small tiles -->
          <div class="home-stack">
            <div class="hero-tile" data-route="medList" tabindex="0" role="button" aria-label="Meditations">
              <div class="hero-glow" aria-hidden="true"></div>
              <div class="hero-body">
                <div class="hero-icon" aria-hidden="true">ðŸ«§</div>
                <div class="hero-text">
                  <h3 class="hero-title">Meditations</h3>
                  <p class="hero-sub">Choose a calm written meditation to read at your own pace.</p>
                </div>
              </div>
            </div>

            <div class="hero-tile" data-route="poetry" tabindex="0" role="button" aria-label="Poetry Corner">
              <div class="hero-glow" aria-hidden="true"></div>
              <div class="hero-body">
                <div class="hero-icon" aria-hidden="true">ðŸª¶</div>
                <div class="hero-text">
                  <h3 class="hero-title">Poetry Corner</h3>
                  <p class="hero-sub">Gentle poems â€” calm, kind, and comforting.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="list">
          <div class="entry" id="blogLink" style="cursor:pointer;">
            <div class="meta meta-center">
              <span>Munchkin Booâ€™s private journalâ€¦ Keep out!</span>
              <span></span>
            </div>
            <p class="preview"></p>
          </div>
        </div>
      `);

      const q = document.getElementById("homeQuestion");
      requestAnimationFrame(() => q?.classList.add("show"));

      viewEl.querySelectorAll(".hero-tile").forEach(el => {
        const route = el.getAttribute("data-route");
        el.addEventListener("click", () => go(route));
        el.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " "){
            e.preventDefault();
            go(route);
          }
        });
      });

      const blogLink = document.getElementById("blogLink");
      if (blogLink) blogLink.addEventListener("click", () => go("blog"));
    }

    async function renderBlog(){
      await setViewHtml(`
        <p class="kicker"></p>
        <h2 class="title">Munchkin Booâ€™s private journalâ€¦</h2>
        <p class="subtitle"></p>

        <div class="list" id="blogList">
          <div class="entry">
            <div class="meta"><span>Loadingâ€¦</span><span></span></div>
            <p class="preview">Fetching postsâ€¦</p>
          </div>
        </div>

        <div class="divider"></div>
        <div class="row">
          <button class="btn primary" id="backHome">Home</button>
          <button class="btn" id="backJournal">My Journal</button>
        </div>
      `);

      document.getElementById("backHome").addEventListener("click", () => go("home"));
      document.getElementById("backJournal").addEventListener("click", () => go("journal"));

      const listEl = document.getElementById("blogList");

      try{
        const { data } = await fetchBlogJson();
        const posts = normalizeBlogPosts(data);

        if (!posts.length){
          listEl.innerHTML = `
            <div class="entry">
              <div class="meta"><span>No posts found</span><span></span></div>
              <p class="preview">Your JSON loaded, but it didnâ€™t contain any posts.</p>
            </div>
          `;
          return;
        }

        listEl.innerHTML = "";
        posts.forEach(p => {
          const div = document.createElement("div");
          div.className = "entry";

          let right = "";
          if (p.date){
            const asDate = new Date(p.date);
            right = isNaN(asDate.getTime()) ? p.date : prettyDate(asDate.toISOString());
          }

          div.innerHTML = `
            <div class="meta">
              <span>${escapeHtml(p.title)}</span>
              <span>${escapeHtml(right)}</span>
            </div>
            <p class="preview">${escapeHtml(p.body || "")}</p>
          `;
          listEl.appendChild(div);
        });
      }catch(err){
        listEl.innerHTML = `
          <div class="entry">
            <div class="meta"><span>Couldnâ€™t load blog</span><span></span></div>
            <p class="preview">${escapeHtml(err?.message || "Unknown error")}</p>
          </div>
        `;
      }
    }

    async function renderFree(){
      state.freeMoodBefore = null;
      state.freeMoodAfter = null;

      await setViewHtml(`
        <p class="kicker">Free writing</p>
        <h2 class="title">Take your time.</h2>
        <p class="subtitle">Write freely. No prompts. No pressure. Your work saves when you finish.</p>

        <textarea id="freeText" rows="14" placeholder="Start anywhere...">${escapeHtml(state.freeText || "")}</textarea>

        <div class="row" style="margin-top:14px;">
          <button class="btn primary" id="btnFinishFree">Save journal</button>
          <button class="btn ghost" id="btnBackHome">Back</button>
        </div>
      `);

      const ta = document.getElementById("freeText");
      ta.addEventListener("input", () => { state.freeText = ta.value; });

      const beforeMood = await openMoodModal({ phase: "before" });
      if (beforeMood){
        state.freeMoodBefore = beforeMood;
      }
      ta.focus();

      document.getElementById("btnFinishFree").addEventListener("click", async () => {
        const afterMood = await openMoodModal({ phase: "after" });
        if (afterMood){
          state.freeMoodAfter = afterMood;
        }

        const text = (state.freeText || "").trim();
        if (text.length){
          addEntry({
            id: crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2),
            createdAt: nowIso(),
            type: "Free writing",
            mood: null,
            moodBefore: state.freeMoodBefore,
            moodAfter: state.freeMoodAfter,
            content: text,
          });
          toast("Saved.");
        } else {
          toast("Nothing to save â€” thatâ€™s okay.");
        }

        state.freeText = "";
        state.freeMoodBefore = null;
        state.freeMoodAfter = null;

        await go("completeFree");
      });

      document.getElementById("btnBackHome").addEventListener("click", () => go("home"));
    }

    async function renderCompleteFree(){
      await setViewHtml(`
        <h2 class="title">This is really thoughtful work.</h2>
        <p class="subtitle">What would you like to do next?</p>

        <div class="row">
          <button class="btn primary" id="btnGoMeditation">Unwinding meditation</button>
          <button class="btn" id="btnDone">Iâ€™m done for now</button>
        </div>
      `);

      document.getElementById("btnGoMeditation").addEventListener("click", () => go("medList"));
      document.getElementById("btnDone").addEventListener("click", () => go("done"));
    }

    async function renderMeditationList(){
      const cards = MEDITATIONS_INDEX.map(m => `
        <div class="option" data-med="${escapeHtml(m.id)}">
          <h3>${escapeHtml(m.title)}</h3>
          <p>${escapeHtml(m.intro || "A calm meditation to read at your own pace.")}</p>
        </div>
      `).join("");

      await setViewHtml(`
        <p class="kicker">Meditations</p>
        <h2 class="title">Welcome.</h2>
        <p class="subtitle">
          You can choose a meditation that feels right for you right now.
          Thereâ€™s no wrong choice â€” just follow what you need.
        </p>

        <div class="option-grid">
          ${cards}
        </div>

        <div class="divider"></div>
        <div class="row">
          <button class="btn ghost" id="back">Back</button>
        </div>
      `);

      viewEl.querySelectorAll(".option").forEach(el => {
        el.addEventListener("click", () => go("meditation", { meditationId: el.dataset.med }));
      });
      document.getElementById("back").addEventListener("click", () => go("home"));
    }

    async function renderMeditation(medId){
      try{
        const med = await loadMeditationById(medId);

        const audioBlock = med.audioSrc ? `
          <div class="audio-player">
            <div class="label">${escapeHtml(med.title)}</div>
            <button class="btn" id="toggleMedAudio">Play</button>
          </div>
        ` : "";

        await setViewHtml(`
          <p class="kicker">Meditation</p>
          <h2 class="title">${escapeHtml(med.title)}</h2>
          <p class="subtitle">${escapeHtml(med.intro || "Take your time reading. Move at your own pace.")}</p>

          <div class="fade" id="medfade">
            ${audioBlock}
            <div class="med-box">${escapeHtml(med.body || "")}</div>
          </div>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="finished">Iâ€™m finished</button>
            <button class="btn" id="choose">Choose another</button>
            <button class="btn ghost" id="quit">Iâ€™m done for now</button>
          </div>
        `);

        requestAnimationFrame(() => document.getElementById("medfade")?.classList.add("show"));

        if (med.audioSrc){
          const btn = document.getElementById("toggleMedAudio");
          btn.addEventListener("click", () => toggleMeditationAudio(med.audioSrc, btn));
          medPlayer.onended = () => { btn.textContent = "Play"; };
        } else {
          medPlayer.onended = null;
        }

        document.getElementById("finished").addEventListener("click", () => go("completeMeditation"));
        document.getElementById("choose").addEventListener("click", () => go("medList"));
        document.getElementById("quit").addEventListener("click", () => go("done"));
      }catch(err){
        await setViewHtml(`
          <p class="kicker">Meditation</p>
          <h2 class="title">Couldnâ€™t load meditation</h2>
          <p class="subtitle">${escapeHtml(err?.message || "Unknown error")}</p>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="backList">Back to list</button>
            <button class="btn ghost" id="home">Home</button>
          </div>
        `);

        document.getElementById("backList").addEventListener("click", () => go("medList"));
        document.getElementById("home").addEventListener("click", () => go("home"));
      }
    }

    async function renderCompleteMeditation(){
      await setViewHtml(`
        <h2 class="title">Thanks for taking this time for yourself.</h2>
        <p class="subtitle">What would you like to do next?</p>

        <div class="row">
          <button class="btn primary" id="toFree">Free writing</button>
          <button class="btn ghost" id="done">Iâ€™m done for now</button>
        </div>
      `);

      document.getElementById("toFree").addEventListener("click", () => go("free"));
      document.getElementById("done").addEventListener("click", () => go("done"));
    }

    async function renderPoetryHome(){
      await setViewHtml(`
        <p class="kicker">Poetry Corner</p>
        <h2 class="title">A small place to soften.</h2>
        <p class="subtitle">Choose a collection. Read slowly. Take what you need.</p>

        <div class="list" id="poetryCollections">
          <div class="entry">
            <div class="meta"><span>Loadingâ€¦</span><span></span></div>
            <p class="preview">Fetching poemsâ€¦</p>
          </div>
        </div>

        <div class="divider"></div>
        <div class="row">
          <button class="btn primary" id="backHome">Home</button>
        </div>
      `);

      document.getElementById("backHome").addEventListener("click", () => go("home"));

      const listEl = document.getElementById("poetryCollections");

      try{
        const { collections } = await loadPoetryIndex();

        if (!collections.length){
          listEl.innerHTML = `
            <div class="entry">
              <div class="meta"><span>No collections found</span><span></span></div>
              <p class="preview">Your poems JSON loaded, but it didnâ€™t contain any collections.</p>
            </div>
          `;
          return;
        }

        listEl.innerHTML = "";
        collections.forEach(c => {
          const div = document.createElement("div");
          div.className = "entry";
          div.style.cursor = "pointer";
          div.innerHTML = `
            <div class="meta">
              <span>${escapeHtml(c.title)}</span>
              <span>${escapeHtml(String(c.poems?.length || 0))} poems</span>
            </div>
            <p class="preview">${escapeHtml((c.poems?.[0]?.title ? ("Includes: " + c.poems[0].title) : "A gentle collection."))}</p>
          `;
          div.addEventListener("click", () => go("poetryCollection", { collectionId: c.id }));
          listEl.appendChild(div);
        });
      }catch(err){
        listEl.innerHTML = `
          <div class="entry">
            <div class="meta"><span>Couldnâ€™t load poems</span><span></span></div>
            <p class="preview">${escapeHtml(err?.message || "Unknown error")}</p>
          </div>
        `;
      }
    }

    async function renderPoetryCollection(collectionId){
      await setViewHtml(`
        <p class="kicker">Poetry Corner</p>
        <h2 class="title">Loadingâ€¦</h2>
        <p class="subtitle">Just a moment.</p>

        <div class="divider"></div>
        <div class="row">
          <button class="btn primary" id="backPoetry">Back</button>
          <button class="btn ghost" id="home">Home</button>
        </div>
      `, { fade: true });

      try{
        const { collections } = await loadPoetryIndex();
        const col = collections.find(c => c.id === collectionId) || collections[0];

        const poemsHtml = (col.poems || []).map(p => `
          <div class="entry">
            <div class="meta">
              <span>${escapeHtml(p.title || "Untitled")}</span>
              <span></span>
            </div>
            <p class="preview">${escapeHtml(p.text || "")}</p>
          </div>
        `).join("");

        await setViewHtml(`
          <p class="kicker">Poetry Corner</p>
          <h2 class="title">${escapeHtml(col.title)}</h2>
          <p class="subtitle">Read slowly. Pause whenever you want.</p>

          <div class="list">
            ${poemsHtml || `
              <div class="entry">
                <div class="meta"><span>No poems</span><span></span></div>
                <p class="preview">This collection doesnâ€™t contain any poems yet.</p>
              </div>
            `}
          </div>

          <div class="divider"></div>
          <div class="row">
            <button class="btn primary" id="backPoetry">Back to collections</button>
            <button class="btn ghost" id="home">Home</button>
          </div>
        `);

        document.getElementById("backPoetry").addEventListener("click", () => go("poetry"));
        document.getElementById("home").addEventListener("click", () => go("home"));
      }catch(err){
        await setViewHtml(`
          <p class="kicker">Poetry Corner</p>
          <h2 class="title">Couldnâ€™t load collection</h2>
          <p class="subtitle">${escapeHtml(err?.message || "Unknown error")}</p>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="backPoetry">Back</button>
            <button class="btn ghost" id="home">Home</button>
          </div>
        `);

        document.getElementById("backPoetry").addEventListener("click", () => go("poetry"));
        document.getElementById("home").addEventListener("click", () => go("home"));
      }
    }

    async function renderDone(){
      const entries = loadEntries();
      const email = loadEmail();
      const defaultId = state.lastSavedEntryId || (entries[0]?.id || "");

      const options = entries.slice(0, 30).map(e => {
        const moodText = formatMoodPair(e);
        const label = `${e.type} â€” ${prettyDate(e.createdAt)}${moodText ? " â€¢ " + moodText : ""}`;
        const selected = e.id === defaultId ? "selected" : "";
        return `<option value="${escapeHtml(e.id)}" ${selected}>${escapeHtml(label)}</option>`;
      }).join("");

      await setViewHtml(`
        <h2 class="title">You can rest now, if you want.</h2>
        <p class="subtitle">If youâ€™d like, you can email yourself a saved entry.</p>

        <div class="fade" id="donefade">
          <p class="kicker">Your email address</p>
          <input type="email" id="email" placeholder="name@example.com" value="${escapeHtml(email)}" />

          <div style="height:12px;"></div>

          <p class="kicker">Choose an entry</p>
          <select id="entrySelect">
            ${options || `<option value="">No saved entries yet</option>`}
          </select>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="sendEmail">Compose email</button>
            <button class="btn" id="goHome">Home</button>
            <button class="btn ghost" id="goJournal">My Journal</button>
          </div>

          <p class="hint">This opens your email app with the entry filled in. You can review it, then press Send.</p>
        </div>
      `);

      requestAnimationFrame(() => document.getElementById("donefade")?.classList.add("show"));

      document.getElementById("goHome").addEventListener("click", () => go("home"));
      document.getElementById("goJournal").addEventListener("click", () => go("journal"));

      document.getElementById("sendEmail").addEventListener("click", () => {
        const emailEl = document.getElementById("email");
        const entryId = document.getElementById("entrySelect").value;

        const to = (emailEl.value || "").trim();
        if (!to){
          toast("Add an email address first.");
          emailEl.focus();
          return;
        }
        saveEmail(to);

        if (!entryId){
          toast("No entry selected.");
          return;
        }

        const e = getEntryById(entryId);
        if (!e){
          toast("Couldnâ€™t find that entry.");
          return;
        }

        const moodText = formatMoodPair(e);
        const subject = `Journal Boo â€” ${e.type} (${new Date(e.createdAt).toLocaleDateString()})`;
        const body =
`Hi,

Hereâ€™s a saved entry from Journal Boo.

${e.type}${moodText ? " â€¢ " + moodText : ""}
${prettyDate(e.createdAt)}

--------------------

${e.content}

--------------------

Â© James Ritchie 2025`;

        composeEmail(to, subject, body);
      });
    }

    async function renderJournal(){
      const entries = loadEntries();

      await setViewHtml(`
        <p class="kicker">My Journal</p>
        <h2 class="title">Your saved writing</h2>
        <p class="subtitle">Everything here is stored locally in this browser.</p>

        <div class="row">
          <button class="btn primary" id="newFree">New free writing</button>
          <button class="btn" id="toDone">Iâ€™m done for now</button>
          <button class="btn danger" id="clearAll">Clear all (local)</button>
        </div>

        <div class="divider"></div>
        <div class="list" id="entryList"></div>
      `);

      document.getElementById("newFree").addEventListener("click", () => go("free"));
      document.getElementById("toDone").addEventListener("click", () => go("done"));

      document.getElementById("clearAll").addEventListener("click", () => {
        const ok = confirm("Clear all saved entries from this browser?");
        if (!ok) return;
        saveEntries([]);
        toast("Cleared.");
        renderJournal();
      });

      const list = document.getElementById("entryList");
      if (!entries.length){
        list.innerHTML = `
          <div class="entry">
            <div class="meta"><span>Nothing saved yet</span><span></span></div>
            <p class="preview">When you finish a writing session, it will appear here.</p>
          </div>
        `;
        return;
      }

      entries.forEach(e => {
        const div = document.createElement("div");
        div.className = "entry";

        const moodText = formatMoodPair(e);
        const mood = moodText ? ` â€¢ ${escapeHtml(moodText)}` : "";

        div.innerHTML = `
          <div class="meta">
            <span>${escapeHtml(e.type)}${mood}</span>
            <span>${prettyDate(e.createdAt)}</span>
          </div>
          <p class="preview">${escapeHtml(preview(e.content, 420))}</p>
          <div class="row" style="margin-top:10px;">
            <button class="btn" data-open="${escapeHtml(e.id)}">Open</button>
            <button class="btn danger" data-del="${escapeHtml(e.id)}">Delete</button>
          </div>
        `;
        list.appendChild(div);
      });

      list.querySelectorAll("button[data-open]").forEach(btn => {
        btn.addEventListener("click", () => openEntry(btn.getAttribute("data-open")));
      });
      list.querySelectorAll("button[data-del]").forEach(btn => {
        btn.addEventListener("click", () => deleteEntry(btn.getAttribute("data-del")));
      });

      function preview(txt, max){
        const s = (txt || "").trim();
        if (s.length <= max) return s;
        return s.slice(0, max).trim() + "â€¦";
      }

      async function openEntry(id){
        const entries = loadEntries();
        const e = entries.find(x => x.id === id);
        if (!e) return;

        const moodText = formatMoodPair(e);

        await setViewHtml(`
          <p class="kicker">My Journal</p>
          <h2 class="title">${escapeHtml(e.type)}</h2>
          <p class="subtitle">${prettyDate(e.createdAt)}${moodText ? " â€¢ " + escapeHtml(moodText) : ""}</p>

          <div class="med-box">${escapeHtml(e.content)}</div>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="backList">Back</button>
            <button class="btn" id="emailThis">Email this</button>
            <button class="btn danger" id="delThis">Delete</button>
            <button class="btn ghost" id="home">Home</button>
          </div>
        `);

        document.getElementById("backList").addEventListener("click", () => go("journal"));
        document.getElementById("home").addEventListener("click", () => go("home"));

        document.getElementById("delThis").addEventListener("click", () => deleteEntry(id));

        document.getElementById("emailThis").addEventListener("click", () => {
          state.lastSavedEntryId = e.id;
          go("done");
        });
      }

      function deleteEntry(id){
        const ok = confirm("Delete this entry?");
        if (!ok) return;
        const entries = loadEntries().filter(e => e.id !== id);
        saveEntries(entries);
        toast("Deleted.");
        go("journal");
      }
    }

    /***********************
     * âœ… Summon Boo Engine (JSON-driven)
     ***********************/
    let booScenes = null;
    let booMeta = null;
    let booCurrentSceneId = null;
    let booPendingInputKey = null;
    let booPendingInputValue = "";
    let booLoaded = false;
    let booLoading = false;

    function getBooMuted(){
      try{ return localStorage.getItem(LS_BOO_MUTED) === "true"; }catch{ return false; }
    }
    function setBooMuted(val){
      try{ localStorage.setItem(LS_BOO_MUTED, val ? "true" : "false"); }catch{}
    }
    function getUserName(){
      try{ return (localStorage.getItem(LS_BOO_NAME) || "").trim(); }catch{ return ""; }
    }
    function setUserName(name){
      try{ localStorage.setItem(LS_BOO_NAME, (name || "").trim()); }catch{}
    }
    function loadBooNotes(){
      try{
        const raw = localStorage.getItem(LS_BOO_NOTES);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      }catch{
        return [];
      }
    }
    function saveBooNotes(notes){
      try{ localStorage.setItem(LS_BOO_NOTES, JSON.stringify(notes)); }catch{}
    }

    function pickLine(lines){
      const arr = Array.isArray(lines) ? lines.filter(Boolean) : [];
      if (!arr.length) return "";
      if (arr.length === 1) return arr[0];
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function buildRecallLine(name){
      const notes = loadBooNotes();
      const last = notes[0];
      if (!last || !last.text){
        return name
          ? `Earlier, ${name}â€¦ you didnâ€™t leave me anything to hold.\n\nThatâ€™s okay.`
          : `Earlierâ€¦ you didnâ€™t leave me anything to hold.\n\nThatâ€™s okay.`;
      }
      const who = name ? `${name}` : "you";
      return `Earlier, ${who} wrote:\n\nâ€œ${last.text}â€\n\nAdd more memories!`;
    }

    function template(str){
      const name = getUserName();
      const recallLine = buildRecallLine(name);

      return String(str || "")
        .replaceAll("{{name}}", name || "there")
        .replaceAll("{{recallLine}}", recallLine);
    }

    async function fetchBooJson(){
      let lastErr = null;
      for (const url of BOO_SCENES_CANDIDATES){
        try{
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          return data;
        }catch(err){
          lastErr = err;
        }
      }
      throw lastErr || new Error("Unable to load Boo scenes.");
    }

    async function ensureBooLoaded(){
      if (booLoaded || booLoading) return;
      booLoading = true;
      try{
        const data = await fetchBooJson();
        booMeta = data?.meta || {};
        booScenes = data?.scenes || {};
        booLoaded = true;
      }catch(err){
        booLoaded = false;
        booMeta = null;
        booScenes = null;
        throw err;
      }finally{
        booLoading = false;
      }
    }

    function booCanSummon(){
      // prevent summon during welcome screen or before app starts
      if (jbWelcome && jbWelcome.classList.contains("active")) return false;
      if (jbApp && jbApp.classList.contains("hidden")) return false;

      // prevent during mood modal
      if (moodBackdrop && moodBackdrop.classList.contains("active")) return false;

      return true;
    }

    function openBooOverlay(){
      booOverlay.classList.add("active");
      booOverlay.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    }
    function closeBooOverlay(){
      booOverlay.classList.remove("active");
      booOverlay.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      booPendingInputKey = null;
      booPendingInputValue = "";
      booInput.value = "";
      booInputWrap.classList.remove("show");
      booActionsEl.innerHTML = "";
      booLinesEl.textContent = "";
    }

    function renderBooScene(sceneId){
      const scene = booScenes?.[sceneId];
      if (!scene){
        // safety
        closeBooOverlay();
        toast("Boo canâ€™t be summoned right now.");
        return;
      }

      booCurrentSceneId = sceneId;

      const line = template(pickLine(scene.lines));
      booLinesEl.textContent = line || "";

      // Input handling
      booPendingInputKey = null;
      booPendingInputValue = "";

      if (scene.input && scene.input.storeAs){
        booPendingInputKey = String(scene.input.storeAs);
        booInput.placeholder = String(scene.input.placeholder || "");
        booHint.textContent = String(scene.input.hint || "");
        booInput.value = "";
        booInputWrap.classList.add("show");

        // gentle focus
        setTimeout(() => booInput?.focus(), 380);

        booInput.oninput = () => {
          booPendingInputValue = (booInput.value || "").trim();
        };
      } else {
        booInputWrap.classList.remove("show");
        booInput.oninput = null;
      }

      // Choices
      booActionsEl.innerHTML = "";
      const choices = Array.isArray(scene.choices) ? scene.choices : [];

      // If no choices: default close button
      if (!choices.length){
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "booChoice";
        btn.textContent = "Back to writing.";
        btn.onclick = () => closeBooOverlay();
        booActionsEl.appendChild(btn);
        return;
      }

      for (const c of choices){
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "booChoice";
        btn.textContent = String(c.label || "Continue");
        btn.onclick = () => booChoose(c);
        booActionsEl.appendChild(btn);
      }
    }

    function applyBooEffects(effects){
  const arr = Array.isArray(effects) ? effects : [];
  let halt = false;

  for (const ef of arr){
    if (!ef || typeof ef !== "object") continue;

    if (ef.type === "set"){
      const key = String(ef.key || "");
      if (key === "booMuted"){
        setBooMuted(!!ef.value);
      }
    }

    if (ef.type === "appendNote"){
      const text = (booPendingInputValue || "").trim();
      if (!text) continue;
      const notes = loadBooNotes();
      notes.unshift({
        id: (crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2)),
        createdAt: nowIso(),
        tag: ef.tag ? String(ef.tag) : "",
        text
      });
      const capped = notes.slice(0, 40);
      saveBooNotes(capped);
    }

    // âœ… NEW: Clear all site data effect (Summon Boo)
    if (ef.type === "clearAllSiteData"){
      // Use your existing confirmation modal (requires typing CLEAR)
      openClearDataModal();
      halt = true; // important: don't continue scene navigation after this
    }
  }

  return { halt };
}

        }

        if (ef.type === "appendNote"){
          const text = (booPendingInputValue || "").trim();
          if (!text) continue;
          const notes = loadBooNotes();
          notes.unshift({
            id: (crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2)),
            createdAt: nowIso(),
            tag: ef.tag ? String(ef.tag) : "",
            text
          });
          // cap size to keep it light
          const capped = notes.slice(0, 40);
          saveBooNotes(capped);
        }
      }
    }

    function booChoose(choice){
      // require input if scene expects it and user hit "Save"
      const scene = booScenes?.[booCurrentSceneId];
      const expectsInput = !!(scene && scene.input && scene.input.storeAs);

      // store input in name if storeAs === "name"
      if (expectsInput && scene.input.storeAs === "name"){
        const v = (booPendingInputValue || "").trim();
        if (v) setUserName(v);
      }

     const { halt } = applyBooEffects(choice.effects);
if (halt){
  // openClearDataModal() already closed Boo overlay for clean layering
  return;
}

const goto = String(choice.goto || "");
if (!goto || goto === "end"){
  closeBooOverlay();
  return;
}
renderBooScene(goto);
    }

    async function summonBoo(){
      if (!booCanSummon()){
        toast("Boo canâ€™t be summoned right now.");
        return;
      }

      try{
        await ensureBooLoaded();
      }catch(err){
        toast("Boo canâ€™t be summoned right now.");
        return;
      }

      const allowWhenMuted = !!booMeta?.allowSummonWhenMuted;
      const muted = getBooMuted();

      if (muted && !allowWhenMuted){
        toast("Boo canâ€™t be summoned right now.");
        return;
      }

      // Determine which scene to show:
      // - first time ever: meta.firstScene
      // - subsequent summons: meta.summonScene
      const hasSeenIntro = (localStorage.getItem(LS_BOO_SEEN_INTRO) === "true");
      let startScene = "";

      if (!hasSeenIntro && booMeta?.firstScene){
        startScene = String(booMeta.firstScene);
        try{ localStorage.setItem(LS_BOO_SEEN_INTRO, "true"); }catch{}
      } else if (booMeta?.summonScene){
        startScene = String(booMeta.summonScene);
      } else {
        startScene = Object.keys(booScenes || {})[0] || "end";
      }

      // If we have {{name}} in scenes but no stored name yet,
      // ask gently once (inside Boo overlay) before continuing.
      if (!getUserName()){
        // lightweight name capture scene (internal)
        booScenes.__name_gate__ = {
          lines: ["Choose your username"],
          input: { placeholder: "Your nameâ€¦", storeAs: "name", hint: "This stays on this device." },
          choices: [
            { label: "Save", goto: startScene },
            { label: "Not now", goto: startScene }
          ]
        };
        startScene = "__name_gate__";
      }

      openBooOverlay();
      renderBooScene(startScene);
    }

    // Wire Summon Boo button
    summonBooBtn?.addEventListener("click", (e) => {
      e.preventDefault();
      summonBoo();
    });

    // Close overlay interactions
    booCloseX?.addEventListener("click", () => closeBooOverlay());
    booOverlay?.addEventListener("click", (e) => {
      if (e.target === booOverlay) closeBooOverlay();
    });

    document.addEventListener("keydown", (e) => {
      if (!booOverlay.classList.contains("active")) return;
      if (e.key === "Escape"){
        e.preventDefault();
        closeBooOverlay();
      }
    });

    /***********************
     * âœ… App init
     ***********************/
    (function init(){
      loadSettings();

      // âœ… Theme: charcoal default, but saved preference still wins
      loadTheme();
      applyTheme();

      syncMusicUI();

      state.musicOn = false;
      bgm.pause();

      bgm.src = getTrack(state.trackId).src;
      bgm.volume = 0;

      viewEl.classList.remove("show");

      go("home").then(() => {});

      runWelcomeAnimation();
    })();
  </script>
</body>
</html>
