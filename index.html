<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Journal Boo</title>

  <!-- ‚úÖ Adds a "js" class to <html> so we can animate only when JS is running -->
  <script>
    document.documentElement.classList.add("js");
  </script>

  <style>
    :root{
      /* Default vars (will be overridden by body[data-theme]) */
      --bg: #f7f5ef;
      --text: #171615;
      --muted: #4b4a46;
      --muted2:#6a6862;
      --accent:#8a6a2b;

      --radius: 20px;
      --line: 1px solid rgba(0,0,0,.10);
      --shadow: 0 14px 38px rgba(0,0,0,.10);
      --font: ui-serif, Georgia, "Times New Roman", Times, serif;
    }

    /* ‚úÖ Theme palettes */
    body[data-theme="charcoal"]{
      --bg: #0f0f12;
      --text: #f1efe9;
      --muted: #b9b6ad;
      --muted2:#8f8b81;
      --accent:#c9a76a;
      --line: 1px solid rgba(255,255,255,.07);
      --shadow: 0 14px 38px rgba(0,0,0,.35);
    }

    body[data-theme="light"]{
      --bg: #f7f5ef;
      --text: #171615;
      --muted: #4b4a46;
      --muted2:#6a6862;
      --accent:#8a6a2b;
      --line: 1px solid rgba(0,0,0,.10);
      --shadow: 0 14px 38px rgba(0,0,0,.10);
    }

    /* ‚úÖ Brighter green */
    body[data-theme="racing-green"]{
      --bg: #07130e;
      --text: #f3f1ea;
      --muted: #c2d2c8;
      --muted2:#9bb3a8;
      --accent:#31c981;
      --line: 1px solid rgba(255,255,255,.09);
      --shadow: 0 14px 38px rgba(0,0,0,.38);
    }

    /* ‚úÖ Lighter rose pink */
    body[data-theme="rose-pink"]{
      --bg: #1b0f15;
      --text: #fbf3f6;
      --muted: #e2c5d0;
      --muted2:#caa0af;
      --accent:#ff97ba;
      --line: 1px solid rgba(255,255,255,.10);
      --shadow: 0 14px 38px rgba(0,0,0,.40);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin: 0;
      font-family: var(--font);
      background:
        radial-gradient(1100px 800px at 18% 0%, rgba(201,167,106,.10), transparent 58%),
        radial-gradient(900px 600px at 88% 12%, rgba(201,167,106,.07), transparent 60%),
        var(--bg);
      color: var(--text);
      letter-spacing: .1px;
    }

    /* ‚úÖ Landing / Welcome screen */
    .jbScreen{
      position: fixed;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 24px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 520ms ease;
      background:
        radial-gradient(1100px 800px at 18% 0%, rgba(201,167,106,.10), transparent 58%),
        radial-gradient(900px 600px at 88% 12%, rgba(201,167,106,.07), transparent 60%),
        var(--bg);
      z-index: 9999;
    }
    .jbScreen.active{
      opacity: 1;
      pointer-events: auto;
    }

    .jbCenter{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 12px;
      text-align:center;
      max-width: 820px;
    }

    /* ‚úÖ IMPORTANT: visible by default (no blank screen if JS fails) */
    .jbWelcomeTitle{
      font-size: clamp(22px, 4vw, 34px);
      font-weight: 600;
      letter-spacing:.2px;
      color: var(--text);
      margin: 0;
    }
    .jbWelcomeSub{
      margin: 0;
      color: var(--muted);
      font-size: 16px;
      line-height: 1.55;
    }
    .jbStartBtn{
      border: var(--line);
      background: rgba(255,255,255,.03);
      padding: 16px 20px;
      border-radius: 999px;
      font-size: 14px;
      color: var(--text);
      cursor:pointer;
      user-select:none;
      transition: background .12s ease, transform .12s ease;
    }
    .jbStartBtn:hover{ background: rgba(255,255,255,.05); transform: translateY(-1px); }

    /* ‚úÖ Only animate when JS is active */
    html.js .jbWelcomeTitle,
    html.js .jbWelcomeSub,
    html.js .jbStartBtn{
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 700ms ease, transform 700ms ease;
    }
    html.js .jbWelcomeTitle.show,
    html.js .jbWelcomeSub.show,
    html.js .jbStartBtn.show{
      opacity: 1;
      transform: translateY(0);
    }

    /* ‚úÖ Hide main app until started */
    #jbApp.hidden{ display:none; }

    .app{
      min-height: 100%;
      display:flex;
      justify-content:center;
      padding: 28px 14px 40px;
    }

    .shell{
      width: min(820px, 100%);
      display:flex;
      flex-direction:column;
      gap: 14px;

      /* ‚úÖ NEW: needed so the possessed overlay can sit nicely on top */
      position: relative;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 8px 4px;
      gap: 10px;
    }

    .brand{ display:flex; flex-direction:column; gap: 2px; }
    .brand h1{ margin:0; font-size:22px; font-weight:600; letter-spacing:.2px; }
    .brand p{ margin:0; color:var(--muted2); font-size:13px; line-height:1.35; }

    .top-actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .pill{
      border: var(--line);
      background: rgba(255,255,255,.03);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      color: var(--text);
      display:inline-flex;
      align-items:center;
      gap: 8px;
      cursor:pointer;
      user-select:none;
      transition: background .12s ease, transform .12s ease;
    }
    .pill:hover{ background: rgba(255,255,255,.05); transform: translateY(-1px); }

    /* ‚úÖ Pill-style dropdown */
    .pill-select{
      border: var(--line);
      background: rgba(255,255,255,.03);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      color: var(--text);
      display:inline-flex;
      align-items:center;
      gap: 8px;
      transition: background .12s ease, transform .12s ease;
    }
    .pill-select:hover{ background: rgba(255,255,255,.05); transform: translateY(-1px); }
    .pill-select label{
      color: var(--text);
      font-size: 13px;
      user-select:none;
      white-space: nowrap;
    }
    .pill-select select{
      width: auto;
      padding: 0;
      margin: 0;
      border: 0;
      outline: none;
      background: transparent;
      color: var(--text);
      font-family: var(--font);
      font-size: 13px;
      line-height: 1;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }
    /* Simple chevron */
    .pill-select .chev{
      width: 0; height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-top: 6px solid rgba(255,255,255,.55);
      margin-left: 2px;
      transform: translateY(1px);
    }
    body[data-theme="light"] .pill-select .chev{
      border-top-color: rgba(0,0,0,.45);
    }
    /* Dropdown menu colors */
    .pill-select select option{
      background: var(--bg);
      color: var(--text);
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
      border: var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card-inner{ padding: 22px; }

    .title{
      font-size: 26px;
      margin: 0 0 10px;
      font-weight: 600;
      letter-spacing: .15px;
    }
    .subtitle{
      margin: 0 0 18px;
      color: var(--muted);
      line-height: 1.6;
      font-size: 16px;
    }

    .option-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 8px;
    }
    .option{
      border: var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding: 16px 16px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease;
    }
    .option:hover{ background: rgba(255,255,255,.05); transform: translateY(-1px); }
    .option h3{ margin: 0; font-size: 18px; font-weight: 600; }
    .option p{ margin: 6px 0 0; color: var(--muted); font-size: 14px; line-height: 1.5; }

    .row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }

    .btn{
      border: var(--line);
      background: rgba(255,255,255,.03);
      padding: 12px 14px;
      border-radius: 14px;
      font-size: 14px;
      cursor:pointer;
      color: var(--text);
      user-select:none;
      transition: background .12s ease, transform .12s ease;
    }
    .btn:hover{ background: rgba(255,255,255,.05); transform: translateY(-1px); }
    .btn.primary{
      background: rgba(201,167,106,.16);
      border: 1px solid rgba(201,167,106,.35);
    }
    .btn.primary:hover{ background: rgba(201,167,106,.22); }
    .btn.ghost{ background: transparent; }
    .btn.danger{
      border: 1px solid rgba(214,125,125,.35);
      background: rgba(214,125,125,.10);
    }

    .divider{
      height: 1px;
      background: rgba(255,255,255,.07);
      margin: 18px 0;
    }
    body[data-theme="light"] .divider{
      background: rgba(0,0,0,.10);
    }

    textarea, input[type="email"], select{
      width: 100%;
      border: var(--line);
      background: rgba(0,0,0,.16);
      border-radius: 16px;
      color: var(--text);
      padding: 12px 14px;
      font-family: var(--font);
      font-size: 16px;
      line-height: 1.6;
      outline: none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    textarea:focus, input:focus, select:focus{
      border-color: rgba(201,167,106,.45);
      box-shadow: 0 0 0 3px rgba(201,167,106,.10);
    }
    select { font-size: 15px; }

    .kicker{
      font-size: 14px;
      color: var(--muted);
      margin: 0 0 8px;
    }
    .hint{
      margin-top: 10px;
      color: var(--muted2);
      font-size: 13px;
      line-height: 1.45;
    }
    .small{ font-size: 12.5px; color: var(--muted2); }

    .fade{
      opacity: 0;
      transform: translateY(6px);
      transition: opacity .28s ease, transform .28s ease;
    }
    .fade.show{
      opacity: 1;
      transform: translateY(0);
    }

    .med-box{
      background: rgba(255,255,255,.02);
      border: var(--line);
      border-radius: 18px;
      padding: 18px;
      white-space: pre-wrap;
      line-height: 1.75;
      font-size: 16px;
    }

    /* ‚úÖ Meditation audio player */
    .audio-player{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 10px;
      margin-bottom: 18px;
    }
    .audio-player .label{
      font-size: 14px;
      color: var(--muted);
    }
    .audio-player .btn{
      min-width: 140px;
      text-align: center;
    }

    .footer-note{
      color: var(--muted2);
      font-size: 12.5px;
      line-height: 1.45;
      padding: 0 4px;
    }

    .footer-note a{
      color: inherit;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .list{ display:grid; gap: 10px; margin-top: 8px; }
    .entry{
      border: var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 16px;
      padding: 14px 14px;
    }
    .entry .meta{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      color: var(--muted2);
      font-size: 12.5px;
      margin-bottom: 8px;
    }
    .entry .preview{
      margin: 0;
      color: var(--text);
      font-size: 15px;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease, transform .2s ease;
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
      z-index: 999999; /* ‚úÖ stay above possessed overlay */
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(-4px); }
    body[data-theme="light"] .toast{
      background: rgba(255,255,255,.72);
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 10px 25px rgba(0,0,0,.12);
    }

    @media (max-width: 520px){
      .title{ font-size: 23px; }
      .subtitle{ font-size: 15px; }
      .pill{ padding: 9px 10px; }
      .pill-select{ padding: 9px 10px; }
      .card-inner{ padding: 18px; }
    }

    /***********************
     * ‚úÖ NEW: Home hero tiles (shimmer + pop)
     ***********************/
    .home-hero{
      display:grid;
      grid-template-columns: 1.35fr 0.85fr;
      gap: 14px;
      margin-top: 8px;
      align-items:stretch;
    }
    @media (max-width: 860px){
      .home-hero{ grid-template-columns: 1fr; }
    }
    .home-stack{
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    .hero-tile{
      position: relative;
      border: var(--line);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow: hidden;
      cursor: pointer;
      user-select:none;
      transform: translateZ(0);
      transition: transform 220ms ease, background 220ms ease, border-color 220ms ease, box-shadow 220ms ease;
    }
    .hero-tile:hover{
      transform: translateY(-3px) scale(1.01);
      background: linear-gradient(180deg, rgba(225, 225, 225, 0.08), rgba(225, 225, 225, 0.06));
    }
    .hero-tile:active{
      transform: translateY(-1px) scale(0.995);
    }
    .hero-tile:focus-visible{
      outline:none;
      box-shadow:
        0 0 0 3px rgba(49,201,129,.18),
        var(--shadow);
      border-color: rgba(49,201,129,.35);
    }

    .hero-glow{
      position:absolute;
      inset:-70px;
      background:
        radial-gradient(400px 400px at 18% 25%, rgba(225, 225, 225, 0.28), transparent 80%),
        radial-gradient(400px 400px at 86% 22%, rgba(225, 225, 225, 0.20), transparent 80%),
        radial-gradient(400px 400px at 55% 88%, rgba(225, 225, 225, 0.17), transparent 80%);
      filter: blur(10px);
      opacity: .22;
      pointer-events:none;
      transition: opacity 220ms ease;
    }
    .hero-tile:hover .hero-glow{ opacity: 1; }

    .hero-body{
      position:relative;
      z-index:2;
      display:flex;
      align-items:center;
      gap: 14px;
      padding: 16px 16px;
    }

    .hero-icon{
      width: 46px;
      height: 46px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      font-size: 22px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.10);
      box-shadow: 0 10px 22px rgba(0,0,0,.20);
      flex: 0 0 auto;
    }
    body[data-theme="light"] .hero-icon{
      background: rgba(255,255,255,.55);
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      border: 1px solid rgba(0,0,0,.10);
    }

    .hero-text{ display:flex; flex-direction:column; gap: 6px; }
    .hero-title{
      margin:0;
      font-weight: 650;
      font-size: 18px;
      letter-spacing: .15px;
    }
    .hero-sub{
      margin:0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.45;
    }

    .hero-big{
      min-height: 250px;
      display:flex;
      align-items:flex-end;
    }
    .hero-big .hero-body{
      padding: 20px 20px;
      align-items:flex-end;
    }
    .hero-big .hero-icon{
      position:absolute;
      top: 16px;
      left: 16px;
      width: 64px;
      height: 64px;
      border-radius: 18px;
      font-size: 30px;
      background: rgba(0,0,0,.10);
    }
    body[data-theme="light"] .hero-big .hero-icon{
      background: rgba(255,255,255,.60);
    }
    .hero-big .hero-title{ font-size: 22px; }
    .hero-big .hero-sub{ max-width: 46ch; }

    /* ‚úÖ Fade-in question on Home */
    .home-question{
      margin: 0 0 4px;
      font-size: clamp(22px, 3.3vw, 34px);
      font-weight: 600;
      letter-spacing: .15px;
      line-height: 1.15;
    }
    .home-qfade{
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 700ms ease, transform 700ms ease;
    }
    .home-qfade.show{
      opacity: 1;
      transform: translateY(0);
    }

    /***********************
     * ‚úÖ NEW: "Page gets possessed" (Boo Writer icon click)
     * - triggers only via JS (body.has-possessed)
     * - short, skippable, respects reduced motion
     ***********************/
    .possess-layer{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 99999;
      opacity: 0;
      transition: opacity 140ms ease;
    }
    body.has-possessed .possess-layer{
      opacity: 1;
    }

    /* soft vignette + shimmer */
    .possess-layer::before{
      content:"";
      position:absolute;
      inset: -20%;
      background:
        radial-gradient(900px 700px at 20% 8%, rgba(201,167,106,.18), transparent 55%),
        radial-gradient(800px 600px at 88% 14%, rgba(201,167,106,.12), transparent 58%),
        radial-gradient(700px 500px at 60% 88%, rgba(201,167,106,.10), transparent 60%);
      filter: blur(10px);
      opacity: .65;
      transform: translateZ(0);
      mix-blend-mode: screen;
    }
    body[data-theme="light"] .possess-layer::before{
      mix-blend-mode: multiply;
      opacity: .25;
    }

    /* the ‚Äúink streak‚Äù that zips across */
    .possess-streak{
      position:absolute;
      left: -35%;
      top: 18%;
      width: 30%;
      height: 3px;
      border-radius: 999px;
      background: linear-gradient(90deg, transparent, rgba(201,167,106,.8), transparent);
      filter: blur(.2px);
      opacity: 0;
      transform: rotate(-6deg);
      animation: none;
    }
    body.has-possessed .possess-streak{
      animation: streakZip 760ms ease-in-out 110ms 1 both;
    }
    @keyframes streakZip{
      0%{ transform: translateX(0) rotate(-6deg); opacity: 0; }
      10%{ opacity: .8; }
      45%{ opacity: .95; }
      100%{ transform: translateX(220vw) rotate(-6deg); opacity: 0; }
    }

    /* page wobble/tilt lives on the app shell */
    #jbApp{
      transform-origin: 50% 20%;
      will-change: transform, filter;
    }
    body.has-possessed #jbApp{
      animation: possessedWobble 820ms cubic-bezier(.2,.9,.22,1) 0ms 1 both;
      filter: blur(.75px) saturate(1.06) contrast(1.03);
    }
    @keyframes possessedWobble{
      0%   { transform: rotate(0deg) translateY(0px); }
      12%  { transform: rotate(-0.65deg) translateY(-1px); }
      26%  { transform: rotate(0.85deg) translateY(0px); }
      44%  { transform: rotate(-0.45deg) translateY(0px); }
      62%  { transform: rotate(0.32deg) translateY(-1px); }
      78%  { transform: rotate(-0.18deg) translateY(0px); }
      100% { transform: rotate(0deg) translateY(0px); }
    }

    /* tiny ‚Äúblink‚Äù */
    body.has-possessed{
      animation: possessedBlink 820ms ease 0ms 1 both;
    }
    @keyframes possessedBlink{
      0%, 100%{ }
      30%{ }
      31%{ }
    }

    /* subtle glow outline while possessed */
    body.has-possessed .card{
      box-shadow:
        0 0 0 2px rgba(201,167,106,.14),
        var(--shadow);
      transition: box-shadow 120ms ease;
    }

    /* ‚úÖ BOO WRITER icon button styling */
    #btnBooWriter{
      position: relative;
    }
    #btnBooWriter::after{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: 999px;
      border: 1px solid rgba(201,167,106,.0);
      transition: border-color 140ms ease;
      pointer-events:none;
    }
    #btnBooWriter:hover::after{
      border-color: rgba(201,167,106,.28);
    }

    /* Reduce motion */
    @media (prefers-reduced-motion: reduce){
      .hero-tile::before{ animation: none; }
      .hero-tile{ transition: none; }
      .home-qfade{ transition: none; opacity: 1; transform:none; }

      /* ‚úÖ no possessed motion, only a quick toast */
      body.has-possessed #jbApp{ animation: none; filter: none; }
      body.has-possessed .possess-streak{ animation: none; }
      .possess-layer{ display:none; }
    }
  </style>
</head>

<script data-goatcounter="https://munchkin-boo.goatcounter.com/count"
  async src="//gc.zgo.at/count.js"></script>

<!-- ‚úÖ Racing Green is the default theme on load -->
<body data-theme="racing-green">

  <!-- ‚úÖ NEW: possession VFX layer (non-interactive) -->
  <div class="possess-layer" aria-hidden="true">
    <div class="possess-streak"></div>
  </div>

  <!-- ‚úÖ LANDING PAGE -->
  <section id="jbWelcome" class="jbScreen active" aria-label="Welcome">
    <div class="jbCenter">
      <div id="jbWelcomeTitle" class="jbWelcomeTitle">Hello and welcome to Journal Boo...</div>
      <p id="jbWelcomeSub" class="jbWelcomeSub">...I‚Äôm your personal journal companion!</p>
      <button id="jbStartBtn" class="jbStartBtn" type="button">Let‚Äôs get started</button>
    </div>
  </section>

  <!-- ‚úÖ MAIN APP (hidden until start) -->
  <div id="jbApp" class="app hidden">
    <div class="shell">
      <header>
        <div class="brand">
          <h1>Journal Boo</h1>
          <p>a quiet companion for writing, reflection, and unwinding</p>
        </div>

        <div class="top-actions">
          <button class="pill" id="btnHome" title="Home">Home</button>
          <button class="pill" id="btnJournal" title="My Journal">My Journal</button>

          <!-- ‚úÖ NEW: Boo Writer button (top right) -->
          <button class="pill" id="btnBooWriter" title="Boo Writer">
            Boo Writer ‚ú®
          </button>

          <!-- ‚úÖ Theme dropdown (pill-style) -->
          <div class="pill-select" title="Theme">
            <label for="themeSelect">Theme:</label>
            <select id="themeSelect" aria-label="Theme">
              <option value="charcoal">Charcoal Grey</option>
              <option value="light">Light</option>
              <option value="racing-green">Racing Green</option>
              <option value="rose-pink">Rose Pink</option>
            </select>
            <span class="chev" aria-hidden="true"></span>
          </div>

          <button class="pill" id="btnMusicToggle" title="Toggle music">
            Music: <span id="musicState">Off</span>
          </button>
          <button class="pill" id="btnMusicNext" title="Change music">
            Track: <span id="musicTrackLabel">Devi‚Äôs Song</span>
          </button>
        </div>
      </header>

      <main class="card">
        <div class="card-inner fade" id="view"></div>
      </main>

      <div class="footer-note">
        Your writing is saved locally in this browser. (V1)<br />
        <a href="#" id="privacyLink">Privacy &amp; data use</a><br />
        ¬© 2025 James Ritchie and www.boo-industries.com. All rights reserved. Contact: jamesalexritchie@outlook.com for more information.
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <audio id="bgm" preload="auto" loop></audio>
  <audio id="medPlayer" preload="none"></audio>

  <script>
    /***********************
     * Journal Boo (V1)
     ***********************/

    // ‚úÖ Added 2 more tracks
    const TRACKS = [
      { id: "devi-song",       label: "Devi‚Äôs Song",      src: "assets/music/devi-song.mp3" },
      { id: "labour-of-love",  label: "Labour Of Love",   src: "assets/music/labour-of-love.mp3" },
      { id: "crying-out",      label: "Crying Out",       src: "assets/music/crying-out.mp3" },
      { id: "warmer",          label: "Warmer",           src: "assets/music/warmer.mp3" },
      { id: "concerto",        label: "Concerto",         src: "assets/music/concerto.mp3" },
    ];

    /***********************
     * ‚úÖ Meditations (loaded from JSON files)
     * Paths: assets/meditations/[short title].json
     * Each JSON can optionally include: { id, title, intro, body, audioSrc }
     ***********************/
    const MEDITATIONS_INDEX = [
      { id: "giving-and-receiving-love", title: "Giving and Receiving Love", intro: "A gentle practice of offering and receiving warmth, even through difficulty.", path: "assets/meditations/giving-and-receiving-love.json" },
      { id: "gentle-gratitude",          title: "A Gentle Practice of Gratitude", intro: "A small, unforced gratitude practice ‚Äî calm and simple.", path: "assets/meditations/gentle-gratitude.json" },
      { id: "making-space",             title: "Making Space for One Another", intro: "A reflection on warmth, space, and the healing nature of giving.", path: "assets/meditations/making-space.json" },
    ];

    // ‚úÖ Poetry Corner (loaded from one combined JSON)
    const POETRY_INDEX_PATH = "assets/poetry/poems.json";

    const LS_KEY = "journal_boo_entries_v1";
    const LS_SETTINGS = "journal_boo_settings_v1";
    const LS_EMAIL = "journal_boo_email_v1";
    const LS_THEME = "journal_boo_theme_v1";

    const state = {
      route: "home",
      musicOn: false,
      trackId: "devi-song",
      theme: "racing-green",

      freeText: "",

      meditationId: null,
      lastSavedEntryId: null,

      medCache: {},
      poetryCache: null,

      poetryCollectionId: null,
    };

    const viewEl = document.getElementById("view");
    const toastEl = document.getElementById("toast");
    const bgm = document.getElementById("bgm");
    const medPlayer = document.getElementById("medPlayer");
    const musicStateEl = document.getElementById("musicState");
    const musicTrackLabelEl = document.getElementById("musicTrackLabel");
    const themeSelectEl = document.getElementById("themeSelect");

    document.getElementById("btnHome").addEventListener("click", () => go("home"));
    document.getElementById("btnJournal").addEventListener("click", () => go("journal"));

    document.getElementById("privacyLink")?.addEventListener("click", (e) => {
      e.preventDefault();
      go("privacy");
    });

    document.getElementById("btnMusicToggle").addEventListener("click", () => {
      setMusicOn(!state.musicOn);
      toast(state.musicOn ? "Music on." : "Music off.");
    });

    document.getElementById("btnMusicNext").addEventListener("click", () => {
      cycleTrack();
      if (state.musicOn) fadeToTrack(state.trackId);
      toast("Changed music.");
    });

    /***********************
     * ‚úÖ NEW: Boo Writer "page possessed" wiring
     * Only triggers when clicking the Boo Writer icon (top right)
     ***********************/
    const booBtn = document.getElementById("btnBooWriter");

    let possessTimer = null;
    let possessed = false;

    function clearPossession(){
      clearTimeout(possessTimer);
      possessTimer = null;
      possessed = false;
      document.body.classList.remove("has-possessed");
    }

    function isReducedMotion(){
      return window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
    }

    function possessPage(){
      if (!booBtn) return;

      // Don't trigger while landing screen is active (optional safety)
      const welcomeActive = document.getElementById("jbWelcome")?.classList.contains("active");
      if (welcomeActive) return;

      if (possessed) return;
      possessed = true;

      // Reduced-motion: no animation, just a little acknowledgement
      if (isReducedMotion()){
        toast("Boo Writer says hi.");
        possessed = false;
        return;
      }

      // Trigger CSS animations
      document.body.classList.add("has-possessed");

      // Auto-clear after the wobble completes
      possessTimer = setTimeout(() => {
        clearPossession();
      }, 900);
    }

    // Click only
    booBtn?.addEventListener("click", (e) => {
      e.preventDefault();
      possessPage();
    });

    // If the user starts typing, cancel immediately (skippable)
    document.addEventListener("keydown", () => {
      if (!possessed) return;
      clearPossession();
    }, { capture: true });

    // If focus goes into an input/textarea, also cancel
    document.addEventListener("focusin", (e) => {
      if (!possessed) return;
      const t = e.target;
      if (t && (t.tagName === "TEXTAREA" || t.tagName === "INPUT" || t.isContentEditable)){
        clearPossession();
      }
    }, { capture: true });

    function loadTheme(){
      try{
        const t = localStorage.getItem(LS_THEME);
        if (t) state.theme = t;
      }catch{}
    }
    function saveTheme(){
      try{ localStorage.setItem(LS_THEME, state.theme); }catch{}
    }
    function applyTheme(){
      const t = state.theme || "racing-green";
      document.body.setAttribute("data-theme", t);
      if (themeSelectEl) themeSelectEl.value = t;
    }

    if (themeSelectEl){
      themeSelectEl.addEventListener("change", () => {
        state.theme = themeSelectEl.value;
        saveTheme();
        applyTheme();
        toast("Theme changed.");
      });
    }

    /* ‚úÖ Landing page wiring */
    const jbWelcome = document.getElementById("jbWelcome");
    const jbWelcomeTitle = document.getElementById("jbWelcomeTitle");
    const jbWelcomeSub = document.getElementById("jbWelcomeSub");
    const jbStartBtn = document.getElementById("jbStartBtn");
    const jbApp = document.getElementById("jbApp");

    function runWelcomeAnimation(){
      if (!jbWelcomeTitle || !jbWelcomeSub || !jbStartBtn) return;
      setTimeout(() => jbWelcomeTitle.classList.add("show"), 160);
      setTimeout(() => jbWelcomeSub.classList.add("show"), 520);
      setTimeout(() => jbStartBtn.classList.add("show"), 900);
    }

    function startApp(){
      if (!jbWelcome || !jbApp) return;
      jbWelcome.classList.remove("active");
      setTimeout(() => {
        jbWelcome.style.display = "none";
        jbApp.classList.remove("hidden");
        go("home").then(() => {});
      }, 520);
    }

    jbStartBtn?.addEventListener("click", startApp);
    document.addEventListener("keydown", (e) => {
      if (jbWelcome && jbWelcome.classList.contains("active") && (e.key === "Enter" || e.key === " ")){
        e.preventDefault();
        startApp();
      }
    });

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function nowIso(){ return new Date().toISOString(); }
    function prettyDate(iso){
      const d = new Date(iso);
      return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 1500);
    }

    function loadSettings(){
      try{
        const raw = localStorage.getItem(LS_SETTINGS);
        if (!raw) return;
        const s = JSON.parse(raw);
        if (typeof s.trackId === "string") state.trackId = s.trackId;
      }catch{}
    }
    function saveSettings(){
      try{
        localStorage.setItem(LS_SETTINGS, JSON.stringify({ trackId: state.trackId }));
      }catch{}
    }

    function loadEntries(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      }catch{
        return [];
      }
    }
    function saveEntries(entries){
      localStorage.setItem(LS_KEY, JSON.stringify(entries));
    }
    function addEntry(entry){
      const entries = loadEntries();
      entries.unshift(entry);
      saveEntries(entries);
      state.lastSavedEntryId = entry.id;
    }

    function loadEmail(){
      try{ return localStorage.getItem(LS_EMAIL) || ""; }catch{ return ""; }
    }
    function saveEmail(email){
      try{ localStorage.setItem(LS_EMAIL, email || ""); }catch{}
    }

    // --- Developer blog helpers ---
    async function fetchBlogJson(){
      const candidates = [
        "assets/blog/munchkinboo",
        "assets/blog/munchkinboo.json",
      ];

      let lastErr = null;

      for (const url of candidates){
        try{
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          return { url, data };
        }catch(err){
          lastErr = err;
        }
      }
      throw lastErr || new Error("Unable to load blog JSON.");
    }

    function normalizeBlogPosts(data){
      const posts = Array.isArray(data) ? data
        : (data && Array.isArray(data.posts)) ? data.posts
        : (data && (data.title || data.body || data.content || data.text)) ? [data]
        : [];

      return posts.map((p, idx) => ({
        id: String(p.id ?? idx),
        title: String(p.title ?? "Untitled"),
        date: p.date ? String(p.date) : (p.createdAt ? String(p.createdAt) : ""),
        body: String(p.body ?? p.content ?? p.text ?? ""),
      }));
    }

    /***********************
     * ‚úÖ JSON helpers (meditations + poetry)
     ***********************/
    async function fetchJsonWithCandidates(baseOrPath){
      const candidates = [];
      if (baseOrPath.endsWith(".json")) {
        candidates.push(baseOrPath);
      } else {
        candidates.push(baseOrPath);
        candidates.push(baseOrPath + ".json");
      }

      let lastErr = null;
      for (const url of candidates){
        try{
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          return { url, data };
        }catch(err){
          lastErr = err;
        }
      }
      throw lastErr || new Error("Unable to load JSON.");
    }

    async function loadMeditationById(id){
      if (state.medCache[id]) return state.medCache[id];

      const meta = MEDITATIONS_INDEX.find(m => m.id === id);
      if (!meta) throw new Error("Meditation not found.");

      const { data } = await fetchJsonWithCandidates(meta.path);
      const med = {
        id,
        title: String(data.title ?? meta.title ?? "Meditation"),
        intro: String(data.intro ?? meta.intro ?? ""),
        body: String(data.body ?? data.text ?? ""),
        audioSrc: data.audioSrc ? String(data.audioSrc) : "",
      };

      state.medCache[id] = med;
      return med;
    }

    function normalizePoetryData(raw){
      let collections = [];

      if (Array.isArray(raw)) {
        collections = raw;
      } else if (raw && Array.isArray(raw.collections)) {
        collections = raw.collections;
      } else if (raw && Array.isArray(raw.poems) && Array.isArray(raw.collections)) {
        collections = raw.collections;
      } else if (raw && Array.isArray(raw.poems)) {
        collections = [{ id: "poems", title: "Poems", poems: raw.poems }];
      } else {
        collections = [];
      }

      collections = collections.map((c, idx) => {
        const poemsArr = Array.isArray(c.poems) ? c.poems : (Array.isArray(c.items) ? c.items : []);
        const poems = poemsArr.map((p, jdx) => ({
          id: String(p.id ?? jdx),
          title: String(p.title ?? p.name ?? "Untitled"),
          text: String(p.text ?? p.body ?? p.content ?? ""),
        }));

        return {
          id: String(c.id ?? idx),
          title: String(c.title ?? c.name ?? "Collection"),
          poems,
        };
      });

      return { collections };
    }

    async function loadPoetryIndex(){
      if (state.poetryCache) return state.poetryCache;
      const { data } = await fetchJsonWithCandidates(POETRY_INDEX_PATH);
      const normalized = normalizePoetryData(data);
      state.poetryCache = normalized;
      return normalized;
    }

    // --- Music engine (gentle fade) ---
    let fadeTimer = null;

    function stopMeditationAudio(){
      medPlayer.pause();
      medPlayer.currentTime = 0;
    }

    function stopBackgroundMusic(){
      clearInterval(fadeTimer);
      bgm.pause();
      bgm.currentTime = 0;
      bgm.volume = 0;
    }

    function toggleMeditationAudio(src, btn){
      if (!src) {
        toast("Audio not available yet.");
        return;
      }

      if (!medPlayer.src || !medPlayer.src.endsWith(src)){
        medPlayer.src = src;
      }

      if (medPlayer.paused){
        stopBackgroundMusic();
        state.musicOn = false;
        syncMusicUI();

        medPlayer.play().catch(() => toast("Tap Play again to start."));
        btn.textContent = "Stop";
      } else {
        stopMeditationAudio();
        btn.textContent = "Play";
      }
    }

    function setMusicOn(on){
      if (!medPlayer.paused){
        stopMeditationAudio();
      }

      state.musicOn = on;
      syncMusicUI();

      if (!on){
        fadeOut(280);
        return;
      }
      ensurePlaying();
      fadeToTrack(state.trackId, 280);
    }

    function ensurePlaying(){
      if (!bgm.src) bgm.src = getTrack(state.trackId).src;
      if (bgm.paused){
        bgm.play().catch(() => toast("Tap Music again to start."));
      }
    }

    function setTrack(trackId){
      state.trackId = trackId;
      saveSettings();
      syncMusicUI();
    }

    function cycleTrack(){
      const idx = TRACKS.findIndex(t => t.id === state.trackId);
      const next = TRACKS[(idx + 1 + TRACKS.length) % TRACKS.length];
      setTrack(next.id);
    }

    function getTrack(trackId){
      return TRACKS.find(t => t.id === trackId) || TRACKS[0];
    }

    function fadeToTrack(trackId, ms=320){
      const t = getTrack(trackId);
      const targetSrc = t.src;

      if (bgm.src && bgm.src.endsWith(targetSrc)){
        ensurePlaying();
        fadeIn(ms);
        return;
      }

      clearInterval(fadeTimer);
      const startVol = bgm.paused ? 0 : bgm.volume;
      const steps = 12;
      const stepMs = Math.max(16, Math.floor(ms / steps));
      let i = 0;

      fadeTimer = setInterval(() => {
        i++;
        bgm.volume = Math.max(0, startVol * (1 - i/steps));
        if (i >= steps){
          clearInterval(fadeTimer);
          bgm.src = targetSrc;
          bgm.volume = 0;
          ensurePlaying();
          fadeIn(ms);
        }
      }, stepMs);
    }

    function fadeIn(ms=320){
      clearInterval(fadeTimer);
      if (state.musicOn) ensurePlaying();

      const steps = 12;
      const stepMs = Math.max(16, Math.floor(ms / steps));
      let i = 0;

      fadeTimer = setInterval(() => {
        i++;
        bgm.volume = Math.min(0.55, (i/steps) * 0.55);
        if (i >= steps) clearInterval(fadeTimer);
      }, stepMs);
    }

    function fadeOut(ms=320){
      clearInterval(fadeTimer);
      const steps = 12;
      const stepMs = Math.max(16, Math.floor(ms / steps));
      const startVol = bgm.paused ? 0 : bgm.volume;
      let i = 0;

      fadeTimer = setInterval(() => {
        i++;
        bgm.volume = Math.max(0, startVol * (1 - i/steps));
        if (i >= steps){
          clearInterval(fadeTimer);
          bgm.pause();
        }
      }, stepMs);
    }

    function syncMusicUI(){
      musicStateEl.textContent = state.musicOn ? "On" : "Off";
      musicTrackLabelEl.textContent = getTrack(state.trackId).label;
    }

    // --- Fade helpers ---
    function fadeInView(){ requestAnimationFrame(() => viewEl.classList.add("show")); }
    function fadeOutView(){ viewEl.classList.remove("show"); }
    function wait(ms){ return new Promise(res => setTimeout(res, ms)); }

    async function setViewHtml(html, {fade=true}={}){
      if (fade){
        fadeOutView();
        await wait(140);
      }
      viewEl.innerHTML = html;
      viewEl.classList.remove("show");
      await wait(10);
      fadeInView();
    }

    function composeEmail(to, subject, body){
      const url =
        "mailto:" + encodeURIComponent(to) +
        "?subject=" + encodeURIComponent(subject) +
        "&body=" + encodeURIComponent(body);
      window.location.href = url;
    }

    function getEntryById(id){
      const entries = loadEntries();
      return entries.find(e => e.id === id) || null;
    }

    async function go(route, payload={}){
      stopMeditationAudio();
      state.route = route;

      if (route === "meditation" && payload.meditationId){
        state.meditationId = payload.meditationId;
      }

      if (route === "poetryCollection" && payload.collectionId){
        state.poetryCollectionId = payload.collectionId;
      }

      await render();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    async function render(){
      switch(state.route){
        case "home": return renderHome();
        case "free": return renderFree();
        case "completeFree": return renderCompleteFree();
        case "medList": return renderMeditationList();
        case "meditation": return renderMeditation(state.meditationId);
        case "completeMeditation": return renderCompleteMeditation();
        case "poetry": return renderPoetryHome();
        case "poetryCollection": return renderPoetryCollection(state.poetryCollectionId);
        case "journal": return renderJournal();
        case "done": return renderDone();
        case "blog": return renderBlog();
        case "privacy": return renderPrivacy();
        default: return renderHome();
      }
    }

    async function renderPrivacy(){
      await setViewHtml(`
        <p class="kicker">Privacy & data use</p>
        <h2 class="title">Your privacy matters here.</h2>

        <div class="med-box">
Journal Boo does not collect, store, or transmit any personal or sensitive information about you.

All journal entries you create are saved only in your own browser, using local storage. This means:

‚Ä¢ Your writing never leaves your device
‚Ä¢ Journal Boo cannot see, read, or access your entries
‚Ä¢ Nothing is uploaded to a server
‚Ä¢ Nothing is shared with third parties

If you clear your browser data, use private browsing, or switch devices, your saved journal entries will no longer be available ‚Äî because they were never stored anywhere else.

The optional background music and written meditations are delivered as static files only.

If you choose to email an entry to yourself, Journal Boo simply opens your email app with the text filled in. The message is sent only by you, through your own email provider.

Journal Boo is designed to be a quiet, private space for reflection ‚Äî not a platform that tracks you.
        </div>

        <div class="row" style="margin-top:16px;">
          <button class="btn primary" id="backHome">Home</button>
          <button class="btn" id="backJournal">My Journal</button>
        </div>
      `);

      document.getElementById("backHome").addEventListener("click", () => go("home"));
      document.getElementById("backJournal").addEventListener("click", () => go("journal"));
    }

    /***********************
     * ‚úÖ UPDATED HOME
     * - removes "Hi, I'm Journal Boo..." title/subtitle
     * - adds fade-in question + large left tile + stacked right tiles
     * - all shimmer/pop handled in CSS above
     ***********************/
    async function renderHome(){
      await setViewHtml(`
        <div class="home-qfade" id="homeQuestion">
          <h2 class="home-question">What would you like to do today?</h2>
        </div>

        <div class="home-hero" role="navigation" aria-label="Home actions">
          <!-- Left: Big tile -->
          <div class="hero-tile hero-big" data-route="free" tabindex="0" role="button" aria-label="Free writing">
            <div class="hero-glow" aria-hidden="true"></div>
            <div class="hero-body">
              <div class="hero-icon" aria-hidden="true"></div>
              <div class="hero-text">
                <h3 class="hero-title">Free writing</h3>
                <p class="hero-sub">Open your journal and let it flow ‚Äî no prompts, no pressure.</p>
              </div>
            </div>
          </div>

          <!-- Right: stacked small tiles -->
          <div class="home-stack">
            <div class="hero-tile" data-route="medList" tabindex="0" role="button" aria-label="Meditations">
              <div class="hero-glow" aria-hidden="true"></div>
              <div class="hero-body">
                <div class="hero-icon" aria-hidden="true">ü´ß</div>
                <div class="hero-text">
                  <h3 class="hero-title">Meditations</h3>
                  <p class="hero-sub">Choose a calm written meditation to read at your own pace.</p>
                </div>
              </div>
            </div>

            <div class="hero-tile" data-route="poetry" tabindex="0" role="button" aria-label="Poetry Corner">
              <div class="hero-glow" aria-hidden="true"></div>
              <div class="hero-body">
                <div class="hero-icon" aria-hidden="true">ü™∂</div>
                <div class="hero-text">
                  <h3 class="hero-title">Poetry Corner</h3>
                  <p class="hero-sub">Gentle poems ‚Äî calm, kind, and comforting.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="list">
          <div class="entry" id="blogLink" style="cursor:pointer;">
            <div class="meta">
              <span>Munchkin Boo‚Äôs  private journal‚Ä¶ Keep out!</span>
              <span></span>
            </div>
            <p class="preview"></p>
          </div>
        </div>
      `);

      // fade-in question
      const q = document.getElementById("homeQuestion");
      requestAnimationFrame(() => q?.classList.add("show"));

      // click wiring
      viewEl.querySelectorAll(".hero-tile").forEach(el => {
        const route = el.getAttribute("data-route");
        el.addEventListener("click", () => go(route));
        el.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " "){
            e.preventDefault();
            go(route);
          }
        });
      });

      const blogLink = document.getElementById("blogLink");
      if (blogLink) blogLink.addEventListener("click", () => go("blog"));
    }

    async function renderBlog(){
      await setViewHtml(`
        <p class="kicker"></p>
        <h2 class="title">Munchkin Boo‚Äôs private journal‚Ä¶</h2>
        <p class="subtitle"></p>

        <div class="list" id="blogList">
          <div class="entry">
            <div class="meta"><span>Loading‚Ä¶</span><span></span></div>
            <p class="preview">Fetching posts‚Ä¶</p>
          </div>
        </div>

        <div class="divider"></div>
        <div class="row">
          <button class="btn primary" id="backHome">Home</button>
          <button class="btn" id="backJournal">My Journal</button>
        </div>
      `);

      document.getElementById("backHome").addEventListener("click", () => go("home"));
      document.getElementById("backJournal").addEventListener("click", () => go("journal"));

      const listEl = document.getElementById("blogList");

      try{
        const { data } = await fetchBlogJson();
        const posts = normalizeBlogPosts(data);

        if (!posts.length){
          listEl.innerHTML = `
            <div class="entry">
              <div class="meta"><span>No posts found</span><span></span></div>
              <p class="preview">Your JSON loaded, but it didn‚Äôt contain any posts.</p>
            </div>
          `;
          return;
        }

        listEl.innerHTML = "";
        posts.forEach(p => {
          const div = document.createElement("div");
          div.className = "entry";

          let right = "";
          if (p.date){
            const asDate = new Date(p.date);
            right = isNaN(asDate.getTime()) ? p.date : prettyDate(asDate.toISOString());
          }

          div.innerHTML = `
            <div class="meta">
              <span>${escapeHtml(p.title)}</span>
              <span>${escapeHtml(right)}</span>
            </div>
            <p class="preview">${escapeHtml(p.body || "")}</p>
          `;
          listEl.appendChild(div);
        });
      }catch(err){
        listEl.innerHTML = `
          <div class="entry">
            <div class="meta"><span>Couldn‚Äôt load blog</span><span></span></div>
            <p class="preview">${escapeHtml(err?.message || "Unknown error")}</p>
          </div>
        `;
      }
    }

    async function renderFree(){
      await setViewHtml(`
        <p class="kicker">Free writing</p>
        <h2 class="title">Take your time.</h2>
        <p class="subtitle">Write freely. No prompts. No pressure. Your work saves when you finish.</p>

        <textarea id="freeText" rows="14" placeholder="Start anywhere...">${escapeHtml(state.freeText || "")}</textarea>

        <div class="row" style="margin-top:14px;">
          <button class="btn primary" id="btnFinishFree">I‚Äôm done for now</button>
          <button class="btn ghost" id="btnBackHome">Back</button>
        </div>
      `);

      const ta = document.getElementById("freeText");
      ta.addEventListener("input", () => { state.freeText = ta.value; });

      document.getElementById("btnFinishFree").addEventListener("click", async () => {
        const text = (state.freeText || "").trim();
        if (text.length){
          addEntry({
            id: crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2),
            createdAt: nowIso(),
            type: "Free writing",
            mood: null,
            content: text,
          });
          toast("Saved.");
        } else {
          toast("Nothing to save ‚Äî that‚Äôs okay.");
        }
        state.freeText = "";
        await go("completeFree");
      });

      document.getElementById("btnBackHome").addEventListener("click", () => go("home"));
    }

    async function renderCompleteFree(){
      await setViewHtml(`
        <h2 class="title">This is really thoughtful work.</h2>
        <p class="subtitle">What would you like to do next?</p>

        <div class="row">
          <button class="btn primary" id="btnGoMeditation">Unwinding meditation</button>
          <button class="btn" id="btnDone">I‚Äôm done for now</button>
        </div>
      `);

      document.getElementById("btnGoMeditation").addEventListener("click", () => go("medList"));
      document.getElementById("btnDone").addEventListener("click", () => go("done"));
    }

    /***********************
     * ‚úÖ Meditations list + detail now from JSON
     ***********************/
    async function renderMeditationList(){
      const cards = MEDITATIONS_INDEX.map(m => `
        <div class="option" data-med="${escapeHtml(m.id)}">
          <h3>${escapeHtml(m.title)}</h3>
          <p>${escapeHtml(m.intro || "A calm meditation to read at your own pace.")}</p>
        </div>
      `).join("");

      await setViewHtml(`
        <p class="kicker">Meditations</p>
        <h2 class="title">Welcome.</h2>
        <p class="subtitle">
          You can choose a meditation that feels right for you right now.
          There‚Äôs no wrong choice ‚Äî just follow what you need.
        </p>

        <div class="option-grid">
          ${cards}
        </div>

        <div class="divider"></div>
        <div class="row">
          <button class="btn ghost" id="back">Back</button>
        </div>
      `);

      viewEl.querySelectorAll(".option").forEach(el => {
        el.addEventListener("click", () => go("meditation", { meditationId: el.dataset.med }));
      });
      document.getElementById("back").addEventListener("click", () => go("home"));
    }

    async function renderMeditation(medId){
      try{
        const med = await loadMeditationById(medId);

        const audioBlock = med.audioSrc ? `
          <div class="audio-player">
            <div class="label">${escapeHtml(med.title)}</div>
            <button class="btn" id="toggleMedAudio">Play</button>
          </div>
        ` : "";

        await setViewHtml(`
          <p class="kicker">Meditation</p>
          <h2 class="title">${escapeHtml(med.title)}</h2>
          <p class="subtitle">${escapeHtml(med.intro || "Take your time reading. Move at your own pace.")}</p>

          <div class="fade" id="medfade">
            ${audioBlock}
            <div class="med-box">${escapeHtml(med.body || "")}</div>
          </div>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="finished">I‚Äôm finished</button>
            <button class="btn" id="choose">Choose another</button>
            <button class="btn ghost" id="quit">I‚Äôm done for now</button>
          </div>
        `);

        requestAnimationFrame(() => document.getElementById("medfade")?.classList.add("show"));

        if (med.audioSrc){
          const btn = document.getElementById("toggleMedAudio");
          btn.addEventListener("click", () => toggleMeditationAudio(med.audioSrc, btn));
          medPlayer.onended = () => { btn.textContent = "Play"; };
        } else {
          medPlayer.onended = null;
        }

        document.getElementById("finished").addEventListener("click", () => go("completeMeditation"));
        document.getElementById("choose").addEventListener("click", () => go("medList"));
        document.getElementById("quit").addEventListener("click", () => go("done"));
      }catch(err){
        await setViewHtml(`
          <p class="kicker">Meditation</p>
          <h2 class="title">Couldn‚Äôt load meditation</h2>
          <p class="subtitle">${escapeHtml(err?.message || "Unknown error")}</p>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="backList">Back to list</button>
            <button class="btn ghost" id="home">Home</button>
          </div>
        `);

        document.getElementById("backList").addEventListener("click", () => go("medList"));
        document.getElementById("home").addEventListener("click", () => go("home"));
      }
    }

    async function renderCompleteMeditation(){
      await setViewHtml(`
        <h2 class="title">Thanks for taking this time for yourself.</h2>
        <p class="subtitle">What would you like to do next?</p>

        <div class="row">
          <button class="btn primary" id="toFree">Free writing</button>
          <button class="btn ghost" id="done">I‚Äôm done for now</button>
        </div>
      `);

      document.getElementById("toFree").addEventListener("click", () => go("free"));
      document.getElementById("done").addEventListener("click", () => go("done"));
    }

    /***********************
     * ‚úÖ Poetry Corner (from JSON)
     ***********************/
    async function renderPoetryHome(){
      await setViewHtml(`
        <p class="kicker">Poetry Corner</p>
        <h2 class="title">A small place to soften.</h2>
        <p class="subtitle">Choose a collection. Read slowly. Take what you need.</p>

        <div class="list" id="poetryCollections">
          <div class="entry">
            <div class="meta"><span>Loading‚Ä¶</span><span></span></div>
            <p class="preview">Fetching poems‚Ä¶</p>
          </div>
        </div>

        <div class="divider"></div>
        <div class="row">
          <button class="btn primary" id="backHome">Home</button>
        </div>
      `);

      document.getElementById("backHome").addEventListener("click", () => go("home"));

      const listEl = document.getElementById("poetryCollections");

      try{
        const { collections } = await loadPoetryIndex();

        if (!collections.length){
          listEl.innerHTML = `
            <div class="entry">
              <div class="meta"><span>No collections found</span><span></span></div>
              <p class="preview">Your poems JSON loaded, but it didn‚Äôt contain any collections.</p>
            </div>
          `;
          return;
        }

        listEl.innerHTML = "";
        collections.forEach(c => {
          const div = document.createElement("div");
          div.className = "entry";
          div.style.cursor = "pointer";
          div.innerHTML = `
            <div class="meta">
              <span>${escapeHtml(c.title)}</span>
              <span>${escapeHtml(String(c.poems?.length || 0))} poems</span>
            </div>
            <p class="preview">${escapeHtml((c.poems?.[0]?.title ? ("Includes: " + c.poems[0].title) : "A gentle collection."))}</p>
          `;
          div.addEventListener("click", () => go("poetryCollection", { collectionId: c.id }));
          listEl.appendChild(div);
        });
      }catch(err){
        listEl.innerHTML = `
          <div class="entry">
            <div class="meta"><span>Couldn‚Äôt load poems</span><span></span></div>
            <p class="preview">${escapeHtml(err?.message || "Unknown error")}</p>
          </div>
        `;
      }
    }

    async function renderPoetryCollection(collectionId){
      await setViewHtml(`
        <p class="kicker">Poetry Corner</p>
        <h2 class="title">Loading‚Ä¶</h2>
        <p class="subtitle">Just a moment.</p>

        <div class="divider"></div>
        <div class="row">
          <button class="btn primary" id="backPoetry">Back</button>
          <button class="btn ghost" id="home">Home</button>
        </div>
      `, { fade: true });

      try{
        const { collections } = await loadPoetryIndex();
        const col = collections.find(c => c.id === collectionId) || collections[0];

        const poemsHtml = (col.poems || []).map(p => `
          <div class="entry">
            <div class="meta">
              <span>${escapeHtml(p.title || "Untitled")}</span>
              <span></span>
            </div>
            <p class="preview">${escapeHtml(p.text || "")}</p>
          </div>
        `).join("");

        await setViewHtml(`
          <p class="kicker">Poetry Corner</p>
          <h2 class="title">${escapeHtml(col.title)}</h2>
          <p class="subtitle">Read slowly. Pause whenever you want.</p>

          <div class="list">
            ${poemsHtml || `
              <div class="entry">
                <div class="meta"><span>No poems</span><span></span></div>
                <p class="preview">This collection doesn‚Äôt contain any poems yet.</p>
              </div>
            `}
          </div>

          <div class="divider"></div>
          <div class="row">
            <button class="btn primary" id="backPoetry">Back to collections</button>
            <button class="btn ghost" id="home">Home</button>
          </div>
        `);

        document.getElementById("backPoetry").addEventListener("click", () => go("poetry"));
        document.getElementById("home").addEventListener("click", () => go("home"));
      }catch(err){
        await setViewHtml(`
          <p class="kicker">Poetry Corner</p>
          <h2 class="title">Couldn‚Äôt load collection</h2>
          <p class="subtitle">${escapeHtml(err?.message || "Unknown error")}</p>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="backPoetry">Back</button>
            <button class="btn ghost" id="home">Home</button>
          </div>
        `);

        document.getElementById("backPoetry").addEventListener("click", () => go("poetry"));
        document.getElementById("home").addEventListener("click", () => go("home"));
      }
    }

    async function renderDone(){
      const entries = loadEntries();
      const email = loadEmail();
      const defaultId = state.lastSavedEntryId || (entries[0]?.id || "");

      const options = entries.slice(0, 30).map(e => {
        const label = `${e.type} ‚Äî ${prettyDate(e.createdAt)}${e.mood ? " ‚Ä¢ " + e.mood : ""}`;
        const selected = e.id === defaultId ? "selected" : "";
        return `<option value="${escapeHtml(e.id)}" ${selected}>${escapeHtml(label)}</option>`;
      }).join("");

      await setViewHtml(`
        <h2 class="title">You can rest now, if you want.</h2>
        <p class="subtitle">If you‚Äôd like, you can email yourself a saved entry.</p>

        <div class="fade" id="donefade">
          <p class="kicker">Your email address</p>
          <input type="email" id="email" placeholder="name@example.com" value="${escapeHtml(email)}" />

          <div style="height:12px;"></div>

          <p class="kicker">Choose an entry</p>
          <select id="entrySelect">
            ${options || `<option value="">No saved entries yet</option>`}
          </select>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="sendEmail">Compose email</button>
            <button class="btn" id="goHome">Home</button>
            <button class="btn ghost" id="goJournal">My Journal</button>
          </div>

          <p class="hint">This opens your email app with the entry filled in. You can review it, then press Send.</p>
        </div>
      `);

      requestAnimationFrame(() => document.getElementById("donefade")?.classList.add("show"));

      document.getElementById("goHome").addEventListener("click", () => go("home"));
      document.getElementById("goJournal").addEventListener("click", () => go("journal"));

      document.getElementById("sendEmail").addEventListener("click", () => {
        const emailEl = document.getElementById("email");
        const entryId = document.getElementById("entrySelect").value;

        const to = (emailEl.value || "").trim();
        if (!to){
          toast("Add an email address first.");
          emailEl.focus();
          return;
        }
        saveEmail(to);

        if (!entryId){
          toast("No entry selected.");
          return;
        }

        const e = getEntryById(entryId);
        if (!e){
          toast("Couldn‚Äôt find that entry.");
          return;
        }

        const subject = `Journal Boo ‚Äî ${e.type} (${new Date(e.createdAt).toLocaleDateString()})`;
        const body =
`Hi,

Here‚Äôs a saved entry from Journal Boo.

${e.type}${e.mood ? " ‚Ä¢ " + e.mood : ""}
${prettyDate(e.createdAt)}

--------------------

${e.content}

--------------------

¬© James Ritchie 2025`;

        composeEmail(to, subject, body);
      });
    }

    async function renderJournal(){
      const entries = loadEntries();

      await setViewHtml(`
        <p class="kicker">My Journal</p>
        <h2 class="title">Your saved writing</h2>
        <p class="subtitle">Everything here is stored locally in this browser.</p>

        <div class="row">
          <button class="btn primary" id="newFree">New free writing</button>
          <button class="btn" id="toDone">I‚Äôm done for now</button>
          <button class="btn danger" id="clearAll">Clear all (local)</button>
        </div>

        <div class="divider"></div>
        <div class="list" id="entryList"></div>
      `);

      document.getElementById("newFree").addEventListener("click", () => go("free"));
      document.getElementById("toDone").addEventListener("click", () => go("done"));

      document.getElementById("clearAll").addEventListener("click", () => {
        const ok = confirm("Clear all saved entries from this browser?");
        if (!ok) return;
        saveEntries([]);
        toast("Cleared.");
        renderJournal();
      });

      const list = document.getElementById("entryList");
      if (!entries.length){
        list.innerHTML = `
          <div class="entry">
            <div class="meta"><span>Nothing saved yet</span><span></span></div>
            <p class="preview">When you finish a writing session, it will appear here.</p>
          </div>
        `;
        return;
      }

      entries.forEach(e => {
        const div = document.createElement("div");
        div.className = "entry";
        const mood = e.mood ? ` ‚Ä¢ ${e.mood}` : "";
        div.innerHTML = `
          <div class="meta">
            <span>${escapeHtml(e.type)}${mood}</span>
            <span>${prettyDate(e.createdAt)}</span>
          </div>
          <p class="preview">${escapeHtml(preview(e.content, 420))}</p>
          <div class="row" style="margin-top:10px;">
            <button class="btn" data-open="${escapeHtml(e.id)}">Open</button>
            <button class="btn danger" data-del="${escapeHtml(e.id)}">Delete</button>
          </div>
        `;
        list.appendChild(div);
      });

      list.querySelectorAll("button[data-open]").forEach(btn => {
        btn.addEventListener("click", () => openEntry(btn.getAttribute("data-open")));
      });
      list.querySelectorAll("button[data-del]").forEach(btn => {
        btn.addEventListener("click", () => deleteEntry(btn.getAttribute("data-del")));
      });

      function preview(txt, max){
        const s = (txt || "").trim();
        if (s.length <= max) return s;
        return s.slice(0, max).trim() + "‚Ä¶";
      }

      async function openEntry(id){
        const entries = loadEntries();
        const e = entries.find(x => x.id === id);
        if (!e) return;

        await setViewHtml(`
          <p class="kicker">My Journal</p>
          <h2 class="title">${escapeHtml(e.type)}</h2>
          <p class="subtitle">${prettyDate(e.createdAt)}${e.mood ? " ‚Ä¢ " + escapeHtml(e.mood) : ""}</p>

          <div class="med-box">${escapeHtml(e.content)}</div>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="backList">Back</button>
            <button class="btn" id="emailThis">Email this</button>
            <button class="btn danger" id="delThis">Delete</button>
            <button class="btn ghost" id="home">Home</button>
          </div>
        `);

        document.getElementById("backList").addEventListener("click", () => go("journal"));
        document.getElementById("home").addEventListener("click", () => go("home"));

        document.getElementById("delThis").addEventListener("click", () => deleteEntry(id));

        document.getElementById("emailThis").addEventListener("click", () => {
          state.lastSavedEntryId = e.id;
          go("done");
        });
      }

      function deleteEntry(id){
        const ok = confirm("Delete this entry?");
        if (!ok) return;
        const entries = loadEntries().filter(e => e.id !== id);
        saveEntries(entries);
        toast("Deleted.");
        go("journal");
      }
    }

    (function init(){
      loadSettings();

      // ‚úÖ Theme: racing-green default, but saved preference still wins
      loadTheme();
      applyTheme();

      syncMusicUI();

      state.musicOn = false;
      bgm.pause();

      bgm.src = getTrack(state.trackId).src;
      bgm.volume = 0;

      viewEl.classList.remove("show");

      // ‚úÖ Pre-render home (app is hidden until Start)
      go("home").then(() => {});

      // ‚úÖ Run landing fades
      runWelcomeAnimation();
    })();
  </script>
</body>
</html>
