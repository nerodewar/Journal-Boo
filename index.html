<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Journal Boo</title>
  <style>
    :root{
      --bg: #0f0f12;
      --text: #f1efe9;
      --muted: #b9b6ad;
      --muted2:#8f8b81;
      --accent:#c9a76a;

      --radius: 20px;
      --line: 1px solid rgba(255,255,255,.07);
      --shadow: 0 14px 38px rgba(0,0,0,.35);
      --font: ui-serif, Georgia, "Times New Roman", Times, serif;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin: 0;
      font-family: var(--font);
      background:
        radial-gradient(1100px 800px at 18% 0%, rgba(201,167,106,.10), transparent 58%),
        radial-gradient(900px 600px at 88% 12%, rgba(201,167,106,.07), transparent 60%),
        var(--bg);
      color: var(--text);
      letter-spacing: .1px;
    }

    .app{
      min-height: 100%;
      display:flex;
      justify-content:center;
      padding: 28px 14px 40px;
    }

    .shell{
      width: min(820px, 100%);
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 8px 4px;
      gap: 10px;
    }

    .brand{ display:flex; flex-direction:column; gap: 2px; }
    .brand h1{ margin:0; font-size:22px; font-weight:600; letter-spacing:.2px; }
    .brand p{ margin:0; color:var(--muted2); font-size:13px; line-height:1.35; }

    .top-actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .pill{
      border: var(--line);
      background: rgba(255,255,255,.03);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      color: var(--text);
      display:inline-flex;
      align-items:center;
      gap: 8px;
      cursor:pointer;
      user-select:none;
      transition: background .12s ease, transform .12s ease;
    }
    .pill:hover{ background: rgba(255,255,255,.05); transform: translateY(-1px); }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
      border: var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card-inner{ padding: 22px; }

    .title{
      font-size: 26px;
      margin: 0 0 10px;
      font-weight: 600;
      letter-spacing: .15px;
    }
    .subtitle{
      margin: 0 0 18px;
      color: var(--muted);
      line-height: 1.6;
      font-size: 16px;
    }

    .option-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 8px;
    }
    .option{
      border: var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding: 16px 16px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease;
    }
    .option:hover{ background: rgba(255,255,255,.05); transform: translateY(-1px); }
    .option h3{ margin: 0; font-size: 18px; font-weight: 600; }
    .option p{ margin: 6px 0 0; color: var(--muted); font-size: 14px; line-height: 1.5; }

    .row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }

    .btn{
      border: var(--line);
      background: rgba(255,255,255,.03);
      padding: 12px 14px;
      border-radius: 14px;
      font-size: 14px;
      cursor:pointer;
      color: var(--text);
      user-select:none;
      transition: background .12s ease, transform .12s ease;
    }
    .btn:hover{ background: rgba(255,255,255,.05); transform: translateY(-1px); }
    .btn.primary{
      background: rgba(201,167,106,.16);
      border: 1px solid rgba(201,167,106,.35);
    }
    .btn.primary:hover{ background: rgba(201,167,106,.22); }
    .btn.ghost{ background: transparent; }
    .btn.danger{
      border: 1px solid rgba(214,125,125,.35);
      background: rgba(214,125,125,.10);
    }

    .divider{
      height: 1px;
      background: rgba(255,255,255,.07);
      margin: 18px 0;
    }

    textarea, input[type="email"], select{
      width: 100%;
      border: var(--line);
      background: rgba(0,0,0,.16);
      border-radius: 16px;
      color: var(--text);
      padding: 12px 14px;
      font-family: var(--font);
      font-size: 16px;
      line-height: 1.6;
      outline: none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    textarea:focus, input:focus, select:focus{
      border-color: rgba(201,167,106,.45);
      box-shadow: 0 0 0 3px rgba(201,167,106,.10);
    }
    select { font-size: 15px; }

    .kicker{
      font-size: 14px;
      color: var(--muted);
      margin: 0 0 8px;
    }
    .hint{
      margin-top: 10px;
      color: var(--muted2);
      font-size: 13px;
      line-height: 1.45;
    }
    .small{ font-size: 12.5px; color: var(--muted2); }

    .stepbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin: 10px 0 14px;
    }
    .steps{ display:flex; gap: 6px; align-items:center; }
    .dot{
      width: 8px; height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.10);
    }
    .dot.on{
      background: rgba(201,167,106,.55);
      border-color: rgba(201,167,106,.45);
    }
    .steptext{
      color: var(--muted2);
      font-size: 13px;
      white-space: nowrap;
    }

    .fade{
      opacity: 0;
      transform: translateY(6px);
      transition: opacity .28s ease, transform .28s ease;
    }
    .fade.show{
      opacity: 1;
      transform: translateY(0);
    }

    .med-box{
      background: rgba(255,255,255,.02);
      border: var(--line);
      border-radius: 18px;
      padding: 18px;
      white-space: pre-wrap;
      line-height: 1.75;
      font-size: 16px;
    }

    /* âœ… Meditation audio player */
    .audio-player{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 10px;
      margin-bottom: 18px;
    }
    .audio-player .label{
      font-size: 14px;
      color: var(--muted);
    }
    .audio-player .btn{
      min-width: 140px;
      text-align: center;
    }

    .footer-note{
      color: var(--muted2);
      font-size: 12.5px;
      line-height: 1.45;
      padding: 0 4px;
    }

    .list{ display:grid; gap: 10px; margin-top: 8px; }
    .entry{
      border: var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 16px;
      padding: 14px 14px;
    }
    .entry .meta{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      color: var(--muted2);
      font-size: 12.5px;
      margin-bottom: 8px;
    }
    .entry .preview{
      margin: 0;
      color: var(--text);
      font-size: 15px;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease, transform .2s ease;
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(-4px); }

    @media (max-width: 520px){
      .title{ font-size: 23px; }
      .subtitle{ font-size: 15px; }
      .pill{ padding: 9px 10px; }
      .card-inner{ padding: 18px; }
    }
  </style>
</head>
    <script data-goatcounter="https://munchkin-boo.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
<body>
  <div class="app">
    <div class="shell">
      <header>
        <div class="brand">
          <h1>Journal Boo</h1>
          <p>a quiet companion for writing, reflection, and unwinding</p>
        </div>

        <div class="top-actions">
          <button class="pill" id="btnHome" title="Home">Home</button>
          <button class="pill" id="btnJournal" title="My Journal">My Journal</button>

          <button class="pill" id="btnMusicToggle" title="Toggle music">
            Music: <span id="musicState">Off</span>
          </button>
          <button class="pill" id="btnMusicNext" title="Change music">
            Track: <span id="musicTrackLabel">Deviâ€™s Song</span>
          </button>
        </div>
      </header>

      <main class="card">
        <div class="card-inner fade" id="view"></div>
      </main>

      <div class="footer-note">
        Your writing is saved locally in this browser. (V1)<br />
        Â© James Ritchie 2025
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <audio id="bgm" preload="auto" loop></audio>
  <!-- âœ… Meditation audio element -->
  <audio id="medPlayer" preload="none"></audio>

  <script>
    /***********************
     * Journal Boo (V1)
     * Fix included: buttons on opened saved entry page now work (await setViewHtml before binding handlers)
     ***********************/

    const TRACKS = [
      { id: "devi-song",       label: "Deviâ€™s Song",      src: "assets/music/devi-song.mp3" },
      { id: "labour-of-love",  label: "Labour Of Love",   src: "assets/music/labour-of-love.mp3" },
      { id: "crying-out",      label: "Crying Out",       src: "assets/music/crying-out.mp3" },
    ];

    const GUIDED_SETS = [
      {
        id: "values",
        title: "What matters most",
        questions: [
          "What is something important in your life right now?",
          "How do you feel about it?",
          "What do you understand about this part of your life right now?"
        ]
      },
      {
        id: "gratitude",
        title: "Gentle gratitude",
        questions: [
          "What is one small thing that helped you today?",
          "What did it feel like when you noticed it?",
          "How could you make a little space for more of that this week?"
        ]
      },
      {
        id: "stress",
        title: "Unpacking stress",
        questions: [
          "What has been weighing on you lately?",
          "Where do you notice it in your body or day-to-day life?",
          "What is one kind next step you could take (even a very small one)?"
        ]
      },
      {
        id: "selftalk",
        title: "Kind self-talk",
        questions: [
          "What have you been telling yourself lately?",
          "How does that inner voice make you feel?",
          "What would you rather hear from a kind and truthful voice?"
        ]
      },
      {
        id: "future",
        title: "Looking ahead",
        questions: [
          "What are you hoping for right now?",
          "What might be getting in the way?",
          "What would support you most in the next 24 hours?"
        ]
      }
    ];

    function pickGuidedSet(){
      return GUIDED_SETS[Math.floor(Math.random() * GUIDED_SETS.length)];
    }

    const LS_KEY = "journal_boo_entries_v1";
    const LS_SETTINGS = "journal_boo_settings_v1";
    const LS_EMAIL = "journal_boo_email_v1";

    const state = {
      route: "home",
      musicOn: false,
      trackId: "devi-song",

      freeText: "",

      guidedStep: 1,
      guidedSetId: null,
      guidedSetTitle: "",
      guidedQs: [],
      guidedA1: "",
      guidedA2: "",
      guidedA3: "",
      guidedMood: null,

      meditationId: null,
      lastSavedEntryId: null,
    };

    const viewEl = document.getElementById("view");
    const toastEl = document.getElementById("toast");
    const bgm = document.getElementById("bgm");
    const medPlayer = document.getElementById("medPlayer");
    const musicStateEl = document.getElementById("musicState");
    const musicTrackLabelEl = document.getElementById("musicTrackLabel");

    document.getElementById("btnHome").addEventListener("click", () => go("home"));
    document.getElementById("btnJournal").addEventListener("click", () => go("journal"));

    document.getElementById("btnMusicToggle").addEventListener("click", () => {
      setMusicOn(!state.musicOn);
      toast(state.musicOn ? "Music on." : "Music off.");
    });

    document.getElementById("btnMusicNext").addEventListener("click", () => {
      cycleTrack();
      if (state.musicOn) fadeToTrack(state.trackId);
      toast("Changed music.");
    });

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function nowIso(){ return new Date().toISOString(); }
    function prettyDate(iso){
      const d = new Date(iso);
      return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 1500);
    }

    function loadSettings(){
      try{
        const raw = localStorage.getItem(LS_SETTINGS);
        if (!raw) return;
        const s = JSON.parse(raw);
        if (typeof s.trackId === "string") state.trackId = s.trackId;
      }catch{}
    }
    function saveSettings(){
      try{
        localStorage.setItem(LS_SETTINGS, JSON.stringify({ trackId: state.trackId }));
      }catch{}
    }

    function loadEntries(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      }catch{
        return [];
      }
    }
    function saveEntries(entries){
      localStorage.setItem(LS_KEY, JSON.stringify(entries));
    }
    function addEntry(entry){
      const entries = loadEntries();
      entries.unshift(entry);
      saveEntries(entries);
      state.lastSavedEntryId = entry.id;
    }

    function loadEmail(){
      try{ return localStorage.getItem(LS_EMAIL) || ""; }catch{ return ""; }
    }
    function saveEmail(email){
      try{ localStorage.setItem(LS_EMAIL, email || ""); }catch{}
    }

    // --- Developer blog helpers ---
    async function fetchBlogJson(){
      const candidates = [
        "assets/blog/munchkinboo",
        "assets/blog/munchkinboo.json",
      ];

      let lastErr = null;

      for (const url of candidates){
        try{
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          return { url, data };
        }catch(err){
          lastErr = err;
        }
      }
      throw lastErr || new Error("Unable to load blog JSON.");
    }

    function normalizeBlogPosts(data){
      const posts = Array.isArray(data) ? data
        : (data && Array.isArray(data.posts)) ? data.posts
        : (data && (data.title || data.body || data.content || data.text)) ? [data]
        : [];

      return posts.map((p, idx) => ({
        id: String(p.id ?? idx),
        title: String(p.title ?? "Untitled"),
        date: p.date ? String(p.date) : (p.createdAt ? String(p.createdAt) : ""),
        body: String(p.body ?? p.content ?? p.text ?? ""),
      }));
    }

    // --- Music engine (gentle fade) ---
    let fadeTimer = null;

    // âœ… Meditation audio control
    function stopMeditationAudio(){
      medPlayer.pause();
      medPlayer.currentTime = 0;
    }

    // âœ… REQUIRED: hard-stop background music when meditation starts
    function stopBackgroundMusic(){
      clearInterval(fadeTimer);
      bgm.pause();
      bgm.currentTime = 0;
      bgm.volume = 0;
    }

    function toggleMeditationAudio(src, btn){
      if (!medPlayer.src || !medPlayer.src.endsWith(src)){
        medPlayer.src = src;
      }

      if (medPlayer.paused){
        stopBackgroundMusic();
        state.musicOn = false;
        syncMusicUI();

        medPlayer.play().catch(() => toast("Tap Play again to start."));
        btn.textContent = "Stop";
      } else {
        stopMeditationAudio();
        btn.textContent = "Play";
      }
    }

    function setMusicOn(on){
      // If meditation audio is playing, stop it before turning music on.
      if (!medPlayer.paused){
        stopMeditationAudio();
      }

      state.musicOn = on;
      syncMusicUI();

      if (!on){
        fadeOut(280);
        return;
      }
      ensurePlaying();
      fadeToTrack(state.trackId, 280);
    }

    function ensurePlaying(){
      if (!bgm.src) bgm.src = getTrack(state.trackId).src;
      if (bgm.paused){
        bgm.play().catch(() => toast("Tap Music again to start."));
      }
    }

    function setTrack(trackId){
      state.trackId = trackId;
      saveSettings();
      syncMusicUI();
    }

    function cycleTrack(){
      const idx = TRACKS.findIndex(t => t.id === state.trackId);
      const next = TRACKS[(idx + 1 + TRACKS.length) % TRACKS.length];
      setTrack(next.id);
    }

    function getTrack(trackId){
      return TRACKS.find(t => t.id === trackId) || TRACKS[0];
    }

    function fadeToTrack(trackId, ms=320){
      const t = getTrack(trackId);
      const targetSrc = t.src;

      if (bgm.src && bgm.src.endsWith(targetSrc)){
        ensurePlaying();
        fadeIn(ms);
        return;
      }

      clearInterval(fadeTimer);
      const startVol = bgm.paused ? 0 : bgm.volume;
      const steps = 12;
      const stepMs = Math.max(16, Math.floor(ms / steps));
      let i = 0;

      fadeTimer = setInterval(() => {
        i++;
        bgm.volume = Math.max(0, startVol * (1 - i/steps));
        if (i >= steps){
          clearInterval(fadeTimer);
          bgm.src = targetSrc;
          bgm.volume = 0;
          ensurePlaying();
          fadeIn(ms);
        }
      }, stepMs);
    }

    function fadeIn(ms=320){
      clearInterval(fadeTimer);
      if (state.musicOn) ensurePlaying();

      const steps = 12;
      const stepMs = Math.max(16, Math.floor(ms / steps));
      let i = 0;

      fadeTimer = setInterval(() => {
        i++;
        bgm.volume = Math.min(0.55, (i/steps) * 0.55);
        if (i >= steps) clearInterval(fadeTimer);
      }, stepMs);
    }

    function fadeOut(ms=320){
      clearInterval(fadeTimer);
      const steps = 12;
      const stepMs = Math.max(16, Math.floor(ms / steps));
      const startVol = bgm.paused ? 0 : bgm.volume;
      let i = 0;

      fadeTimer = setInterval(() => {
        i++;
        bgm.volume = Math.max(0, startVol * (1 - i/steps));
        if (i >= steps){
          clearInterval(fadeTimer);
          bgm.pause();
        }
      }, stepMs);
    }

    function syncMusicUI(){
      musicStateEl.textContent = state.musicOn ? "On" : "Off";
      musicTrackLabelEl.textContent = getTrack(state.trackId).label;
    }

    // --- Fade helpers ---
    function fadeInView(){ requestAnimationFrame(() => viewEl.classList.add("show")); }
    function fadeOutView(){ viewEl.classList.remove("show"); }
    function wait(ms){ return new Promise(res => setTimeout(res, ms)); }

    async function setViewHtml(html, {fade=true}={}){
      if (fade){
        fadeOutView();
        await wait(140);
      }
      viewEl.innerHTML = html;
      viewEl.classList.remove("show");
      await wait(10);
      fadeInView();
    }

    // --- Email compose (mailto:) ---
    function composeEmail(to, subject, body){
      const url =
        "mailto:" + encodeURIComponent(to) +
        "?subject=" + encodeURIComponent(subject) +
        "&body=" + encodeURIComponent(body);
      window.location.href = url;
    }

    function getEntryById(id){
      const entries = loadEntries();
      return entries.find(e => e.id === id) || null;
    }

    // --- Routing ---
    async function go(route, payload={}){
      // âœ… Stop meditation audio whenever navigating
      stopMeditationAudio();

      state.route = route;

      if (route === "guided" && !state.guidedQs.length){
        const set = pickGuidedSet();
        state.guidedSetId = set.id;
        state.guidedSetTitle = set.title;
        state.guidedQs = [...set.questions];
      }

      if (route === "meditation" && payload.meditationId){
        state.meditationId = payload.meditationId;
      }

      await render();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    async function render(){
      switch(state.route){
        case "home": return renderHome();
        case "free": return renderFree();
        case "completeFree": return renderCompleteFree();
        case "guided": return renderGuidedStepper();
        case "completeGuided": return renderCompleteGuided();
        case "medList": return renderMeditationList();
        case "meditation": return renderMeditation(state.meditationId);
        case "completeMeditation": return renderCompleteMeditation();
        case "journal": return renderJournal();
        case "done": return renderDone();
        case "blog": return renderBlog();
        default: return renderHome();
      }
    }

    async function renderHome(){
      await setViewHtml(`
        <h2 class="title">Hi, Iâ€™m Journal Boo.</h2>
        <p class="subtitle">Iâ€™m your personal journal companion. What would you like to do today?</p>

        <div class="option-grid">
          <div class="option" data-route="free">
            <h3>Free writing</h3>
            <p>Write freely about whateverâ€™s on your mind.</p>
          </div>

          <div class="option" data-route="guided">
            <h3>Guided journal</h3>
            <p>Gentle prompts, one step at a time.</p>
          </div>

          <div class="option" data-route="medList">
            <h3>Unwinding meditation</h3>
            <p>Choose a calm written meditation to read at your own pace.</p>
          </div>
        </div>

        <div class="divider"></div>

        <div class="list">
          <div class="entry" id="blogLink" style="cursor:pointer;">
            <div class="meta">
              <span>Munchkin Booâ€™s  private journalâ€¦ Keep out!</span>
              <span></span>
            </div>
            <p class="preview"></p>
          </div>
        </div>
      `);

      viewEl.querySelectorAll(".option").forEach(el => {
        el.addEventListener("click", () => go(el.dataset.route));
      });

      const blogLink = document.getElementById("blogLink");
      if (blogLink) blogLink.addEventListener("click", () => go("blog"));
    }

    async function renderBlog(){
      await setViewHtml(`
        <p class="kicker"></p>
        <h2 class="title">Munchkin Booâ€™s private journalâ€¦</h2>
        <p class="subtitle"></p>

        <div class="list" id="blogList">
          <div class="entry">
            <div class="meta"><span>Loadingâ€¦</span><span></span></div>
            <p class="preview">Fetching postsâ€¦</p>
          </div>
        </div>

        <div class="divider"></div>
        <div class="row">
          <button class="btn primary" id="backHome">Home</button>
          <button class="btn" id="backJournal">My Journal</button>
        </div>
      `);

      document.getElementById("backHome").addEventListener("click", () => go("home"));
      document.getElementById("backJournal").addEventListener("click", () => go("journal"));

      const listEl = document.getElementById("blogList");

      try{
        const { data } = await fetchBlogJson();
        const posts = normalizeBlogPosts(data);

        if (!posts.length){
          listEl.innerHTML = `
            <div class="entry">
              <div class="meta"><span>No posts found</span><span></span></div>
              <p class="preview">Your JSON loaded, but it didnâ€™t contain any posts.</p>
            </div>
          `;
          return;
        }

        listEl.innerHTML = "";
        posts.forEach(p => {
          const div = document.createElement("div");
          div.className = "entry";

          let right = "";
          if (p.date){
            const asDate = new Date(p.date);
            right = isNaN(asDate.getTime()) ? p.date : prettyDate(asDate.toISOString());
          }

          div.innerHTML = `
            <div class="meta">
              <span>${escapeHtml(p.title)}</span>
              <span>${escapeHtml(right)}</span>
            </div>
            <p class="preview">${escapeHtml(p.body || "")}</p>
          `;
          listEl.appendChild(div);
        });
      }catch(err){
        listEl.innerHTML = `
          <div class="entry">
            <div class="meta"><span>Couldnâ€™t load blog</span><span></span></div>
            <p class="preview">${escapeHtml(err?.message || "Unknown error")}</p>
          </div>
        `;
      }
    }

    async function renderFree(){
      await setViewHtml(`
        <p class="kicker">Free writing</p>
        <h2 class="title">Take your time.</h2>
        <p class="subtitle">Write freely. No prompts. No pressure. Your work saves when you finish.</p>

        <textarea id="freeText" rows="14" placeholder="Start anywhere...">${escapeHtml(state.freeText || "")}</textarea>

        <div class="row" style="margin-top:14px;">
          <button class="btn primary" id="btnFinishFree">Iâ€™m done for now</button>
          <button class="btn ghost" id="btnBackHome">Back</button>
        </div>
      `);

      const ta = document.getElementById("freeText");
      ta.addEventListener("input", () => { state.freeText = ta.value; });

      document.getElementById("btnFinishFree").addEventListener("click", async () => {
        const text = (state.freeText || "").trim();
        if (text.length){
          addEntry({
            id: crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2),
            createdAt: nowIso(),
            type: "Free writing",
            mood: null,
            content: text,
          });
          toast("Saved.");
        } else {
          toast("Nothing to save â€” thatâ€™s okay.");
        }
        state.freeText = "";
        await go("completeFree");
      });

      document.getElementById("btnBackHome").addEventListener("click", () => go("home"));
    }

    async function renderCompleteFree(){
      await setViewHtml(`
        <h2 class="title">This is really thoughtful work.</h2>
        <p class="subtitle">What would you like to do next?</p>

        <div class="row">
          <button class="btn primary" id="btnGoMeditation">Unwinding meditation</button>
          <button class="btn" id="btnDone">Iâ€™m done for now</button>
        </div>
      `);

      document.getElementById("btnGoMeditation").addEventListener("click", () => go("medList"));
      document.getElementById("btnDone").addEventListener("click", () => go("done"));
    }

    async function renderGuidedStepper(){
      const step = state.guidedStep;

      const intro = `
        <p class="kicker">Guided journal</p>
        <h2 class="title">Welcome to your guided journal.</h2>
        <p class="subtitle">
          This is a space where we can explore whatâ€™s important to you, notice how youâ€™re feeling, and gently reflect together.
        </p>
      `;

      const setLabel = state.guidedSetTitle
        ? `<p class="small" style="margin:-6px 0 14px;">Theme: ${escapeHtml(state.guidedSetTitle)}</p>`
        : "";

      const stepbar = `
        <div class="stepbar">
          <div class="steps" aria-label="steps">
            <div class="dot ${step>=1?'on':''}"></div>
            <div class="dot ${step>=2?'on':''}"></div>
            <div class="dot ${step>=3?'on':''}"></div>
          </div>
          <div class="steptext">Step ${Math.min(step,3)} of 3</div>
        </div>
      `;

      const [q1, q2, q3] = state.guidedQs.length ? state.guidedQs : pickGuidedSet().questions;

      if (step === 1){
        await setViewHtml(`
          ${intro}
          ${setLabel}
          ${stepbar}

          <div class="fade" id="qfade">
            <p class="subtitle" style="margin-bottom:10px;"><strong>${escapeHtml(q1)}</strong></p>
            <textarea id="a1" rows="10" placeholder="Write what comes...">${escapeHtml(state.guidedA1 || "")}</textarea>
          </div>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="next">Next</button>
            <button class="btn ghost" id="back">Back</button>
          </div>
        `);
        requestAnimationFrame(() => document.getElementById("qfade").classList.add("show"));

        const a1 = document.getElementById("a1");
        a1.addEventListener("input", () => state.guidedA1 = a1.value);

        document.getElementById("next").addEventListener("click", () => { state.guidedStep = 2; go("guided"); });
        document.getElementById("back").addEventListener("click", () => go("home"));
        return;
      }

      if (step === 2){
        await setViewHtml(`
          ${intro}
          ${setLabel}
          ${stepbar}

          <div class="fade" id="qfade">
            <p class="subtitle" style="margin-bottom:10px;"><strong>${escapeHtml(q2)}</strong></p>
            <textarea id="a2" rows="10" placeholder="Take your time...">${escapeHtml(state.guidedA2 || "")}</textarea>
          </div>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="next">Next</button>
            <button class="btn" id="prev">Previous</button>
            <button class="btn ghost" id="home">Home</button>
          </div>
        `);
        requestAnimationFrame(() => document.getElementById("qfade").classList.add("show"));

        const a2 = document.getElementById("a2");
        a2.addEventListener("input", () => state.guidedA2 = a2.value);

        document.getElementById("next").addEventListener("click", () => { state.guidedStep = 3; go("guided"); });
        document.getElementById("prev").addEventListener("click", () => { state.guidedStep = 1; go("guided"); });
        document.getElementById("home").addEventListener("click", () => go("home"));
        return;
      }

      if (step === 3){
        await setViewHtml(`
          ${intro}
          ${setLabel}
          ${stepbar}

          <div class="fade" id="qfade">
            <p class="subtitle" style="margin-bottom:10px;"><strong>${escapeHtml(q3)}</strong></p>
            <textarea id="a3" rows="10" placeholder="Anything you notice is enough...">${escapeHtml(state.guidedA3 || "")}</textarea>
          </div>

          <div class="divider"></div>

          <div class="fade" id="mfade">
            <p class="kicker" style="margin-bottom:6px;">How are you feeling right now?</p>
            <div class="row" id="moods"></div>
          </div>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="finish">Finish</button>
            <button class="btn" id="prev">Previous</button>
            <button class="btn ghost" id="home">Home</button>
          </div>
        `);

        requestAnimationFrame(() => {
          document.getElementById("qfade").classList.add("show");
          document.getElementById("mfade").classList.add("show");
        });

        const a3 = document.getElementById("a3");
        a3.addEventListener("input", () => state.guidedA3 = a3.value);

        const moods = ["ðŸ™‚ Okay","ðŸŒ¿ Calm","ðŸ«§ Numb","ðŸŒ§ï¸ Heavy","ðŸ’› Tender","ðŸ”¥ Restless","âœ¨ Hopeful","ðŸ˜´ Tired"];
        const moodsEl = document.getElementById("moods");

        moods.forEach(m => {
          const b = document.createElement("button");
          b.className = "btn" + (state.guidedMood === m ? " primary" : "");
          b.type = "button";
          b.textContent = m;
          b.style.borderRadius = "999px";
          b.style.padding = "10px 12px";
          b.addEventListener("click", () => {
            state.guidedMood = m;
            [...moodsEl.children].forEach(ch => ch.classList.remove("primary"));
            b.classList.add("primary");
          });
          moodsEl.appendChild(b);
        });

        document.getElementById("prev").addEventListener("click", () => { state.guidedStep = 2; go("guided"); });
        document.getElementById("home").addEventListener("click", () => go("home"));

        document.getElementById("finish").addEventListener("click", async () => {
          const A1 = (state.guidedA1 || "").trim();
          const A2 = (state.guidedA2 || "").trim();
          const A3 = (state.guidedA3 || "").trim();

          const any = A1.length || A2.length || A3.length;
          if (any){
            addEntry({
              id: crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2),
              createdAt: nowIso(),
              type: "Guided journal",
              mood: state.guidedMood,
              content:
`Theme: ${state.guidedSetTitle || "â€”"}

1) ${q1}
${A1}

2) ${q2}
${A2}

3) ${q3}
${A3}`.trim()
            });
            toast("Saved.");
          } else {
            toast("Nothing to save â€” thatâ€™s okay.");
          }

          state.guidedStep = 1;
          state.guidedSetId = null;
          state.guidedSetTitle = "";
          state.guidedQs = [];
          state.guidedA1 = "";
          state.guidedA2 = "";
          state.guidedA3 = "";
          state.guidedMood = null;

          await go("completeGuided");
        });

        return;
      }

      state.guidedStep = 1;
      return go("guided");
    }

    async function renderCompleteGuided(){
      await setViewHtml(`
        <h2 class="title">You did really meaningful work today.</h2>
        <p class="subtitle">Would you like to wind down with an unwinding meditation or do some free writing?</p>

        <div class="row">
          <button class="btn primary" id="toMed">Unwinding meditation</button>
          <button class="btn" id="toFree">Free writing</button>
          <button class="btn ghost" id="done">Iâ€™m done for now</button>
        </div>
      `);

      document.getElementById("toMed").addEventListener("click", () => go("medList"));
      document.getElementById("toFree").addEventListener("click", () => go("free"));
      document.getElementById("done").addEventListener("click", () => go("done"));
    }

    async function renderMeditationList(){
      await setViewHtml(`
        <p class="kicker">Unwinding meditation</p>
        <h2 class="title">Welcome.</h2>
        <p class="subtitle">
          You can choose a meditation that feels right for you right now.
          Thereâ€™s no wrong choice â€” just follow what you need.
        </p>

        <div class="option-grid">
          <div class="option" data-med="light">
            <h3>Following the Light</h3>
            <p>Imagine a soft, steady light guiding you into a peaceful place where you can rest and feel safe.</p>
          </div>

          <div class="option" data-med="river">
            <h3>Leaves on the River</h3>
            <p>Place each thought onto a leaf and let the river carry it along.</p>
          </div>

          <div class="option" data-med="sleep">
            <h3>Drifting Into Rest</h3>
            <p>A sleep meditation to help your body soften, with no pressure to fall asleep.</p>
          </div>
        </div>

        <div class="divider"></div>
        <div class="row">
          <button class="btn ghost" id="back">Back</button>
        </div>
      `);

      viewEl.querySelectorAll(".option").forEach(el => {
        el.addEventListener("click", () => go("meditation", { meditationId: el.dataset.med }));
      });
      document.getElementById("back").addEventListener("click", () => go("home"));
    }

    async function renderMeditation(medId){
      const med = getMeditation(medId);
      await setViewHtml(`
        <p class="kicker">Meditation</p>
        <h2 class="title">${escapeHtml(med.title)}</h2>
        <p class="subtitle">${escapeHtml(med.intro)}</p>

        <div class="fade" id="medfade">
          ${medId === "light" ? `
            <div class="audio-player">
              <div class="label">Following The Light</div>
              <button class="btn" id="toggleMedAudio">Play</button>
            </div>
          ` : ""}

          <div class="med-box">${escapeHtml(med.body)}</div>
        </div>

        <div class="row" style="margin-top:14px;">
          <button class="btn primary" id="finished">Iâ€™m finished</button>
          <button class="btn" id="choose">Choose another</button>
          <button class="btn ghost" id="quit">Iâ€™m done for now</button>
        </div>
      `);

      requestAnimationFrame(() => document.getElementById("medfade").classList.add("show"));

      if (medId === "light"){
        const btn = document.getElementById("toggleMedAudio");
        btn.addEventListener("click", () => {
          toggleMeditationAudio("assets/meditation/following-the-light.mp3", btn);
        });
      }

      document.getElementById("finished").addEventListener("click", () => go("completeMeditation"));
      document.getElementById("choose").addEventListener("click", () => go("medList"));
      document.getElementById("quit").addEventListener("click", () => go("done"));
    }

    async function renderCompleteMeditation(){
      await setViewHtml(`
        <h2 class="title">Thanks for taking this time for yourself.</h2>
        <p class="subtitle">What would you like to do next?</p>

        <div class="row">
          <button class="btn primary" id="toFree">Free writing</button>
          <button class="btn" id="toGuided">Guided journal</button>
          <button class="btn ghost" id="done">Iâ€™m done for now</button>
        </div>
      `);

      document.getElementById("toFree").addEventListener("click", () => go("free"));
      document.getElementById("toGuided").addEventListener("click", () => { state.guidedQs = []; state.guidedStep = 1; go("guided"); });
      document.getElementById("done").addEventListener("click", () => go("done"));
    }

    async function renderDone(){
      const entries = loadEntries();
      const email = loadEmail();
      const defaultId = state.lastSavedEntryId || (entries[0]?.id || "");

      const options = entries.slice(0, 30).map(e => {
        const label = `${e.type} â€” ${prettyDate(e.createdAt)}${e.mood ? " â€¢ " + e.mood : ""}`;
        const selected = e.id === defaultId ? "selected" : "";
        return `<option value="${escapeHtml(e.id)}" ${selected}>${escapeHtml(label)}</option>`;
      }).join("");

      await setViewHtml(`
        <h2 class="title">You can rest now, if you want.</h2>
        <p class="subtitle">If youâ€™d like, you can email yourself a saved entry.</p>

        <div class="fade" id="donefade">
          <p class="kicker">Your email address</p>
          <input type="email" id="email" placeholder="name@example.com" value="${escapeHtml(email)}" />

          <div style="height:12px;"></div>

          <p class="kicker">Choose an entry</p>
          <select id="entrySelect">
            ${options || `<option value="">No saved entries yet</option>`}
          </select>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="sendEmail">Compose email</button>
            <button class="btn" id="goHome">Home</button>
            <button class="btn ghost" id="goJournal">My Journal</button>
          </div>

          <p class="hint">This opens your email app with the entry filled in. You can review it, then press Send.</p>
        </div>
      `);

      requestAnimationFrame(() => document.getElementById("donefade").classList.add("show"));

      document.getElementById("goHome").addEventListener("click", () => go("home"));
      document.getElementById("goJournal").addEventListener("click", () => go("journal"));

      document.getElementById("sendEmail").addEventListener("click", () => {
        const emailEl = document.getElementById("email");
        const entryId = document.getElementById("entrySelect").value;

        const to = (emailEl.value || "").trim();
        if (!to){
          toast("Add an email address first.");
          emailEl.focus();
          return;
        }
        saveEmail(to);

        if (!entryId){
          toast("No entry selected.");
          return;
        }

        const e = getEntryById(entryId);
        if (!e){
          toast("Couldnâ€™t find that entry.");
          return;
        }

        const subject = `Journal Boo â€” ${e.type} (${new Date(e.createdAt).toLocaleDateString()})`;
        const body =
`Hi,

Hereâ€™s a saved entry from Journal Boo.

${e.type}${e.mood ? " â€¢ " + e.mood : ""}
${prettyDate(e.createdAt)}

--------------------

${e.content}

--------------------

Â© James Ritchie 2025`;

        composeEmail(to, subject, body);
      });
    }

    async function renderJournal(){
      const entries = loadEntries();

      await setViewHtml(`
        <p class="kicker">My Journal</p>
        <h2 class="title">Your saved writing</h2>
        <p class="subtitle">Everything here is stored locally in this browser.</p>

        <div class="row">
          <button class="btn primary" id="newFree">New free writing</button>
          <button class="btn" id="newGuided">New guided journal</button>
          <button class="btn" id="toDone">Iâ€™m done for now</button>
          <button class="btn danger" id="clearAll">Clear all (local)</button>
        </div>

        <div class="divider"></div>
        <div class="list" id="entryList"></div>
      `);

      document.getElementById("newFree").addEventListener("click", () => go("free"));
      document.getElementById("newGuided").addEventListener("click", () => { state.guidedStep = 1; state.guidedQs = []; go("guided"); });
      document.getElementById("toDone").addEventListener("click", () => go("done"));

      document.getElementById("clearAll").addEventListener("click", () => {
        const ok = confirm("Clear all saved entries from this browser?");
        if (!ok) return;
        saveEntries([]);
        toast("Cleared.");
        renderJournal();
      });

      const list = document.getElementById("entryList");
      if (!entries.length){
        list.innerHTML = `
          <div class="entry">
            <div class="meta"><span>Nothing saved yet</span><span></span></div>
            <p class="preview">When you finish a writing session, it will appear here.</p>
          </div>
        `;
        return;
      }

      entries.forEach(e => {
        const div = document.createElement("div");
        div.className = "entry";
        const mood = e.mood ? ` â€¢ ${e.mood}` : "";
        div.innerHTML = `
          <div class="meta">
            <span>${escapeHtml(e.type)}${mood}</span>
            <span>${prettyDate(e.createdAt)}</span>
          </div>
          <p class="preview">${escapeHtml(preview(e.content, 420))}</p>
          <div class="row" style="margin-top:10px;">
            <button class="btn" data-open="${escapeHtml(e.id)}">Open</button>
            <button class="btn danger" data-del="${escapeHtml(e.id)}">Delete</button>
          </div>
        `;
        list.appendChild(div);
      });

      list.querySelectorAll("button[data-open]").forEach(btn => {
        btn.addEventListener("click", () => openEntry(btn.getAttribute("data-open")));
      });
      list.querySelectorAll("button[data-del]").forEach(btn => {
        btn.addEventListener("click", () => deleteEntry(btn.getAttribute("data-del")));
      });

      function preview(txt, max){
        const s = (txt || "").trim();
        if (s.length <= max) return s;
        return s.slice(0, max).trim() + "â€¦";
      }

      async function openEntry(id){
        const entries = loadEntries();
        const e = entries.find(x => x.id === id);
        if (!e) return;

        await setViewHtml(`
          <p class="kicker">My Journal</p>
          <h2 class="title">${escapeHtml(e.type)}</h2>
          <p class="subtitle">${prettyDate(e.createdAt)}${e.mood ? " â€¢ " + escapeHtml(e.mood) : ""}</p>

          <div class="med-box">${escapeHtml(e.content)}</div>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="backList">Back</button>
            <button class="btn" id="emailThis">Email this</button>
            <button class="btn danger" id="delThis">Delete</button>
            <button class="btn ghost" id="home">Home</button>
          </div>
        `);

        document.getElementById("backList").addEventListener("click", () => go("journal"));
        document.getElementById("home").addEventListener("click", () => go("home"));

        document.getElementById("delThis").addEventListener("click", () => deleteEntry(id));

        document.getElementById("emailThis").addEventListener("click", () => {
          state.lastSavedEntryId = e.id;
          go("done");
        });
      }

      function deleteEntry(id){
        const ok = confirm("Delete this entry?");
        if (!ok) return;
        const entries = loadEntries().filter(e => e.id !== id);
        saveEntries(entries);
        toast("Deleted.");
        go("journal");
      }
    }

    function getMeditation(id){
      const meds = {
        light: {
          title: "Following the Light",
          intro: "Take your time reading. You can move at your own pace â€” thereâ€™s nothing to rush.",
          body:
`Hi.
You can take this moment just for yourself. Thereâ€™s nothing you need to do perfectly. Just being here is enough.

If it feels okay, let your body settle into a comfortable position.
You might notice the place where youâ€™re sitting or lying down. The support beneath you. The quiet weight of your body being held.

Now, imagine thereâ€™s a soft light somewhere nearby.
Not bright or overwhelming â€” just warm and steady.
The kind of light that feels kind, like itâ€™s been waiting for you.

You donâ€™t have to rush toward it.
Just notice it.
And when youâ€™re ready, you can gently begin to follow it.

With each slow breath, the light guides you forward.
As you move closer, the world around you feels calmer.
Quieter.
Like things are slowly finding their place.

The light leads you to a peaceful space.
This place feels safe.
Nothing is expected of you here.
Everything feelsâ€¦ right.

Take a moment to look around this place in your mind.
Notice the colors.
The stillness.
The sense that you are welcome exactly as you are.

If thereâ€™s anything heavy youâ€™ve been carrying, you donâ€™t need to hold it so tightly here.
You can set it down â€” even just for a moment.

Take your time here.
Let the calm settle gently around you.
Let yourself rest in it.

And when youâ€™re ready, you can begin to bring your attention back.
Knowing this peaceful place is always something you can return to.

Thank you for taking this time for yourself.
You did beautifully.`
        },
        river: {
          title: "Leaves on the River",
          intro: "As thoughts come, you can place each one onto a leaf, and let the river carry it along.",
          body:
`Hi.
This is a quiet moment just for you. Thereâ€™s nowhere you need to be right now, and nothing you need to solve.

If it feels comfortable, let your body settle.
You might notice your breathing, just as it is â€” no need to change it.
Simply noticing can be enough.

Now, imagine youâ€™re sitting beside a calm, slow-moving river.
The water is steady and smooth, flowing at its own gentle pace.
The air feels fresh. Peaceful.

Floating along the surface of the river are soft leaves.
Each leaf drifts by easily, carried by the water.

As thoughts come to you â€” plans, worries, memories, or questions â€” you donâ€™t have to push them away.
Instead, imagine placing each thought gently onto a leaf.
One by one, you can set them down.

Thereâ€™s no need to judge the thoughts.
Nothing to fix.
Just notice them, place them on a leaf, and watch as the river carries them along.

Some leaves may move slowly.
Some may drift quickly out of view.
However they go is okay.

You donâ€™t have to follow them downstream.
You can stay right here, resting on the riverbank, watching the water flow.

If new thoughts appear, thatâ€™s okay too.
Thereâ€™s always another leaf ready to carry them.

Take your time here.
Feel the steadiness of the river.
The sense that things can move along without your effort.

When you feel ready, you can gently bring your awareness back.
Bringing with you the feeling of space youâ€™ve created.

Thank you for spending this time with yourself.
You can return to this river whenever you need.`
        },
        sleep: {
          title: "Drifting Into Rest",
          intro: "This is a gentle sleep meditation. Thereâ€™s no pressure to fall asleep.",
          body:
`Hi.
Youâ€™ve made it to the end of the day, and thatâ€™s something to honor.
This moment is for rest. Nothing else is required of you.

If youâ€™re lying down, let your body settle into the surface beneath you.
You might notice how youâ€™re supported â€” how you donâ€™t have to hold yourself up right now.
The day can begin to soften.

Imagine that night is slowly wrapping around you, like a warm, familiar blanket.
Not heavy.
Just comforting.
A gentle signal that itâ€™s safe to let go.

With each breath out, you can allow your body to sink a little deeper.
Your shoulders donâ€™t need to stay lifted.
Your jaw doesnâ€™t need to stay tight.
Even your thoughts can loosen their grip.

If your mind wanders, thatâ€™s okay.
You donâ€™t need to follow every thought to the end.
You can let them fade into the background, like distant sounds growing quieter.

Imagine a slow, steady rhythm around you â€” like the hush of the night itself.
Everything is moving at a calm, unhurried pace.
Thereâ€™s nothing youâ€™re missing.
Nothing you need to remember right now.

If sleep comes, you donâ€™t need to think about it.
You donâ€™t have to try.
You can simply rest here, letting your body take over.

And if youâ€™re still awake, thatâ€™s okay too.
Rest is still rest.
Your body knows what it needs.

Take your time here.
Breathing.
Softening.
Letting the night hold you.

Thank you for taking this moment to slow down.
You can let this moment hold you while you drift.`
        }
      };
      return meds[id] || meds.sleep;
    }

    (function init(){
      loadSettings();
      syncMusicUI();

      state.musicOn = false;
      bgm.pause();

      bgm.src = getTrack(state.trackId).src;
      bgm.volume = 0;

      viewEl.classList.remove("show");
      go("home").then(() => {});
    })();
  </script>
</body>
</html>
