<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Journal Boo</title>

  <!-- ✅ Adds a "js" class to <html> so we can animate only when JS is running -->
  <script>
    document.documentElement.classList.add("js");
  </script>

  <style>
    :root{
      /* Default vars (will be overridden by body[data-theme]) */
      --bg: #f7f5ef;
      --text: #171615;
      --muted: #4b4a46;
      --muted2:#6a6862;
      --accent:#8a6a2b;

      --radius: 20px;
      --line: 1px solid rgba(0,0,0,.10);
      --shadow: 0 14px 38px rgba(0,0,0,.10);
      --font: ui-serif, Georgia, "Times New Roman", Times, serif;
    }

    /* ✅ Theme palettes */
    body[data-theme="charcoal"]{
      --bg: #0f0f12;
      --text: #f1efe9;
      --muted: #b9b6ad;
      --muted2:#8f8b81;
      --accent:#c9a76a;
      --line: 1px solid rgba(255,255,255,.07);
      --shadow: 0 14px 38px rgba(0,0,0,.35);
    }

    body[data-theme="light"]{
      --bg: #f7f5ef;
      --text: #171615;
      --muted: #4b4a46;
      --muted2:#6a6862;
      --accent:#8a6a2b;
      --line: 1px solid rgba(0,0,0,.10);
      --shadow: 0 14px 38px rgba(0,0,0,.10);
    }

    /* ✅ Brighter green */
    body[data-theme="racing-green"]{
      --bg: #07130e;
      --text: #f3f1ea;
      --muted: #c2d2c8;
      --muted2:#9bb3a8;
      --accent:#31c981;
      --line: 1px solid rgba(255,255,255,.09);
      --shadow: 0 14px 38px rgba(0,0,0,.38);
    }

    /* ✅ Lighter rose pink */
    body[data-theme="rose-pink"]{
      --bg: #1b0f15;
      --text: #fbf3f6;
      --muted: #e2c5d0;
      --muted2:#caa0af;
      --accent:#ff97ba;
      --line: 1px solid rgba(255,255,255,.10);
      --shadow: 0 14px 38px rgba(0,0,0,.40);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin: 0;
      font-family: var(--font);
      background:
        radial-gradient(1100px 800px at 18% 0%, rgba(201,167,106,.10), transparent 58%),
        radial-gradient(900px 600px at 88% 12%, rgba(201,167,106,.07), transparent 60%),
        var(--bg);
      color: var(--text);
      letter-spacing: .1px;
    }

    /* ✅ Landing / Welcome screen */
    .jbScreen{
      position: fixed;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 24px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 520ms ease;
      background:
        radial-gradient(1100px 800px at 18% 0%, rgba(201,167,106,.10), transparent 58%),
        radial-gradient(900px 600px at 88% 12%, rgba(201,167,106,.07), transparent 60%),
        var(--bg);
      z-index: 9999;
    }
    .jbScreen.active{
      opacity: 1;
      pointer-events: auto;
    }

    .jbCenter{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 12px;
      text-align:center;
      max-width: 820px;
    }

    /* ✅ IMPORTANT: visible by default (no blank screen if JS fails) */
    .jbWelcomeTitle{
      font-size: clamp(22px, 4vw, 34px);
      font-weight: 600;
      letter-spacing:.2px;
      color: var(--text);
      margin: 0;
    }
    .jbWelcomeSub{
      margin: 0;
      color: var(--muted);
      font-size: 16px;
      line-height: 1.55;
    }
    .jbStartBtn{
      border: var(--line);
      background: rgba(255,255,255,.03);
      padding: 16px 20px;
      border-radius: 999px;
      font-size: 14px;
      color: var(--text);
      cursor:pointer;
      user-select:none;
      transition: background .12s ease, transform .12s ease;
    }
    .jbStartBtn:hover{ background: rgba(255,255,255,.05); transform: translateY(-1px); }

    /* ✅ Only animate when JS is active */
    html.js .jbWelcomeTitle,
    html.js .jbWelcomeSub,
    html.js .jbStartBtn{
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 700ms ease, transform 700ms ease;
    }
    html.js .jbWelcomeTitle.show,
    html.js .jbWelcomeSub.show,
    html.js .jbStartBtn.show{
      opacity: 1;
      transform: translateY(0);
    }

    /* ✅ Hide main app until started */
    #jbApp.hidden{ display:none; }

    .app{
      min-height: 100%;
      display:flex;
      justify-content:center;
      padding: 28px 14px 40px;
    }

    .shell{
      width: min(820px, 100%);
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 8px 4px;
      gap: 10px;
    }

    .brand{ display:flex; flex-direction:column; gap: 2px; }
    .brand h1{ margin:0; font-size:22px; font-weight:600; letter-spacing:.2px; }
    .brand p{ margin:0; color:var(--muted2); font-size:13px; line-height:1.35; }

    .top-actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .pill{
      border: var(--line);
      background: rgba(255,255,255,.03);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      color: var(--text);
      display:inline-flex;
      align-items:center;
      gap: 8px;
      cursor:pointer;
      user-select:none;
      transition: background .12s ease, transform .12s ease;
    }
    .pill:hover{ background: rgba(255,255,255,.05); transform: translateY(-1px); }

    /* ✅ Pill-style dropdown */
    .pill-select{
      border: var(--line);
      background: rgba(255,255,255,.03);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      color: var(--text);
      display:inline-flex;
      align-items:center;
      gap: 8px;
      transition: background .12s ease, transform .12s ease;
    }
    .pill-select:hover{ background: rgba(255,255,255,.05); transform: translateY(-1px); }
    .pill-select label{
      color: var(--text);
      font-size: 13px;
      user-select:none;
      white-space: nowrap;
    }
    .pill-select select{
      width: auto;
      padding: 0;
      margin: 0;
      border: 0;
      outline: none;
      background: transparent;
      color: var(--text);
      font-family: var(--font);
      font-size: 13px;
      line-height: 1;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }
    /* Simple chevron */
    .pill-select .chev{
      width: 0; height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-top: 6px solid rgba(255,255,255,.55);
      margin-left: 2px;
      transform: translateY(1px);
    }
    body[data-theme="light"] .pill-select .chev{
      border-top-color: rgba(0,0,0,.45);
    }
    /* Dropdown menu colors */
    .pill-select select option{
      background: var(--bg);
      color: var(--text);
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
      border: var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card-inner{ padding: 22px; }

    .title{
      font-size: 26px;
      margin: 0 0 10px;
      font-weight: 600;
      letter-spacing: .15px;
    }
    .subtitle{
      margin: 0 0 18px;
      color: var(--muted);
      line-height: 1.6;
      font-size: 16px;
    }

    .option-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 8px;
    }
    .option{
      border: var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding: 16px 16px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease;
    }
    .option:hover{ background: rgba(255,255,255,.05); transform: translateY(-1px); }
    .option h3{ margin: 0; font-size: 18px; font-weight: 600; }
    .option p{ margin: 6px 0 0; color: var(--muted); font-size: 14px; line-height: 1.5; }

    .row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }

    .btn{
      border: var(--line);
      background: rgba(255,255,255,.03);
      padding: 12px 14px;
      border-radius: 14px;
      font-size: 14px;
      cursor:pointer;
      color: var(--text);
      user-select:none;
      transition: background .12s ease, transform .12s ease;
    }
    .btn:hover{ background: rgba(255,255,255,.05); transform: translateY(-1px); }
    .btn.primary{
      background: rgba(201,167,106,.16);
      border: 1px solid rgba(201,167,106,.35);
    }
    .btn.primary:hover{ background: rgba(201,167,106,.22); }
    .btn.ghost{ background: transparent; }
    .btn.danger{
      border: 1px solid rgba(214,125,125,.35);
      background: rgba(214,125,125,.10);
    }

    .divider{
      height: 1px;
      background: rgba(255,255,255,.07);
      margin: 18px 0;
    }
    body[data-theme="light"] .divider{
      background: rgba(0,0,0,.10);
    }

    textarea, input[type="email"], select{
      width: 100%;
      border: var(--line);
      background: rgba(0,0,0,.16);
      border-radius: 16px;
      color: var(--text);
      padding: 12px 14px;
      font-family: var(--font);
      font-size: 16px;
      line-height: 1.6;
      outline: none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    textarea:focus, input:focus, select:focus{
      border-color: rgba(201,167,106,.45);
      box-shadow: 0 0 0 3px rgba(201,167,106,.10);
    }
    select { font-size: 15px; }

    .kicker{
      font-size: 14px;
      color: var(--muted);
      margin: 0 0 8px;
    }
    .hint{
      margin-top: 10px;
      color: var(--muted2);
      font-size: 13px;
      line-height: 1.45;
    }
    .small{ font-size: 12.5px; color: var(--muted2); }

    .fade{
      opacity: 0;
      transform: translateY(6px);
      transition: opacity .28s ease, transform .28s ease;
    }
    .fade.show{
      opacity: 1;
      transform: translateY(0);
    }

    .med-box{
      background: rgba(255,255,255,.02);
      border: var(--line);
      border-radius: 18px;
      padding: 18px;
      white-space: pre-wrap;
      line-height: 1.75;
      font-size: 16px;
    }

    /* ✅ Meditation audio player */
    .audio-player{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 10px;
      margin-bottom: 18px;
    }
    .audio-player .label{
      font-size: 14px;
      color: var(--muted);
    }
    .audio-player .btn{
      min-width: 140px;
      text-align: center;
    }

    .footer-note{
      color: var(--muted2);
      font-size: 12.5px;
      line-height: 1.45;
      padding: 0 4px;
    }

    .footer-note a{
      color: inherit;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .list{ display:grid; gap: 10px; margin-top: 8px; }
    .entry{
      border: var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 16px;
      padding: 14px 14px;
    }
    .entry .meta{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      color: var(--muted2);
      font-size: 12.5px;
      margin-bottom: 8px;
    }
    .entry .preview{
      margin: 0;
      color: var(--text);
      font-size: 15px;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease, transform .2s ease;
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(-4px); }
    body[data-theme="light"] .toast{
      background: rgba(255,255,255,.72);
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 10px 25px rgba(0,0,0,.12);
    }

    @media (max-width: 520px){
      .title{ font-size: 23px; }
      .subtitle{ font-size: 15px; }
      .pill{ padding: 9px 10px; }
      .pill-select{ padding: 9px 10px; }
      .card-inner{ padding: 18px; }
    }
  </style>
</head>

<script data-goatcounter="https://munchkin-boo.goatcounter.com/count"
  async src="//gc.zgo.at/count.js"></script>

<!-- ✅ Racing Green is the default theme on load -->
<body data-theme="racing-green">

  <!-- ✅ LANDING PAGE -->
  <section id="jbWelcome" class="jbScreen active" aria-label="Welcome">
    <div class="jbCenter">
      <div id="jbWelcomeTitle" class="jbWelcomeTitle">Hello and welcome to Journal Boo...</div>
      <p id="jbWelcomeSub" class="jbWelcomeSub">...I’m your personal journal companion!</p>
      <button id="jbStartBtn" class="jbStartBtn" type="button">Let’s get started</button>
    </div>
  </section>

  <!-- ✅ MAIN APP (hidden until start) -->
  <div id="jbApp" class="app hidden">
    <div class="shell">
      <header>
        <div class="brand">
          <h1>Journal Boo</h1>
          <p>a quiet companion for writing, reflection, and unwinding</p>
        </div>

        <div class="top-actions">
          <button class="pill" id="btnHome" title="Home">Home</button>
          <button class="pill" id="btnJournal" title="My Journal">My Journal</button>

          <!-- ✅ Theme dropdown (pill-style) -->
          <div class="pill-select" title="Theme">
            <label for="themeSelect">Theme:</label>
            <select id="themeSelect" aria-label="Theme">
              <option value="charcoal">Charcoal Grey</option>
              <option value="light">Light</option>
              <option value="racing-green">Racing Green</option>
              <option value="rose-pink">Rose Pink</option>
            </select>
            <span class="chev" aria-hidden="true"></span>
          </div>

          <button class="pill" id="btnMusicToggle" title="Toggle music">
            Music: <span id="musicState">Off</span>
          </button>
          <button class="pill" id="btnMusicNext" title="Change music">
            Track: <span id="musicTrackLabel">Devi’s Song</span>
          </button>
        </div>
      </header>

      <main class="card">
        <div class="card-inner fade" id="view"></div>
      </main>

      <div class="footer-note">
        Your writing is saved locally in this browser. (V1)<br />
        <a href="#" id="privacyLink">Privacy &amp; data use</a><br />
        © 2025 James Ritchie and www.boo-industries.com. All rights reserved. Contact: jamesalexritchie@outlook.com for more information.
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <audio id="bgm" preload="auto" loop></audio>
  <audio id="medPlayer" preload="none"></audio>

  <script>
    /***********************
     * Journal Boo (V1)
     ***********************/

    // ✅ Added 2 more tracks
    const TRACKS = [
      { id: "devi-song",       label: "Devi’s Song",      src: "assets/music/devi-song.mp3" },
      { id: "labour-of-love",  label: "Labour Of Love",   src: "assets/music/labour-of-love.mp3" },
      { id: "crying-out",      label: "Crying Out",       src: "assets/music/crying-out.mp3" },
      { id: "warmer",          label: "Warmer",           src: "assets/music/warmer.mp3" },
      { id: "concerto",        label: "Concerto",         src: "assets/music/concerto.mp3" },
    ];

    /***********************
     * ✅ Meditations (loaded from JSON files)
     * Paths: assets/meditations/[short title].json
     * Each JSON can optionally include: { id, title, intro, body, audioSrc }
     ***********************/
    const MEDITATIONS_INDEX = [
      { id: "giving-and-receiving-love", title: "Giving and Receiving Love", intro: "A gentle practice of offering and receiving warmth, even through difficulty.", path: "assets/meditations/giving-and-receiving-love.json" },
      { id: "gentle-gratitude",          title: "A Gentle Practice of Gratitude", intro: "A small, unforced gratitude practice — calm and simple.", path: "assets/meditations/gentle-gratitude.json" },
      { id: "making-space",             title: "Making Space for One Another", intro: "A reflection on warmth, space, and the healing nature of giving.", path: "assets/meditations/making-space.json" },
    ];

    // ✅ Poetry Corner (loaded from one combined JSON)
    const POETRY_INDEX_PATH = "assets/poetry/poems.json";

    const LS_KEY = "journal_boo_entries_v1";
    const LS_SETTINGS = "journal_boo_settings_v1";
    const LS_EMAIL = "journal_boo_email_v1";
    const LS_THEME = "journal_boo_theme_v1";

    const state = {
      route: "home",
      musicOn: false,
      trackId: "devi-song",
      theme: "racing-green",

      freeText: "",

      meditationId: null,
      lastSavedEntryId: null,

      medCache: {},
      poetryCache: null,

      poetryCollectionId: null,
    };

    const viewEl = document.getElementById("view");
    const toastEl = document.getElementById("toast");
    const bgm = document.getElementById("bgm");
    const medPlayer = document.getElementById("medPlayer");
    const musicStateEl = document.getElementById("musicState");
    const musicTrackLabelEl = document.getElementById("musicTrackLabel");
    const themeSelectEl = document.getElementById("themeSelect");

    document.getElementById("btnHome").addEventListener("click", () => go("home"));
    document.getElementById("btnJournal").addEventListener("click", () => go("journal"));

    document.getElementById("privacyLink")?.addEventListener("click", (e) => {
      e.preventDefault();
      go("privacy");
    });

    document.getElementById("btnMusicToggle").addEventListener("click", () => {
      setMusicOn(!state.musicOn);
      toast(state.musicOn ? "Music on." : "Music off.");
    });

    document.getElementById("btnMusicNext").addEventListener("click", () => {
      cycleTrack();
      if (state.musicOn) fadeToTrack(state.trackId);
      toast("Changed music.");
    });

    function loadTheme(){
      try{
        const t = localStorage.getItem(LS_THEME);
        if (t) state.theme = t;
      }catch{}
    }
    function saveTheme(){
      try{ localStorage.setItem(LS_THEME, state.theme); }catch{}
    }
    function applyTheme(){
      const t = state.theme || "racing-green";
      document.body.setAttribute("data-theme", t);
      if (themeSelectEl) themeSelectEl.value = t;
    }

    if (themeSelectEl){
      themeSelectEl.addEventListener("change", () => {
        state.theme = themeSelectEl.value;
        saveTheme();
        applyTheme();
        toast("Theme changed.");
      });
    }

    /* ✅ Landing page wiring */
    const jbWelcome = document.getElementById("jbWelcome");
    const jbWelcomeTitle = document.getElementById("jbWelcomeTitle");
    const jbWelcomeSub = document.getElementById("jbWelcomeSub");
    const jbStartBtn = document.getElementById("jbStartBtn");
    const jbApp = document.getElementById("jbApp");

    function runWelcomeAnimation(){
      if (!jbWelcomeTitle || !jbWelcomeSub || !jbStartBtn) return;
      setTimeout(() => jbWelcomeTitle.classList.add("show"), 160);
      setTimeout(() => jbWelcomeSub.classList.add("show"), 520);
      setTimeout(() => jbStartBtn.classList.add("show"), 900);
    }

    function startApp(){
      if (!jbWelcome || !jbApp) return;
      jbWelcome.classList.remove("active");
      setTimeout(() => {
        jbWelcome.style.display = "none";
        jbApp.classList.remove("hidden");
        go("home").then(() => {});
      }, 520);
    }

    jbStartBtn?.addEventListener("click", startApp);
    document.addEventListener("keydown", (e) => {
      if (jbWelcome && jbWelcome.classList.contains("active") && (e.key === "Enter" || e.key === " ")){
        e.preventDefault();
        startApp();
      }
    });

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function nowIso(){ return new Date().toISOString(); }
    function prettyDate(iso){
      const d = new Date(iso);
      return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 1500);
    }

    function loadSettings(){
      try{
        const raw = localStorage.getItem(LS_SETTINGS);
        if (!raw) return;
        const s = JSON.parse(raw);
        if (typeof s.trackId === "string") state.trackId = s.trackId;
      }catch{}
    }
    function saveSettings(){
      try{
        localStorage.setItem(LS_SETTINGS, JSON.stringify({ trackId: state.trackId }));
      }catch{}
    }

    function loadEntries(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      }catch{
        return [];
      }
    }
    function saveEntries(entries){
      localStorage.setItem(LS_KEY, JSON.stringify(entries));
    }
    function addEntry(entry){
      const entries = loadEntries();
      entries.unshift(entry);
      saveEntries(entries);
      state.lastSavedEntryId = entry.id;
    }

    function loadEmail(){
      try{ return localStorage.getItem(LS_EMAIL) || ""; }catch{ return ""; }
    }
    function saveEmail(email){
      try{ localStorage.setItem(LS_EMAIL, email || ""); }catch{}
    }

    // --- Developer blog helpers ---
    async function fetchBlogJson(){
      const candidates = [
        "assets/blog/munchkinboo",
        "assets/blog/munchkinboo.json",
      ];

      let lastErr = null;

      for (const url of candidates){
        try{
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          return { url, data };
        }catch(err){
          lastErr = err;
        }
      }
      throw lastErr || new Error("Unable to load blog JSON.");
    }

    function normalizeBlogPosts(data){
      const posts = Array.isArray(data) ? data
        : (data && Array.isArray(data.posts)) ? data.posts
        : (data && (data.title || data.body || data.content || data.text)) ? [data]
        : [];

      return posts.map((p, idx) => ({
        id: String(p.id ?? idx),
        title: String(p.title ?? "Untitled"),
        date: p.date ? String(p.date) : (p.createdAt ? String(p.createdAt) : ""),
        body: String(p.body ?? p.content ?? p.text ?? ""),
      }));
    }

    /***********************
     * ✅ JSON helpers (meditations + poetry)
     ***********************/
    async function fetchJsonWithCandidates(baseOrPath){
      const candidates = [];
      if (baseOrPath.endsWith(".json")) {
        candidates.push(baseOrPath);
      } else {
        candidates.push(baseOrPath);
        candidates.push(baseOrPath + ".json");
      }

      let lastErr = null;
      for (const url of candidates){
        try{
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          return { url, data };
        }catch(err){
          lastErr = err;
        }
      }
      throw lastErr || new Error("Unable to load JSON.");
    }

    async function loadMeditationById(id){
      if (state.medCache[id]) return state.medCache[id];

      const meta = MEDITATIONS_INDEX.find(m => m.id === id);
      if (!meta) throw new Error("Meditation not found.");

      const { data } = await fetchJsonWithCandidates(meta.path);
      const med = {
        id,
        title: String(data.title ?? meta.title ?? "Meditation"),
        intro: String(data.intro ?? meta.intro ?? ""),
        body: String(data.body ?? data.text ?? ""),
        audioSrc: data.audioSrc ? String(data.audioSrc) : "",
      };

      state.medCache[id] = med;
      return med;
    }

    function normalizePoetryData(raw){
      let collections = [];

      if (Array.isArray(raw)) {
        collections = raw;
      } else if (raw && Array.isArray(raw.collections)) {
        collections = raw.collections;
      } else if (raw && Array.isArray(raw.poems) && Array.isArray(raw.collections)) {
        collections = raw.collections;
      } else if (raw && Array.isArray(raw.poems)) {
        collections = [{ id: "poems", title: "Poems", poems: raw.poems }];
      } else {
        collections = [];
      }

      collections = collections.map((c, idx) => {
        const poemsArr = Array.isArray(c.poems) ? c.poems : (Array.isArray(c.items) ? c.items : []);
        const poems = poemsArr.map((p, jdx) => ({
          id: String(p.id ?? jdx),
          title: String(p.title ?? p.name ?? "Untitled"),
          text: String(p.text ?? p.body ?? p.content ?? ""),
        }));

        return {
          id: String(c.id ?? idx),
          title: String(c.title ?? c.name ?? "Collection"),
          poems,
        };
      });

      return { collections };
    }

    async function loadPoetryIndex(){
      if (state.poetryCache) return state.poetryCache;
      const { data } = await fetchJsonWithCandidates(POETRY_INDEX_PATH);
      const normalized = normalizePoetryData(data);
      state.poetryCache = normalized;
      return normalized;
    }

    // --- Music engine (gentle fade) ---
    let fadeTimer = null;

    function stopMeditationAudio(){
      medPlayer.pause();
      medPlayer.currentTime = 0;
    }

    function stopBackgroundMusic(){
      clearInterval(fadeTimer);
      bgm.pause();
      bgm.currentTime = 0;
      bgm.volume = 0;
    }

    function toggleMeditationAudio(src, btn){
      if (!src) {
        toast("Audio not available yet.");
        return;
      }

      if (!medPlayer.src || !medPlayer.src.endsWith(src)){
        medPlayer.src = src;
      }

      if (medPlayer.paused){
        stopBackgroundMusic();
        state.musicOn = false;
        syncMusicUI();

        medPlayer.play().catch(() => toast("Tap Play again to start."));
        btn.textContent = "Stop";
      } else {
        stopMeditationAudio();
        btn.textContent = "Play";
      }
    }

    function setMusicOn(on){
      if (!medPlayer.paused){
        stopMeditationAudio();
      }

      state.musicOn = on;
      syncMusicUI();

      if (!on){
        fadeOut(280);
        return;
      }
      ensurePlaying();
      fadeToTrack(state.trackId, 280);
    }

    function ensurePlaying(){
      if (!bgm.src) bgm.src = getTrack(state.trackId).src;
      if (bgm.paused){
        bgm.play().catch(() => toast("Tap Music again to start."));
      }
    }

    function setTrack(trackId){
      state.trackId = trackId;
      saveSettings();
      syncMusicUI();
    }

    function cycleTrack(){
      const idx = TRACKS.findIndex(t => t.id === state.trackId);
      const next = TRACKS[(idx + 1 + TRACKS.length) % TRACKS.length];
      setTrack(next.id);
    }

    function getTrack(trackId){
      return TRACKS.find(t => t.id === trackId) || TRACKS[0];
    }

    function fadeToTrack(trackId, ms=320){
      const t = getTrack(trackId);
      const targetSrc = t.src;

      if (bgm.src && bgm.src.endsWith(targetSrc)){
        ensurePlaying();
        fadeIn(ms);
        return;
      }

      clearInterval(fadeTimer);
      const startVol = bgm.paused ? 0 : bgm.volume;
      const steps = 12;
      const stepMs = Math.max(16, Math.floor(ms / steps));
      let i = 0;

      fadeTimer = setInterval(() => {
        i++;
        bgm.volume = Math.max(0, startVol * (1 - i/steps));
        if (i >= steps){
          clearInterval(fadeTimer);
          bgm.src = targetSrc;
          bgm.volume = 0;
          ensurePlaying();
          fadeIn(ms);
        }
      }, stepMs);
    }

    function fadeIn(ms=320){
      clearInterval(fadeTimer);
      if (state.musicOn) ensurePlaying();

      const steps = 12;
      const stepMs = Math.max(16, Math.floor(ms / steps));
      let i = 0;

      fadeTimer = setInterval(() => {
        i++;
        bgm.volume = Math.min(0.55, (i/steps) * 0.55);
        if (i >= steps) clearInterval(fadeTimer);
      }, stepMs);
    }

    function fadeOut(ms=320){
      clearInterval(fadeTimer);
      const steps = 12;
      const stepMs = Math.max(16, Math.floor(ms / steps));
      const startVol = bgm.paused ? 0 : bgm.volume;
      let i = 0;

      fadeTimer = setInterval(() => {
        i++;
        bgm.volume = Math.max(0, startVol * (1 - i/steps));
        if (i >= steps){
          clearInterval(fadeTimer);
          bgm.pause();
        }
      }, stepMs);
    }

    function syncMusicUI(){
      musicStateEl.textContent = state.musicOn ? "On" : "Off";
      musicTrackLabelEl.textContent = getTrack(state.trackId).label;
    }

    // --- Fade helpers ---
    function fadeInView(){ requestAnimationFrame(() => viewEl.classList.add("show")); }
    function fadeOutView(){ viewEl.classList.remove("show"); }
    function wait(ms){ return new Promise(res => setTimeout(res, ms)); }

    async function setViewHtml(html, {fade=true}={}){
      if (fade){
        fadeOutView();
        await wait(140);
      }
      viewEl.innerHTML = html;
      viewEl.classList.remove("show");
      await wait(10);
      fadeInView();
    }

    function composeEmail(to, subject, body){
      const url =
        "mailto:" + encodeURIComponent(to) +
        "?subject=" + encodeURIComponent(subject) +
        "&body=" + encodeURIComponent(body);
      window.location.href = url;
    }

    function getEntryById(id){
      const entries = loadEntries();
      return entries.find(e => e.id === id) || null;
    }

    async function go(route, payload={}){
      stopMeditationAudio();
      state.route = route;

      if (route === "meditation" && payload.meditationId){
        state.meditationId = payload.meditationId;
      }

      if (route === "poetryCollection" && payload.collectionId){
        state.poetryCollectionId = payload.collectionId;
      }

      await render();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    async function render(){
      switch(state.route){
        case "home": return renderHome();
        case "free": return renderFree();
        case "completeFree": return renderCompleteFree();
        case "medList": return renderMeditationList();
        case "meditation": return renderMeditation(state.meditationId);
        case "completeMeditation": return renderCompleteMeditation();
        case "poetry": return renderPoetryHome();
        case "poetryCollection": return renderPoetryCollection(state.poetryCollectionId);
        case "journal": return renderJournal();
        case "done": return renderDone();
        case "blog": return renderBlog();
        case "privacy": return renderPrivacy();
        default: return renderHome();
      }
    }

    async function renderPrivacy(){
      await setViewHtml(`
        <p class="kicker">Privacy & data use</p>
        <h2 class="title">Your privacy matters here.</h2>

        <div class="med-box">
Journal Boo does not collect, store, or transmit any personal or sensitive information about you.

All journal entries you create are saved only in your own browser, using local storage. This means:

• Your writing never leaves your device
• Journal Boo cannot see, read, or access your entries
• Nothing is uploaded to a server
• Nothing is shared with third parties

If you clear your browser data, use private browsing, or switch devices, your saved journal entries will no longer be available — because they were never stored anywhere else.

The optional background music and written meditations are delivered as static files only.

If you choose to email an entry to yourself, Journal Boo simply opens your email app with the text filled in. The message is sent only by you, through your own email provider.

Journal Boo is designed to be a quiet, private space for reflection — not a platform that tracks you.
        </div>

        <div class="row" style="margin-top:16px;">
          <button class="btn primary" id="backHome">Home</button>
          <button class="btn" id="backJournal">My Journal</button>
        </div>
      `);

      document.getElementById("backHome").addEventListener("click", () => go("home"));
      document.getElementById("backJournal").addEventListener("click", () => go("journal"));
    }

    async function renderHome(){
      await setViewHtml(`
        <h2 class="title">Hi, I’m Journal Boo.</h2>
        <p class="subtitle">I’m your personal journal companion. What would you like to do today?</p>

        <div class="option-grid">
          <div class="option" data-route="free">
            <h3>Free writing</h3>
            <p>Write freely about whatever’s on your mind.</p>
          </div>

          <div class="option" data-route="medList">
            <h3>Unwinding meditation</h3>
            <p>Choose a calm written meditation to read at your own pace.</p>
          </div>

          <div class="option" data-route="poetry">
            <h3>Poetry Corner</h3>
            <p>Gentle poems — calm, kind, and comforting.</p>
          </div>
        </div>

        <div class="divider"></div>

        <div class="list">
          <div class="entry" id="blogLink" style="cursor:pointer;">
            <div class="meta">
              <span>Munchkin Boo’s  private journal… Keep out!</span>
              <span></span>
            </div>
            <p class="preview"></p>
          </div>
        </div>
      `);

      viewEl.querySelectorAll(".option").forEach(el => {
        el.addEventListener("click", () => go(el.dataset.route));
      });

      const blogLink = document.getElementById("blogLink");
      if (blogLink) blogLink.addEventListener("click", () => go("blog"));
    }

    async function renderBlog(){
      await setViewHtml(`
        <p class="kicker"></p>
        <h2 class="title">Munchkin Boo’s private journal…</h2>
        <p class="subtitle"></p>

        <div class="list" id="blogList">
          <div class="entry">
            <div class="meta"><span>Loading…</span><span></span></div>
            <p class="preview">Fetching posts…</p>
          </div>
        </div>

        <div class="divider"></div>
        <div class="row">
          <button class="btn primary" id="backHome">Home</button>
          <button class="btn" id="backJournal">My Journal</button>
        </div>
      `);

      document.getElementById("backHome").addEventListener("click", () => go("home"));
      document.getElementById("backJournal").addEventListener("click", () => go("journal"));

      const listEl = document.getElementById("blogList");

      try{
        const { data } = await fetchBlogJson();
        const posts = normalizeBlogPosts(data);

        if (!posts.length){
          listEl.innerHTML = `
            <div class="entry">
              <div class="meta"><span>No posts found</span><span></span></div>
              <p class="preview">Your JSON loaded, but it didn’t contain any posts.</p>
            </div>
          `;
          return;
        }

        listEl.innerHTML = "";
        posts.forEach(p => {
          const div = document.createElement("div");
          div.className = "entry";

          let right = "";
          if (p.date){
            const asDate = new Date(p.date);
            right = isNaN(asDate.getTime()) ? p.date : prettyDate(asDate.toISOString());
          }

          div.innerHTML = `
            <div class="meta">
              <span>${escapeHtml(p.title)}</span>
              <span>${escapeHtml(right)}</span>
            </div>
            <p class="preview">${escapeHtml(p.body || "")}</p>
          `;
          listEl.appendChild(div);
        });
      }catch(err){
        listEl.innerHTML = `
          <div class="entry">
            <div class="meta"><span>Couldn’t load blog</span><span></span></div>
            <p class="preview">${escapeHtml(err?.message || "Unknown error")}</p>
          </div>
        `;
      }
    }

    async function renderFree(){
      await setViewHtml(`
        <p class="kicker">Free writing</p>
        <h2 class="title">Take your time.</h2>
        <p class="subtitle">Write freely. No prompts. No pressure. Your work saves when you finish.</p>

        <textarea id="freeText" rows="14" placeholder="Start anywhere...">${escapeHtml(state.freeText || "")}</textarea>

        <div class="row" style="margin-top:14px;">
          <button class="btn primary" id="btnFinishFree">I’m done for now</button>
          <button class="btn ghost" id="btnBackHome">Back</button>
        </div>
      `);

      const ta = document.getElementById("freeText");
      ta.addEventListener("input", () => { state.freeText = ta.value; });

      document.getElementById("btnFinishFree").addEventListener("click", async () => {
        const text = (state.freeText || "").trim();
        if (text.length){
          addEntry({
            id: crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2),
            createdAt: nowIso(),
            type: "Free writing",
            mood: null,
            content: text,
          });
          toast("Saved.");
        } else {
          toast("Nothing to save — that’s okay.");
        }
        state.freeText = "";
        await go("completeFree");
      });

      document.getElementById("btnBackHome").addEventListener("click", () => go("home"));
    }

    async function renderCompleteFree(){
      await setViewHtml(`
        <h2 class="title">This is really thoughtful work.</h2>
        <p class="subtitle">What would you like to do next?</p>

        <div class="row">
          <button class="btn primary" id="btnGoMeditation">Unwinding meditation</button>
          <button class="btn" id="btnDone">I’m done for now</button>
        </div>
      `);

      document.getElementById("btnGoMeditation").addEventListener("click", () => go("medList"));
      document.getElementById("btnDone").addEventListener("click", () => go("done"));
    }

    /***********************
     * ✅ Meditations list + detail now from JSON
     ***********************/
    async function renderMeditationList(){
      const cards = MEDITATIONS_INDEX.map(m => `
        <div class="option" data-med="${escapeHtml(m.id)}">
          <h3>${escapeHtml(m.title)}</h3>
          <p>${escapeHtml(m.intro || "A calm meditation to read at your own pace.")}</p>
        </div>
      `).join("");

      await setViewHtml(`
        <p class="kicker">Unwinding meditation</p>
        <h2 class="title">Welcome.</h2>
        <p class="subtitle">
          You can choose a meditation that feels right for you right now.
          There’s no wrong choice — just follow what you need.
        </p>

        <div class="option-grid">
          ${cards}
        </div>

        <div class="divider"></div>
        <div class="row">
          <button class="btn ghost" id="back">Back</button>
        </div>
      `);

      viewEl.querySelectorAll(".option").forEach(el => {
        el.addEventListener("click", () => go("meditation", { meditationId: el.dataset.med }));
      });
      document.getElementById("back").addEventListener("click", () => go("home"));
    }

    async function renderMeditation(medId){
      try{
        const med = await loadMeditationById(medId);

        const audioBlock = med.audioSrc ? `
          <div class="audio-player">
            <div class="label">${escapeHtml(med.title)}</div>
            <button class="btn" id="toggleMedAudio">Play</button>
          </div>
        ` : "";

        await setViewHtml(`
          <p class="kicker">Meditation</p>
          <h2 class="title">${escapeHtml(med.title)}</h2>
          <p class="subtitle">${escapeHtml(med.intro || "Take your time reading. Move at your own pace.")}</p>

          <div class="fade" id="medfade">
            ${audioBlock}
            <div class="med-box">${escapeHtml(med.body || "")}</div>
          </div>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="finished">I’m finished</button>
            <button class="btn" id="choose">Choose another</button>
            <button class="btn ghost" id="quit">I’m done for now</button>
          </div>
        `);

        requestAnimationFrame(() => document.getElementById("medfade")?.classList.add("show"));

        if (med.audioSrc){
          const btn = document.getElementById("toggleMedAudio");
          btn.addEventListener("click", () => toggleMeditationAudio(med.audioSrc, btn));
          medPlayer.onended = () => { btn.textContent = "Play"; };
        } else {
          medPlayer.onended = null;
        }

        document.getElementById("finished").addEventListener("click", () => go("completeMeditation"));
        document.getElementById("choose").addEventListener("click", () => go("medList"));
        document.getElementById("quit").addEventListener("click", () => go("done"));
      }catch(err){
        await setViewHtml(`
          <p class="kicker">Meditation</p>
          <h2 class="title">Couldn’t load meditation</h2>
          <p class="subtitle">${escapeHtml(err?.message || "Unknown error")}</p>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="backList">Back to list</button>
            <button class="btn ghost" id="home">Home</button>
          </div>
        `);

        document.getElementById("backList").addEventListener("click", () => go("medList"));
        document.getElementById("home").addEventListener("click", () => go("home"));
      }
    }

    async function renderCompleteMeditation(){
      await setViewHtml(`
        <h2 class="title">Thanks for taking this time for yourself.</h2>
        <p class="subtitle">What would you like to do next?</p>

        <div class="row">
          <button class="btn primary" id="toFree">Free writing</button>
          <button class="btn ghost" id="done">I’m done for now</button>
        </div>
      `);

      document.getElementById("toFree").addEventListener("click", () => go("free"));
      document.getElementById("done").addEventListener("click", () => go("done"));
    }

    /***********************
     * ✅ Poetry Corner (from JSON)
     ***********************/
    async function renderPoetryHome(){
      await setViewHtml(`
        <p class="kicker">Poetry Corner</p>
        <h2 class="title">A small place to soften.</h2>
        <p class="subtitle">Choose a collection. Read slowly. Take what you need.</p>

        <div class="list" id="poetryCollections">
          <div class="entry">
            <div class="meta"><span>Loading…</span><span></span></div>
            <p class="preview">Fetching poems…</p>
          </div>
        </div>

        <div class="divider"></div>
        <div class="row">
          <button class="btn primary" id="backHome">Home</button>
        </div>
      `);

      document.getElementById("backHome").addEventListener("click", () => go("home"));

      const listEl = document.getElementById("poetryCollections");

      try{
        const { collections } = await loadPoetryIndex();

        if (!collections.length){
          listEl.innerHTML = `
            <div class="entry">
              <div class="meta"><span>No collections found</span><span></span></div>
              <p class="preview">Your poems JSON loaded, but it didn’t contain any collections.</p>
            </div>
          `;
          return;
        }

        listEl.innerHTML = "";
        collections.forEach(c => {
          const div = document.createElement("div");
          div.className = "entry";
          div.style.cursor = "pointer";
          div.innerHTML = `
            <div class="meta">
              <span>${escapeHtml(c.title)}</span>
              <span>${escapeHtml(String(c.poems?.length || 0))} poems</span>
            </div>
            <p class="preview">${escapeHtml((c.poems?.[0]?.title ? ("Includes: " + c.poems[0].title) : "A gentle collection."))}</p>
          `;
          div.addEventListener("click", () => go("poetryCollection", { collectionId: c.id }));
          listEl.appendChild(div);
        });
      }catch(err){
        listEl.innerHTML = `
          <div class="entry">
            <div class="meta"><span>Couldn’t load poems</span><span></span></div>
            <p class="preview">${escapeHtml(err?.message || "Unknown error")}</p>
          </div>
        `;
      }
    }

    async function renderPoetryCollection(collectionId){
      await setViewHtml(`
        <p class="kicker">Poetry Corner</p>
        <h2 class="title">Loading…</h2>
        <p class="subtitle">Just a moment.</p>

        <div class="divider"></div>
        <div class="row">
          <button class="btn primary" id="backPoetry">Back</button>
          <button class="btn ghost" id="home">Home</button>
        </div>
      `, { fade: true });

      try{
        const { collections } = await loadPoetryIndex();
        const col = collections.find(c => c.id === collectionId) || collections[0];

        const poemsHtml = (col.poems || []).map(p => `
          <div class="entry">
            <div class="meta">
              <span>${escapeHtml(p.title || "Untitled")}</span>
              <span></span>
            </div>
            <p class="preview">${escapeHtml(p.text || "")}</p>
          </div>
        `).join("");

        await setViewHtml(`
          <p class="kicker">Poetry Corner</p>
          <h2 class="title">${escapeHtml(col.title)}</h2>
          <p class="subtitle">Read slowly. Pause whenever you want.</p>

          <div class="list">
            ${poemsHtml || `
              <div class="entry">
                <div class="meta"><span>No poems</span><span></span></div>
                <p class="preview">This collection doesn’t contain any poems yet.</p>
              </div>
            `}
          </div>

          <div class="divider"></div>
          <div class="row">
            <button class="btn primary" id="backPoetry">Back to collections</button>
            <button class="btn ghost" id="home">Home</button>
          </div>
        `);

        document.getElementById("backPoetry").addEventListener("click", () => go("poetry"));
        document.getElementById("home").addEventListener("click", () => go("home"));
      }catch(err){
        await setViewHtml(`
          <p class="kicker">Poetry Corner</p>
          <h2 class="title">Couldn’t load collection</h2>
          <p class="subtitle">${escapeHtml(err?.message || "Unknown error")}</p>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="backPoetry">Back</button>
            <button class="btn ghost" id="home">Home</button>
          </div>
        `);

        document.getElementById("backPoetry").addEventListener("click", () => go("poetry"));
        document.getElementById("home").addEventListener("click", () => go("home"));
      }
    }

    async function renderDone(){
      const entries = loadEntries();
      const email = loadEmail();
      const defaultId = state.lastSavedEntryId || (entries[0]?.id || "");

      const options = entries.slice(0, 30).map(e => {
        const label = `${e.type} — ${prettyDate(e.createdAt)}${e.mood ? " • " + e.mood : ""}`;
        const selected = e.id === defaultId ? "selected" : "";
        return `<option value="${escapeHtml(e.id)}" ${selected}>${escapeHtml(label)}</option>`;
      }).join("");

      await setViewHtml(`
        <h2 class="title">You can rest now, if you want.</h2>
        <p class="subtitle">If you’d like, you can email yourself a saved entry.</p>

        <div class="fade" id="donefade">
          <p class="kicker">Your email address</p>
          <input type="email" id="email" placeholder="name@example.com" value="${escapeHtml(email)}" />

          <div style="height:12px;"></div>

          <p class="kicker">Choose an entry</p>
          <select id="entrySelect">
            ${options || `<option value="">No saved entries yet</option>`}
          </select>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="sendEmail">Compose email</button>
            <button class="btn" id="goHome">Home</button>
            <button class="btn ghost" id="goJournal">My Journal</button>
          </div>

          <p class="hint">This opens your email app with the entry filled in. You can review it, then press Send.</p>
        </div>
      `);

      requestAnimationFrame(() => document.getElementById("donefade")?.classList.add("show"));

      document.getElementById("goHome").addEventListener("click", () => go("home"));
      document.getElementById("goJournal").addEventListener("click", () => go("journal"));

      document.getElementById("sendEmail").addEventListener("click", () => {
        const emailEl = document.getElementById("email");
        const entryId = document.getElementById("entrySelect").value;

        const to = (emailEl.value || "").trim();
        if (!to){
          toast("Add an email address first.");
          emailEl.focus();
          return;
        }
        saveEmail(to);

        if (!entryId){
          toast("No entry selected.");
          return;
        }

        const e = getEntryById(entryId);
        if (!e){
          toast("Couldn’t find that entry.");
          return;
        }

        const subject = `Journal Boo — ${e.type} (${new Date(e.createdAt).toLocaleDateString()})`;
        const body =
`Hi,

Here’s a saved entry from Journal Boo.

${e.type}${e.mood ? " • " + e.mood : ""}
${prettyDate(e.createdAt)}

--------------------

${e.content}

--------------------

© James Ritchie 2025`;

        composeEmail(to, subject, body);
      });
    }

    async function renderJournal(){
      const entries = loadEntries();

      await setViewHtml(`
        <p class="kicker">My Journal</p>
        <h2 class="title">Your saved writing</h2>
        <p class="subtitle">Everything here is stored locally in this browser.</p>

        <div class="row">
          <button class="btn primary" id="newFree">New free writing</button>
          <button class="btn" id="toDone">I’m done for now</button>
          <button class="btn danger" id="clearAll">Clear all (local)</button>
        </div>

        <div class="divider"></div>
        <div class="list" id="entryList"></div>
      `);

      document.getElementById("newFree").addEventListener("click", () => go("free"));
      document.getElementById("toDone").addEventListener("click", () => go("done"));

      document.getElementById("clearAll").addEventListener("click", () => {
        const ok = confirm("Clear all saved entries from this browser?");
        if (!ok) return;
        saveEntries([]);
        toast("Cleared.");
        renderJournal();
      });

      const list = document.getElementById("entryList");
      if (!entries.length){
        list.innerHTML = `
          <div class="entry">
            <div class="meta"><span>Nothing saved yet</span><span></span></div>
            <p class="preview">When you finish a writing session, it will appear here.</p>
          </div>
        `;
        return;
      }

      entries.forEach(e => {
        const div = document.createElement("div");
        div.className = "entry";
        const mood = e.mood ? ` • ${e.mood}` : "";
        div.innerHTML = `
          <div class="meta">
            <span>${escapeHtml(e.type)}${mood}</span>
            <span>${prettyDate(e.createdAt)}</span>
          </div>
          <p class="preview">${escapeHtml(preview(e.content, 420))}</p>
          <div class="row" style="margin-top:10px;">
            <button class="btn" data-open="${escapeHtml(e.id)}">Open</button>
            <button class="btn danger" data-del="${escapeHtml(e.id)}">Delete</button>
          </div>
        `;
        list.appendChild(div);
      });

      list.querySelectorAll("button[data-open]").forEach(btn => {
        btn.addEventListener("click", () => openEntry(btn.getAttribute("data-open")));
      });
      list.querySelectorAll("button[data-del]").forEach(btn => {
        btn.addEventListener("click", () => deleteEntry(btn.getAttribute("data-del")));
      });

      function preview(txt, max){
        const s = (txt || "").trim();
        if (s.length <= max) return s;
        return s.slice(0, max).trim() + "…";
      }

      async function openEntry(id){
        const entries = loadEntries();
        const e = entries.find(x => x.id === id);
        if (!e) return;

        await setViewHtml(`
          <p class="kicker">My Journal</p>
          <h2 class="title">${escapeHtml(e.type)}</h2>
          <p class="subtitle">${prettyDate(e.createdAt)}${e.mood ? " • " + escapeHtml(e.mood) : ""}</p>

          <div class="med-box">${escapeHtml(e.content)}</div>

          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="backList">Back</button>
            <button class="btn" id="emailThis">Email this</button>
            <button class="btn danger" id="delThis">Delete</button>
            <button class="btn ghost" id="home">Home</button>
          </div>
        `);

        document.getElementById("backList").addEventListener("click", () => go("journal"));
        document.getElementById("home").addEventListener("click", () => go("home"));

        document.getElementById("delThis").addEventListener("click", () => deleteEntry(id));

        document.getElementById("emailThis").addEventListener("click", () => {
          state.lastSavedEntryId = e.id;
          go("done");
        });
      }

      function deleteEntry(id){
        const ok = confirm("Delete this entry?");
        if (!ok) return;
        const entries = loadEntries().filter(e => e.id !== id);
        saveEntries(entries);
        toast("Deleted.");
        go("journal");
      }
    }

    (function init(){
      loadSettings();

      // ✅ Theme: racing-green default, but saved preference still wins
      loadTheme();
      applyTheme();

      syncMusicUI();

      state.musicOn = false;
      bgm.pause();

      bgm.src = getTrack(state.trackId).src;
      bgm.volume = 0;

      viewEl.classList.remove("show");

      // ✅ Pre-render home (app is hidden until Start)
      go("home").then(() => {});

      // ✅ Run landing fades
      runWelcomeAnimation();
    })();
  </script>
</body>
</html>
